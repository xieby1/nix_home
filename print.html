<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Xieby1&#x27;s Nix/NixOS Config</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">🏠主页</li><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> 📔README.md</a></li><li class="chapter-item expanded affix "><li class="part-title">🌏全局配置</li><li class="chapter-item expanded "><a href="config.nix.html"><strong aria-hidden="true">2.</strong> config.nix</a></li><li class="chapter-item expanded "><a href="nix/nix.conf.html"><strong aria-hidden="true">3.</strong> TODO: nix/nix.conf</a></li><li class="chapter-item expanded "><a href="opt.nix.html"><strong aria-hidden="true">4.</strong> opt.nix</a></li><li class="chapter-item expanded affix "><li class="part-title">🖥️系统配置(需sudo,用于NixOS)</li><li class="chapter-item expanded "><a href="system.nix.html"><strong aria-hidden="true">5.</strong> system.nix</a></li><li class="chapter-item expanded "><a href="sys/index.html"><strong aria-hidden="true">6.</strong> sys/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="sys/cli.nix.html"><strong aria-hidden="true">6.1.</strong> cli.nix</a></li><li class="chapter-item expanded "><a href="sys/gui.nix.html"><strong aria-hidden="true">6.2.</strong> gui.nix.md</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.3.</strong> modules/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="sys/modules/cachix.nix.html"><strong aria-hidden="true">6.3.1.</strong> cachix.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="sys/wayland.html"><strong aria-hidden="true">6.4.</strong> Currently, Not Wayland, But X11</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">😺用户配置(无需sudo,用于Nix/NixOS)</li><li class="chapter-item expanded "><a href="home.nix.html"><strong aria-hidden="true">7.</strong> home.nix</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> usr/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/cli-extra.nix.html"><strong aria-hidden="true">8.1.</strong> cli-extra.nix: Extra CLI configs (added to minial cli.nix)</a></li><li class="chapter-item expanded "><a href="usr/cli.nix.html"><strong aria-hidden="true">8.2.</strong> cli.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/index.html"><strong aria-hidden="true">8.3.</strong> cli/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/cli/clash.nix.html"><strong aria-hidden="true">8.3.1.</strong> clash.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/clashctl.nix.html"><strong aria-hidden="true">8.3.2.</strong> clashctl.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/kaleido.nix.html"><strong aria-hidden="true">8.3.3.</strong> kaleido.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/ld.html"><strong aria-hidden="true">8.3.4.</strong> binutils's ld and gcc's ld collsion</a></li><li class="chapter-item expanded "><a href="usr/cli/node.html"><strong aria-hidden="true">8.3.5.</strong> Nodejs packages (npm) in NixOS</a></li><li class="chapter-item expanded "><a href="usr/cli/pandora-chatgpt.html"><strong aria-hidden="true">8.3.6.</strong> 打包python（pip）包，以pandora-chatgpt为例</a></li><li class="chapter-item expanded "><a href="usr/cli/pandora-chatgpt.nix.html"><strong aria-hidden="true">8.3.7.</strong> pandora-chatgpt.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/python.html"><strong aria-hidden="true">8.3.8.</strong> Python in Nix/NixOS</a></li><li class="chapter-item expanded "><a href="usr/cli/searxng.nix.html"><strong aria-hidden="true">8.3.9.</strong> searxng.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/static_qemu.html"><strong aria-hidden="true">8.3.10.</strong> 静态链接，以qemu为例</a></li><li class="chapter-item expanded "><a href="usr/cli/tailscale.html"><strong aria-hidden="true">8.3.11.</strong> Tailscale/Headscale</a></li><li class="chapter-item expanded "><a href="usr/cli/tailscale.nix.html"><strong aria-hidden="true">8.3.12.</strong> tailscale.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/tmux.nix.html"><strong aria-hidden="true">8.3.13.</strong> tmux</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/index.html"><strong aria-hidden="true">8.3.14.</strong> 📑neovim</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/cli/vim/DrawIt.nix.html"><strong aria-hidden="true">8.3.14.1.</strong> DrawIt: ascii art drawing</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/codecompanion-nvim.nix.html"><strong aria-hidden="true">8.3.14.2.</strong> codecompanion-nvim.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/color-scheme.nix.html"><strong aria-hidden="true">8.3.14.3.</strong> 🎨My nvim color scheme</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/conform-nvim.nix.html"><strong aria-hidden="true">8.3.14.4.</strong> conform-nvim: formatter</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/default.nix.html"><strong aria-hidden="true">8.3.14.5.</strong> default.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/git-wip.nix.html"><strong aria-hidden="true">8.3.14.6.</strong> git-wip: auto wip branch</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/gitsigns-nvim.nix.html"><strong aria-hidden="true">8.3.14.7.</strong> gitsigns-nvim: git support</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/hbac-nvim.nix.html"><strong aria-hidden="true">8.3.14.8.</strong> hbac-nvim: auto close buffer</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/leap-nvim.nix.html"><strong aria-hidden="true">8.3.14.9.</strong> leap-nvim.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/mini-nvim.nix.html"><strong aria-hidden="true">8.3.14.10.</strong> mini-nvim: a nvim distro</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-cmp.nix.html"><strong aria-hidden="true">8.3.14.11.</strong> nvim-cmp: completion</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-config-local.nix.html"><strong aria-hidden="true">8.3.14.12.</strong> nvim-config-local: load local vim config</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-lspconfig.nix.html"><strong aria-hidden="true">8.3.14.13.</strong> nvim-lspconfig</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.14.14.</strong> nvim-metals/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-metals/default.nix.html"><strong aria-hidden="true">8.3.14.14.1.</strong> nvim-metals: Scala LSP</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-metals/jre_with_proxy.nix.html"><strong aria-hidden="true">8.3.14.14.2.</strong> JRE with Proxy</a></li></ol></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-treesitter.nix.html"><strong aria-hidden="true">8.3.14.15.</strong> nvim-treesitter: languages parsing</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/smartyank-nvim.nix.html"><strong aria-hidden="true">8.3.14.16.</strong> smartyank-nvim: smart yank to clipboard</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/telescope-nvim.nix.html"><strong aria-hidden="true">8.3.14.17.</strong> telescope-nvim</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/vim-easy-align.nix.html"><strong aria-hidden="true">8.3.14.18.</strong> vim-easy-align: A simple, easy-to-use Vim alignment plugin.</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/vim-floaterm.nix.html"><strong aria-hidden="true">8.3.14.19.</strong> vim-floaterm: floating terminal</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/vim-hexokinase.nix.html"><strong aria-hidden="true">8.3.14.20.</strong> vim-hexokinase: display colors</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/vim-mark.nix.html"><strong aria-hidden="true">8.3.14.21.</strong> vim-mark: multi-color highlight</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/vim-markdown.nix.html"><strong aria-hidden="true">8.3.14.22.</strong> vim-markdown: md support</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/vista-vim.nix.html"><strong aria-hidden="true">8.3.14.23.</strong> vista-vim: lsp symbols</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/winshift-nvim.nix.html"><strong aria-hidden="true">8.3.14.24.</strong> winshift-nvim: rearrange windows</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="usr/gui.nix.html"><strong aria-hidden="true">8.4.</strong> gui.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/index.html"><strong aria-hidden="true">8.5.</strong> gui/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/feishu.html"><strong aria-hidden="true">8.5.1.</strong> 安装deb包，以飞书为例</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox.nix.html"><strong aria-hidden="true">8.5.2.</strong> firefox.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome.html"><strong aria-hidden="true">8.5.3.</strong> Gnome in NixOS</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome.nix.html"><strong aria-hidden="true">8.5.4.</strong> gnome.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/kdeconnect.nix.html"><strong aria-hidden="true">8.5.5.</strong> KDE Connect</a></li><li class="chapter-item expanded "><a href="usr/gui/mime.nix.html"><strong aria-hidden="true">8.5.6.</strong> https://nixos.org/manual/nixos/stable/#sec-writing-modules</a></li><li class="chapter-item expanded "><a href="usr/gui/rofi.nix.html"><strong aria-hidden="true">8.5.7.</strong> rofi.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/rustdesk.nix.html"><strong aria-hidden="true">8.5.8.</strong> rustdesk, the remote desktop app</a></li><li class="chapter-item expanded "><a href="usr/gui/singleton_web_apps.nix.html"><strong aria-hidden="true">8.5.9.</strong> singleton_web_apps.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/terminal.nix.html"><strong aria-hidden="true">8.5.10.</strong> terminal.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/typora.html"><strong aria-hidden="true">8.5.11.</strong> Typora</a></li><li class="chapter-item expanded "><a href="usr/gui/waydroid.html"><strong aria-hidden="true">8.5.12.</strong> Wayland</a></li><li class="chapter-item expanded "><a href="usr/gui/weixin.nix.html"><strong aria-hidden="true">8.5.13.</strong> weixin.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/wrapWine.nix.html"><strong aria-hidden="true">8.5.14.</strong> based on https://github.com/lucasew/nixcfg/blob/49d44c1a655f1c20d7354ecea942c78704067d50/pkgs/wrapWine.nix</a></li><li class="chapter-item expanded "><a href="usr/gui/xdot.nix.html"><strong aria-hidden="true">8.5.15.</strong> xdot, the dot (graphviz) viewer</a></li><li class="chapter-item expanded "><a href="usr/gui/xelfviewer.nix.html"><strong aria-hidden="true">8.5.16.</strong> xelfviewer.nix.md</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.6.</strong> modules/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/modules/cachix.nix.html"><strong aria-hidden="true">8.6.1.</strong> cachix.nix.md</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">🤖安卓配置(无需sudo,复用"用户配置")</li><li class="chapter-item expanded "><a href="nix-on-droid.nix.html"><strong aria-hidden="true">9.</strong> nix-on-droid.nix</a></li><li class="chapter-item expanded affix "><li class="part-title">🔩通用模块</li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.</strong> modules/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="modules/cachix.nix.html"><strong aria-hidden="true">10.1.</strong> cachix.nix.md</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">📝文档和心得体会</li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.</strong> docs/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/explanation/index.html"><strong aria-hidden="true">11.1.</strong> explanation/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/explanation/modules.html"><strong aria-hidden="true">11.1.1.</strong> Module</a></li><li class="chapter-item expanded "><a href="docs/explanation/nixpkgs.html"><strong aria-hidden="true">11.1.2.</strong> Nixpkgs</a></li></ol></li><li class="chapter-item expanded "><a href="docs/howto/index.html"><strong aria-hidden="true">11.2.</strong> howto/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/howto/32bit.html"><strong aria-hidden="true">11.2.1.</strong> 打包/编译32位程序</a></li><li class="chapter-item expanded "><a href="docs/howto/auto_push_to_cachix/index.html"><strong aria-hidden="true">11.2.2.</strong> Auto Push Packages to Cachix</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/howto/auto_push_to_cachix/cachix-package.nix.html"><strong aria-hidden="true">11.2.2.1.</strong> cachixPackage</a></li><li class="chapter-item expanded "><a href="docs/howto/auto_push_to_cachix/test.nix.html"><strong aria-hidden="true">11.2.2.2.</strong> Test for cachixPackage</a></li></ol></li><li class="chapter-item expanded "><a href="docs/howto/backup_binary_cache.html"><strong aria-hidden="true">11.2.3.</strong> 备份binary cache</a></li><li class="chapter-item expanded "><a href="docs/howto/cross.html"><strong aria-hidden="true">11.2.4.</strong> 交叉编译和安装跨平台程序</a></li><li class="chapter-item expanded "><a href="docs/howto/install_nixos.html"><strong aria-hidden="true">11.2.5.</strong> 安装NixOS</a></li></ol></li><li class="chapter-item expanded "><a href="docs/slides/index.html"><strong aria-hidden="true">11.3.</strong> slides/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/slides/2023.nix-env.html"><strong aria-hidden="true">11.3.1.</strong> Nix让你的团队成员不再受环境问题困扰</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">📃Nix脚本（nix-shell和打包）</li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.</strong> scripts/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="scripts/fhs-shell/index.html"><strong aria-hidden="true">12.1.</strong> fhs-shell/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="scripts/fhs-shell/dynamorio.nix.html"><strong aria-hidden="true">12.1.1.</strong> dynamorio.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/fhs-shell/hello.nix.html"><strong aria-hidden="true">12.1.2.</strong> hello.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/fhs-shell/pin.nix.html"><strong aria-hidden="true">12.1.3.</strong> pin.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/fhs-shell/spec.nix.html"><strong aria-hidden="true">12.1.4.</strong> spec.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/fhs-shell/x11.nix.html"><strong aria-hidden="true">12.1.5.</strong> x11.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/fhs-shell/xilinx.nix.html"><strong aria-hidden="true">12.1.6.</strong> xilinx.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="scripts/pkgs/index.html"><strong aria-hidden="true">12.2.</strong> pkgs/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="scripts/pkgs/7z.nix.html"><strong aria-hidden="true">12.2.1.</strong> TODO: 7z need dynamical link 7z.so</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/android.html"><strong aria-hidden="true">12.2.2.</strong> 在NixOS上使用Android程序</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/android.nix.html"><strong aria-hidden="true">12.2.3.</strong> android.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/appimage_runtime.nix.html"><strong aria-hidden="true">12.2.4.</strong> appimage_runtime.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/coremarks.nix.html"><strong aria-hidden="true">12.2.5.</strong> coremarks.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/cross_mips.nix.html"><strong aria-hidden="true">12.2.6.</strong> cross_mips.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/cross_static_hello.nix.html"><strong aria-hidden="true">12.2.7.</strong> cross_static_hello.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/fhs_helloworld.nix.html"><strong aria-hidden="true">12.2.8.</strong> fhs_helloworld.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/fhs_spec2000_perl.nix.html"><strong aria-hidden="true">12.2.9.</strong> fhs_spec2000_perl.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/nix-binary-tarballs-new.nix.html"><strong aria-hidden="true">12.2.10.</strong> nix-binary-tarballs-new.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/nix-binary-tarballs.nix.html"><strong aria-hidden="true">12.2.11.</strong> nix-binary-tarballs.nix.md</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.2.12.</strong> nix-docker-isa/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="scripts/pkgs/nix-docker-isa/default.nix.html"><strong aria-hidden="true">12.2.12.1.</strong> 🐳Nix Docker🐋 for Multiple ISAs</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/nix-docker-isa/dockers.nix.html"><strong aria-hidden="true">12.2.12.2.</strong> dockers.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="scripts/pkgs/nvchad.nix.html"><strong aria-hidden="true">12.2.13.</strong> nvchad.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/qemu-sys-static.nix.html"><strong aria-hidden="true">12.2.14.</strong> qemu-sys-static.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/qemu-sys_riscv64_static.nix.html"><strong aria-hidden="true">12.2.15.</strong> qemu-sys_riscv64_static.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/qemu_riscv64_static.nix.html"><strong aria-hidden="true">12.2.16.</strong> qemu_riscv64_static.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/qemu_static.nix.html"><strong aria-hidden="true">12.2.17.</strong> qemu_static.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/qemu_tests_tcg.nix.html"><strong aria-hidden="true">12.2.18.</strong> qemu_tests_tcg.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/qemus.nix.html"><strong aria-hidden="true">12.2.19.</strong> build by version</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/shellinabox.nix.html"><strong aria-hidden="true">12.2.20.</strong> https://github.com/NixOS/nixpkgs/issues/185773</a></li></ol></li><li class="chapter-item expanded "><a href="scripts/shell/index.html"><strong aria-hidden="true">12.3.</strong> shell/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="scripts/shell/ccache.nix.html"><strong aria-hidden="true">12.3.1.</strong> ccache.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/chipyard.nix.html"><strong aria-hidden="true">12.3.2.</strong> chipyard.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/cross_mips.nix.html"><strong aria-hidden="true">12.3.3.</strong> cross_mips.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/cross_platform.nix.html"><strong aria-hidden="true">12.3.4.</strong> cross_platform.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/devshell_hello.nix.html"><strong aria-hidden="true">12.3.5.</strong> devshell_hello.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/gcc.nix.html"><strong aria-hidden="true">12.3.6.</strong> gcc.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/hello.nix.html"><strong aria-hidden="true">12.3.7.</strong> hello.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/pygame.nix.html"><strong aria-hidden="true">12.3.8.</strong> pygame.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/python_fhs_venv.nix.html"><strong aria-hidden="true">12.3.9.</strong> https://nixos.wiki/wiki/Python</a></li><li class="chapter-item expanded "><a href="scripts/shell/python_mach.nix.html"><strong aria-hidden="true">12.3.10.</strong> python_mach.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/python_venv.nix.html"><strong aria-hidden="true">12.3.11.</strong> python_venv.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/qemu_plugins.nix.html"><strong aria-hidden="true">12.3.12.</strong> qemu_plugins.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/qemu_tests_tcg.nix.html"><strong aria-hidden="true">12.3.13.</strong> qemu_tests_tcg.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/riscv-tests.nix.html"><strong aria-hidden="true">12.3.14.</strong> riscv-tests.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/spike.nix.html"><strong aria-hidden="true">12.3.15.</strong> spike.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/texlive.nix.html"><strong aria-hidden="true">12.3.16.</strong> texlive.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/ucasproposal.nix.html"><strong aria-hidden="true">12.3.17.</strong> ucasproposal.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/v8.nix.html"><strong aria-hidden="true">12.3.18.</strong> v8.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/venv.nix.html"><strong aria-hidden="true">12.3.19.</strong> venv.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/wine6.nix.html"><strong aria-hidden="true">12.3.20.</strong> wine6.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/xiangshan.nix.html"><strong aria-hidden="true">12.3.21.</strong> xiangshan.nix.md</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">📌其他</li><li class="chapter-item expanded "><a href="shell.nix.html"><strong aria-hidden="true">13.</strong> shell.nix</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Xieby1&#x27;s Nix/NixOS Config</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/xieby1/nix_config" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p>🏗️ <em>我的Nix/NixOS配置详细文档正在施工中，完成进度：<span style="font-size:2em;"><strong>44/108</strong></span></em> 🏗️</p>
<p>为了更好的文档阅读体验，请看<a href="https://xieby1.github.io/nix_config/">GitHub Pages</a>的版本。</p>
<h2 id="目录"><a class="header" href="#目录">目录</a></h2>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="index.html#nixnixos%E7%AE%80%E4%BB%8B">Nix/NixOS简介</a></li>
<li><a href="index.html#xieby1%E5%92%8Cnixnixos">xieby1和Nix/NixOS</a></li>
<li><a href="index.html#xieby1%E7%9A%84nixnixos%E9%85%8D%E7%BD%AE">xieby1的Nix/NixOS配置</a>
<ul>
<li><a href="index.html#%E6%96%87%E4%BB%B6%E5%A4%B9%E7%BB%93%E6%9E%84">文件夹结构</a></li>
<li><a href="index.html#nix%E8%84%9A%E6%9C%AC%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95">nix脚本的使用方法</a>
<ul>
<li><a href="index.html#nix-shell%E7%9A%84%E4%BE%8B%E5%AD%90">nix-shell的例子</a></li>
</ul>
</li>
<li><a href="index.html#nix%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95">nix配置的使用方法</a></li>
<li><a href="index.html#%E5%BC%95%E7%94%A8">引用</a></li>
</ul>
</li>
</ul>
<!-- vim-markdown-toc -->
<h1 id="nixnixos简介"><a class="header" href="#nixnixos简介">Nix/NixOS简介</a></h1>
<p>Nix是一个可重现的（Reproducible）包管理器，也是一门纯函数式的（Pure Functional）编程语言。
理论上讲，Nix包管理器可以安装在任何Linux发行版上(比如Ubuntu、Debian和Arch等)，并与这些发行版原有的包管理器（比如snap、apt和pacman等）共存。
而NixOS则是完全由Nix包管理器进行管理的Linux发行版。</p>
<p>Nix/NixOS采用了“包（Package）”的理念，将Linux内核、驱动、函数库、用户程序、配置文件等方方面面抽象出来。
这类似于Linux内核将设备、磁盘文件、管道等都抽象为文件的理念。
这样的抽象使得Nix/NixOS能以一种统一的方式管理所有的包。</p>
<p>为了防止“包”被用户有意或无意地修改（即保证可重现性），Nix/NixOS将所有的包都放在一个只读文件系统中（挂载在<code>/nix/store</code>目录上）。
这个目录中的包仅能通过Nix包管理器和Nix语言编程进行增删改。
为了将<code>/nix/store</code>中的文件放置在它们应该在的地方（比如某个用户使用的包里存在<code>bin/</code>目录，则应当把bin/中所有的文件放入<code>/run/current-system/sw/bin/</code>），Nix/NixOS大量使用符号链接。</p>
<p>上述Nix/NixOS的特点和传统Linux发行版有着极大的区别。
这使得Nix/NixOS的学习曲线十分陡峭。
不过当你适应Nix/NixOS的这些特点后，它可以极大提升工程效率!</p>
<h1 id="xieby1和nixnixos"><a class="header" href="#xieby1和nixnixos">xieby1和Nix/NixOS</a></h1>
<p>多年来，Nix/NixOS已成为我学习和工作的重要基础，主要用于以下方面：</p>
<ul>
<li>学习Linux。
Nix/NixOS采用了“包（Package）”的理念，将Linux内核、驱动、函数库、用户程序、配置文件等方方面面抽象出来。
通过学习Nix语言，我能够以统一的方式了解Linux系统的各个方面，这是其他工具所无法提供的。</li>
<li>管理环境。
通过使用nix-shell管理所有依赖（包括库、环境变量、配置等），可以避免项目环境重现的问题。
类似的工具还有虚拟机和Docker。
相比使用虚拟机，它更轻量。
相比Docker，它支持可复现构建，采用Nix语言更灵活。
详细可见我于2023年为实验室同学们准备的<a href="https://xieby1.github.io/nix_config/docs/slides/2023.nix-env.html">推荐Nix/NixOS的幻灯片</a>。</li>
<li>备份电脑。
Nix/NixOS能够管理系统、软件及其配置。
虽然Nix/NixOS不直接管理数据，但Nix/NixOS可以很好地管理数据同步软件，比如Syncthing。
因此只要保留着Nix/NixOS的配置文件（由Nix语言编写），就能恢复出一个几乎一模一样<sup class="footnote-reference"><a href="#impure">1</a></sup>的软件环境/操作系统。</li>
</ul>
<h1 id="xieby1的nixnixos配置"><a class="header" href="#xieby1的nixnixos配置">xieby1的Nix/NixOS配置</a></h1>
<p>这个仓库<a href="https://github.com/xieby1/nix_config">Github: xieby1/nix_config</a>里存放着我的Nix/NixOS配置和文档。
该仓库使用nix expression，而非nix flakes；
使用NixOS稳定源（目前版本24.11），而非非稳定源（unstable）。
该仓库的配置在多个平台都可以正常使用：</p>
<ul>
<li>NixOS: QEMU✅，NixOS单系统✅，NixOS+Windows双系统✅</li>
<li>Nix: Linux✅，安卓（nix-on-droid）✅，WSL2✅</li>
</ul>
<p>你可以使用该仓库的配置，配置出完整NixOS操作系统。
也可以使用其中的部分包、模块，扩充自己的Nix/NixOS。
若你不仅只是想安装Nix/NixOS，还想了解更多Nix/NixOS的知识，
欢迎看看这个仓库的文档<a href="https://xieby1.github.io/nix_config">xieby1.github.io/nix_config</a>。</p>
<h2 id="文件夹结构"><a class="header" href="#文件夹结构">文件夹结构</a></h2>
<ul>
<li>docs/: 文档</li>
<li>scripts/: nix脚本
<ul>
<li>fhs-shell/: 采用FHS的nix-shell脚本</li>
<li>shell/: nix-shell脚本</li>
<li>pkgs/: 独立的软件包脚本</li>
</ul>
</li>
<li>system.nix: 系统总体配置（nixos-rebuild的配置）
<ul>
<li>sys/cli.nix: 系统命令行配置</li>
<li>sys/gui.nix: 系统图形配置</li>
<li>modules/: 系统模块</li>
</ul>
</li>
<li>home.nix: 用户总体配置（home-manager的配置）
<ul>
<li>usr/cli.nix: 用户命令行配置</li>
<li>usr/gui.nix: 用户图形配置</li>
<li>modules/: 用户模块</li>
</ul>
</li>
<li>nix-on-droid.nix: 安卓总体配置（nix-on-droid的配置）</li>
<li>modules/: nixos/home-manager通用的模块</li>
</ul>
<h2 id="nix脚本的使用方法"><a class="header" href="#nix脚本的使用方法">nix脚本的使用方法</a></h2>
<p>安装Nix不在此赘述，参考<a href="https://nixos.org/download.html">nixos.org/download.html</a>。</p>
<p>安装完Nix后，下载所需的nix脚本，然后：</p>
<ul>
<li><code>fhs-shell/</code>和<code>shell/</code>脚本用<code>nix-shell</code>命令进入shell环境；</li>
<li><code>pkgs/</code>脚本用<code>nix-build</code>命令生成软件包。</li>
</ul>
<h3 id="nix-shell的例子"><a class="header" href="#nix-shell的例子">nix-shell的例子</a></h3>
<pre><code class="language-bash"># 以xiangshan.nix配置香山开发环境为例
# 进入香山的根目录
cd Xiangshan
# 下载xiangshan.nix脚本，并重命名为shell.nix
wget https://raw.githubusercontent.com/xieby1/nix_config/main/scripts/shell/xiangshan.nix -O shell.nix
# 进入nix shell
nix-shell
</code></pre>
<h2 id="nix配置的使用方法"><a class="header" href="#nix配置的使用方法">nix配置的使用方法</a></h2>
<p>虚拟机/物理机单系统/物理机双系统 安装NixOS 可以参考我两年前的<a href="./docs/howto/install_nixos.html">NixOS安装</a>过程。
安装Nix/NixOS不在此赘述，参考<a href="https://nixos.org/download.html">nixos.org/download.html</a>。</p>
<p>安装完Nix/NixOS后，首先下载我的配置</p>
<pre><code class="language-bash">git clone https://github.com/xieby1/nix_config.git ~/.config/nixpkgs
# [仅NixOS] 在imports中添加system.nix的路径
vim /etc/nixos/configuration.nix
</code></pre>
<p>然后设置软件源，在NixOS中推荐使用<code>sudo</code>。</p>
<ul>
<li>注一：更多其他nix channels参考
<a href="https://nixos.wiki/wiki/Nix_channels">NixOS Wiki: Nix channels</a>
和<a href="https://status.nixos.org/">Nix channel status</a>。</li>
<li>注二：为什么用https://nixos.org/channels/nixos-24.11，
而非https://github.com/NixOS/nixpkgs/archive/release-24.11.tar.gz？
前者包含额外内容，比如programs.command-not-found.dbPath，详细见<code>man configuration.nix</code>。</li>
</ul>
<pre><code class="language-bash"># [对于NixOS]
nix-channel --add https://nixos.org/channels/nixos-24.11 nixos
# [对于Nix]
nix-channel --add https://nixos.org/channels/nixos-24.11 nixpkgs
# 添加home manager源
nix-channel --add https://github.com/nix-community/home-manager/archive/release-24.11.tar.gz home-manager
nix-channel --update
</code></pre>
<p>最后部署配置</p>
<pre><code class="language-bash"># [仅NixOS]
sudo nixos-rebuild switch
# 安装home-manager
nix-shell '&lt;home-manager&gt;' -A install
home-manager switch
</code></pre>
<h2 id="引用"><a class="header" href="#引用">引用</a></h2>
<div class="footnote-definition" id="impure"><sup class="footnote-definition-label">1</sup>
<p>nix 2.8的impure特性和home-manager等会引入一些你几乎察觉不到的差异。</p>
</div>
<div class="footnote-definition" id="doc_thesis"><sup class="footnote-definition-label">2</sup>
<p>Dolstra, Eelco. “The purely functional software deployment model.” (2006).</p>
</div>
<div class="footnote-definition" id="nix-on-droid"><sup class="footnote-definition-label">3</sup>
<p><a href="https://github.com/t184256/nix-on-droid">github.com/t184256/nix-on-droid</a> termux的分支，支持nix。</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="confignix"><a class="header" href="#confignix">config.nix</a></h1>
<p>当初始化<code>nixpkgs</code>时，例如<code>pkgs = import &lt;nixpkgs&gt; {}</code>，
<code>nixpkgs</code>的初始化代码会读取<code>~/.config/nixpkgs/config.nix</code>作为<code>nixpkgs.config</code>参数。
如果你对<code>nixpkgs</code>的初始化感兴趣，可以去看看这部分的源代码<code>&lt;nixpkgs&gt;/pkgs/top-level/impure.nix</code>。</p>
<p><code>config.nix</code>文件（即<code>nixpkgs.config</code>）接受的参数可以参考nixpkgs的官方文档的
<a href="https://nixos.org/manual/nixpkgs/stable/#sec-config-options-reference">config Options Reference</a>章节，
或是去看nixpkgs这部分的源码<code>&lt;nixpkgs&gt;/pkgs/top-level/config.nix</code>。</p>
<p>下面是添加了注解的我的<code>config.nix</code>：</p>
<pre><code class="language-nix">{
</code></pre>
<p>禁用安装非本地的包，比如禁止x86_64-linux的包被安装到aarch64-linux上。</p>
<pre><code class="language-nix">  allowUnsupportedSystem = false;
  allowUnfree = true;
  packageOverrides = pkgs: rec {
</code></pre>
<p>添加nix user repository (NUR)到nixpkgs里。</p>
<pre><code class="language-nix">    nur = import (builtins.fetchTarball "https://github.com/nix-community/NUR/archive/master.tar.gz") {
      pkgs = pkgsu;
    };
</code></pre>
<p>添加非稳定版的nixpkgs到nixpkgs里，
比如非稳定版的hello可以通过<code>pkgs.pkgsu.hello</code>来访问。</p>
<pre><code class="language-nix">    pkgsu = import (builtins.fetchTarball "https://github.com/NixOS/nixpkgs/archive/master.tar.gz") {};
</code></pre>
<p>添加flake-compat，用于在nix expression中使用flake的包</p>
<pre><code class="language-nix">    flake-compat = import (builtins.fetchTarball {
      url = "https://github.com/edolstra/flake-compat/archive/0f9255e01c2351cc7d116c072cb317785dd33b33.tar.gz";
      sha256 = "0m9grvfsbwmvgwaxvdzv6cmyvjnlww004gfxjvcl806ndqaxzy4j";
    });
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="todo-nixnixconf"><a class="header" href="#todo-nixnixconf">TODO: nix/nix.conf</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="optnix"><a class="header" href="#optnix">opt.nix</a></h1>
<p>nix语言中只有<code>let ... in</code>来定义局部变量，没有提供全局变量的语法支持。
但在我的nix配置中又很需要一些“全局变量”来方便统一的管理多个配置文件。
有2种可行的方案来实现全局变量：module和import。</p>
<h2 id="module"><a class="header" href="#module">module</a></h2>
<p>nixpkgs的module能够还不错地实现“全局变量”。
想了解module？可以去看看<a href="https://nixos.wiki/wiki/NixOS_modules">NixOS wikiL modules</a>。
或者看看nixpkgs源码关于modules.nix的部分<code>&lt;nixpkgs&gt;/lib/modules.nix</code>。</p>
<p>要注意的是，基于module的“全局变量”也会有<span style="color:red;"><strong>局限</strong></span>的。
module是用过imports变量导入的，若在imports语句访问“全局变量”，nix的lazy evaluation的特性会导致死循环。
这也是为什么老版本的<a href="./home.nix.html">home.nix</a>中判断是否需要导入<a href="./usr/gui.nix.html">./usr/gui.nix</a>，
我没有使用<code>config.isGui</code>而是再次使用getEnv访问环境变量。
当然这个不足也是我放弃使用的module主要原因。</p>
<h2 id="import"><a class="header" href="#import">import</a></h2>
<p>通过在配置文件中import opt.nix也能还不错的实现“全局变量”。
import方法的最大优势是能够在module imports语句中避免死循环。</p>
<p>这个方法的不足之处在于每个需要使用全局变量的文件都需要import opt.nix。
但这个不方便之处，相对imports死循环，没那么让人难受。</p>
<pre><code class="language-nix">{
  isMinimalConfig = false;
</code></pre>
<p><code>proxyPort</code>：代理端口号，诸多网络程序需要用，比如clash和tailscale。</p>
<pre><code class="language-nix">  proxyPort = 8889;
</code></pre>
<p><code>isCli</code>和<code>isGui</code>：通过环境变量<code>DISPLAY</code>来判断是否是CLI或GUI环境。
这个方法有<span style="color:red;"><strong>局限</strong></span>，比如ssh连接到一台有GUI的电脑上，ssh里是没有设置环境变量<code>DISPLAY</code>的。
因此更好的方法是在opt-local.nix中写入固定的isCli和isGui值。</p>
<pre><code class="language-nix">  isCli = (builtins.getEnv "DISPLAY")=="";
  isGui = (builtins.getEnv "DISPLAY")!="";
</code></pre>
<p><code>isNixOnDroid</code>：通过用户名来判断是否是nix-on-droid。</p>
<pre><code class="language-nix">  isNixOnDroid = (builtins.getEnv "USER")=="nix-on-droid";
</code></pre>
<p><code>isWSL2</code>：通过环境变量<code>WSL_DISTRO_NAME</code>来判断是否是WSL2。</p>
<pre><code class="language-nix">  isWSL2 = (builtins.getEnv "WSL_DISTRO_NAME")!="";
}
</code></pre>
<h3 id="本地配置"><a class="header" href="#本地配置">本地配置</a></h3>
<p>引入opt-local.nix，方便本地进行自定义，避免我的nix配置中出现过多设备特定代码（即一堆if else判断语句）。
为了减少设备特定代码，每个设备都有自己的opt-local.nix。
目前的想法是不将opt-local.nix加入git仓库，以实现“设备特定”。
相比opt.nix，opt-local.nix的配置具备更高的优先级。</p>
<pre><code class="language-nix">// (
  if (builtins.pathExists ./opt-local.nix)
  then import ./opt-local.nix
  else {}
)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="systemnix"><a class="header" href="#systemnix">system.nix</a></h1>
<p>本文件<code>system.nix</code>存放喆我的NixOS的配置。
NixOS的配置通过命令<code>sudo nixos-rebuid switch</code>生效。
因为NixOS的配置入口是<code>/etc/nixos/configuration.nix</code>，
所以需要在<code>/etc/nixos/configuration.nix</code>中import本文件，例如</p>
<pre><code class="language-nix"># /etc/nixos/configuration.nix:
{ config, pkgs, ... }: {
  imports = [
    ./hardware-configuration.nix
    # import my system.nix here!
    /home/xieby1/.config/nixpkgs/system.nix
  ];
  # other configs ...
}
</code></pre>
<p>NixOS配置可以使用的参数可参考configuration.nix的manpage，即<code>man configuration.nix</code>。
下面是我的NixOS的配置源码及注解：</p>
<pre><code class="language-nix"># add this file to /etc/nixos/configuration.nix: imports
{ config, pkgs, ... }:

{
</code></pre>
<p>让NixOS的nixpkgs使用和home-manager的nixpkgs采用相同的nixpkgs config</p>
<pre><code class="language-nix">  nixpkgs.config = import ./config.nix;

</code></pre>
<p>导入我的NixOS的CLI和GUI配置，
详细内容见文档<a href="./sys/cli.nix.html">./sys/cli.nix</a>和<a href="./sys/gui.nix.html">./sys/gui.nix</a>。</p>
<pre><code class="language-nix">  imports = [
    ./sys/modules/cachix.nix
    ./sys/cli.nix
    ./sys/gui.nix
  ];

</code></pre>
<p>Nix binary cache的地址。
越靠前优先级越高。
由于cache.nixos.org需要梯子，
这里使用了清华Tuna提供的Nix binary cache镜像来加速。</p>
<pre><code class="language-nix">  nix.settings.substituters = [
    "https://cache.nixos.org/"
    "https://xieby1.cachix.org"
  ];

</code></pre>
<p>设置时区。</p>
<pre><code class="language-nix">  time.timeZone = "Asia/Shanghai";
  time.hardwareClockInLocalTime = true;

</code></pre>
<p>设置Linux账户信息。</p>
<pre><code class="language-nix">  users.mutableUsers = false;
</code></pre>
<p>当然GitHub上当然不能明文存储密码，这里使用hash过的密码。
可以使用命令行工具<code>mkpasswd</code>来生成hash过的密码。
给<code>root</code>用户设置hash过的密码。</p>
<pre><code class="language-nix">  users.users.root.hashedPassword = "$6$wRBpbr4zSTA/nh$XI/KUASw3mELIqyAxN1hUTWizz9ZBzPhP2u4HNDCA49h4KOWkZsyuiextyXkUti7jYsUHE9fTiRjGAoxBg0Gq/";
  users.users.xieby1 = {
    isNormalUser = true;
    createHome = true;
</code></pre>
<p>同上，给<code>xieby1</code>用户设置hash过的密码。</p>
<pre><code class="language-nix">    hashedPassword = "$6$Y4KJxhdaJTT$RSolbCpaUKK2UW1cdnuH.8n1Ky9p0Lnx0MP36BxGX9Q2AeVMjCp.bZOsZ11w689je/785TFRQoVgicMiOfA9B.";
</code></pre>
<p>给用户<code>xieby1</code>启用sudo。</p>
<pre><code class="language-nix">    extraGroups = [ "wheel" ];
</code></pre>
<p>ssh授权的公钥。这样设置后，我的所有的NixOS都相当于“自动授权”了。
我的<code>/home/xieby1/Gist/</code>文件夹存放着一些不方便放入Git仓库的文件，比如二进制文件，或是隐私文件。
该文件由<a href="https://github.com/syncthing/syncthing">syncthing</a>进行多设备同步。
简单的说，我的备份理念是“git备份配置，syncthing备份数据”。
“配置”即指这个<a href="https://github.com/xieby1/nix_config">nix_config仓库</a>，“数据”指<code>~/Gist/</code>、<code>~/Documents/</code>等文件夹。
有了这些备份就能轻松还原/复现我的整个工作环境。
TODO：单独专门介绍我的备份理念。</p>
<pre><code class="language-nix">    openssh.authorizedKeys.keyFiles = [] ++ (
      if builtins.pathExists /home/xieby1/Gist/Vault/y50_70.pub
      then [/home/xieby1/Gist/Vault/y50_70.pub]
      else []
    ) ++ (
      if builtins.pathExists /home/xieby1/Gist/Vault/yoga14s.pub
      then [/home/xieby1/Gist/Vault/yoga14s.pub]
      else []
    );
  };

</code></pre>
<p>让TTY自动登录我的账户，这样就可以自动启动用户级（user）的systemd服务了。
这样就可以在<span style="color:teal"><strong>非NixOS</strong></span>中（比如Ubuntu服务器、WSL2、Debian树莓派等）
自动拉起systemd<span style="color:teal"><strong>用户</strong></span>服务（比如syncthing、clash、tailscale等）。</p>
<pre><code class="language-nix">  services.getty.autologinUser = "xieby1";
</code></pre>
<p>有关systemd用户服务的配置，详细可见参考：</p>
<ul>
<li>home-manager配置的manpage的services词条，
比如<code>man home-configuration.nix</code>搜索<code>services.syncthing</code></li>
<li>我的syncthing配置<a href="./usr/cli.nix.html#syncthing">./usr/cli.nix: syncthing</a></li>
<li>我的clash配置<a href="./usr/cli/clash.nix.html">./usr/cli/clash.nix</a></li>
<li>我的tailscale配置<a href="./usr/cli/tailscale.nix.html">./usr/cli/tailscale.nix</a></li>
</ul>
<pre><code class="language-nix">}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="clinix"><a class="header" href="#clinix">cli.nix</a></h1>
<p>本文件是NixOS的CLI配置。
主要包含两部分内容：</p>
<ul>
<li>系统环境管理（root的环境）</li>
<li>系统配置</li>
</ul>
<pre><code class="language-nix">{ config, pkgs, ... }:

{
</code></pre>
<h2 id="系统环境管理root的环境"><a class="header" href="#系统环境管理root的环境">系统环境管理（root的环境）</a></h2>
<pre><code class="language-nix">  # List packages installed in system profile. To search, run:
  # $ nix search wget
  environment.systemPackages = with pkgs; [
    git
    file
    wget
    fzf
    linuxPackages.perf
  ];

  # neovim
  programs.neovim.enable = true;
  programs.neovim.defaultEditor = true;
  programs.neovim.viAlias = true;
  programs.neovim.vimAlias = true;

  # ssh
  services.openssh.enable = true;

</code></pre>
<h2 id="系统配置"><a class="header" href="#系统配置">系统配置</a></h2>
<p>给jumper电脑自动挂在SD卡。</p>
<pre><code class="language-nix">  # refers to https://www.golinuxcloud.com/automount-file-system-systemd-rhel-centos-7-8/
  systemd.mounts = if "${config.networking.hostName}" == "jumper"
  then [{
    enable = true;
    # [Unit]
    description = "My SD Card";
    unitConfig = {
      DefaultDependencies = "no";
      Conflicts = "umount.target";
    };
    before = ["local-fs.target" "umount.target"];
    after = ["swap.target"];
    # [Mount]
    what = "/dev/disk/by-label/home";
    where = "/home";
    type = "ext4";
    options = "defaults";
    # [Install]
    wantedBy = ["multi-user.target"];
  }] else [];

  systemd.automounts = if "${config.networking.hostName}" == "jumper"
  then [{
    enable = true;
    # [Unit]
    description = "automount sdcard";
    # [Automount]
    where = "/home";
    # [Install]
    wantedBy = ["multi-user.target"];
  }] else [];

</code></pre>
<p>启用NTFS文件系统的支持。
如此就可以在NixOS/Windows双系统的电脑上挂在Windows的分区啦。</p>
<pre><code class="language-nix">  boot.supportedFilesystems = [ "ntfs" ];

</code></pre>
<p>启用podman。
podman是一个十分好用的docker实现。
支持用户态容器（不需要sudo），可以方便地挂在容器镜像的文件系统。</p>
<pre><code class="language-nix">  virtualisation.podman.enable = true;

</code></pre>
<p>配置binfmt，让非本地指令集的用户程序可以正常运行。
比如在x86_64-linux上运行aarch64-linux的用户程序。
注意：不能在配和本地一样的binfmt，比如不能在x86_64-linux的机器上配置x86_64-linux的binfmt。
不然会出现奇怪的嵌套？你执行任何一条命令（x86_64-linux）都需要去调用qemu-x86_64，
但qemu-x86_64本事也是x86_64-linux的，所以会死循环？
我做了个实验：在x86_64-linux的NixOS中启用x86_64-linux的binfmt。
任何程序都执行不了了，连关机都不行，只能强制重启。
不过好在NixOS可以回滚，轻松复原实验前的环境。
下面的<code>filterAttrs</code>就是用来保证不配置本地的binfmt。</p>
<pre><code class="language-nix">  boot.binfmt.registrations = pkgs.lib.filterAttrs (n: v: n!=builtins.currentSystem) {
    x86_64-linux = {
      interpreter = "${pkgs.pkgsStatic.qemu-user}/bin/qemu-x86_64";
      magicOrExtension = ''\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x3e\x00'';
      mask = ''\xff\xff\xff\xff\xff\xfe\xfe\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff'';
      wrapInterpreterInShell = false;
    };
    aarch64-linux = {
      interpreter = "${pkgs.pkgsStatic.qemu-user}/bin/qemu-aarch64";
      magicOrExtension = ''\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\xb7\x00'';
      mask = ''\xff\xff\xff\xff\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\x00\xff\xfe\xff\xff\xff'';
      wrapInterpreterInShell = false;
    };
    riscv64-linux = {
      interpreter = "${pkgs.pkgsStatic.qemu-user}/bin/qemu-riscv64";
      magicOrExtension = ''\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\xf3\x00'';
      mask = ''\xff\xff\xff\xff\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff'';
      wrapInterpreterInShell = false;
    };
  };

</code></pre>
<p>启用docdev。
在home-manager中装devdoc似乎有问题，得在NixOS中装才行。
之后有空再来详细研究。</p>
<pre><code class="language-nix">  # Make sure devdoc outputs are installed.
  documentation.dev.enable = true;
  # Make sure legacy path is installed as well.
  environment.pathsToLink = [ "/share/gtk-doc" ];

</code></pre>
<p>启用ADB，安卓搞事情必备。</p>
<pre><code class="language-nix">  programs.adb.enable = true;
  users.users.xieby1.extraGroups = ["adbusers"];

  nix.settings.trusted-users = ["root" "xieby1"];

  zramSwap.enable = true;

  documentation.man.generateCaches = true;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, ... }:

{
  imports = [ # files

  ] ++ [{ # functions &amp; attrs
    # support fractional scaling for x11 gnome:
    # refer to https://nixos.wiki/wiki/Overlays#Overriding_a_package_inside_a_scope
    nixpkgs.overlays = [ (final: prev: {
      mutter = let
        mutter-x11-scaling = pkgs.fetchFromGitHub {
          owner = "puxplaying";
          repo = "mutter-x11-scaling";
          rev = "3a3a20ba7ae0af2c312373ebea9a33d912356217";
          hash = "sha256-aB4pc3qu9/1aYt2Mlj2lWcmW9Qva8BzLx4k4O7lgURk=";
        };
      in prev.mutter.overrideAttrs (old: {
        patches = (pkgs.lib.optionals (old ? patches) old.patches) ++ [
          "${mutter-x11-scaling}/x11-Add-support-for-fractional-scaling-using-Randr.patch"
        ];
      });
      gnome-control-center = let
        gnome-control-center-x11-scaling = pkgs.fetchFromGitHub {
          owner = "puxplaying";
          repo = "gnome-control-center-x11-scaling";
          rev = "12ce1fb886e46b96ae9dc278df19536d2093ca6d";
          hash = "sha256-6DkUzarvI/vZOSda0qmO65gwSvW2NC1gdx45gA21kB8=";
        };
      in prev.gnome-control-center.overrideAttrs (old: {
        patches = (pkgs.lib.optionals (old ? patches) old.patches) ++ [
          "${gnome-control-center-x11-scaling}/display-Support-UI-scaled-logical-monitor-mode.patch"
          "${gnome-control-center-x11-scaling}/display-Allow-fractional-scaling-to-be-enabled.patch"
        ];
      });
    }) ];

    # push the overrided mutter and gnome to my cachix
    cachix_packages = with pkgs; [mutter gnome-control-center];
  }] ;

  # Enable the X11 windowing system.
  services.xserver.enable = true;
  services.xserver.videoDrivers = [
    # "nvidia"
    # default video drivers
    "radeon" "nouveau" "modesetting" "fbdev"
    "modesetting" "amdgpu"
  ];

  # Enable the GNOME Desktop Environment.
  services.xserver.displayManager.gdm.enable = true;
  services.xserver.displayManager.gdm.wayland = false;
  services.xserver.desktopManager.gnome.enable = true;

  # https://discourse.nixos.org/t/how-to-create-folder-in-var-lib-with-nix/15647
  system.activationScripts.user_account_conf = pkgs.lib.stringAfter [ "var" ] (let
    face = pkgs.fetchurl {
      url = "https://github.com/xieby1.png";
      sha256 = "1s20qy3205ljp29lk0wqs6aw5z67db3c0lvnp0p7v1q2bz97s9bm";
    };
  in ''
    mkdir -p /var/lib/AccountsService/users
    if [[ ! -f /var/lib/AccountsService/users/xieby1 ]]; then
    cat &gt; /var/lib/AccountsService/users/xieby1 &lt;&lt;XIEBY1_ACCOUNT
    [User]
    Session=
    Icon=/var/lib/AccountsService/icons/xieby1
    SystemAccount=false
    XIEBY1_ACCOUNT
    fi
    mkdir -p /var/lib/AccountsService/icons
    ln -sf ${face} /var/lib/AccountsService/icons/xieby1
  '');

  # Configure keymap in X11
  # services.xserver.layout = "us";
  # services.xserver.xkbOptions = "eurosign:e";

  # Enable CUPS to print documents.
  # https://nixos.wiki/wiki/Printing
  services.printing.enable = true;
  services.printing.drivers = [pkgs.hplip];
  services.avahi.enable = true;
  services.avahi.nssmdns4 = true;

  # Enable touchpad support (enabled default in most desktopManager).
  services.libinput.enable = true;

  # https://github.com/kovidgoyal/kitty/issues/403
  environment.variables.GLFW_IM_MODULE = "ibus";
  i18n.inputMethod.enable = true;
  i18n.inputMethod.type = "ibus";
  i18n.inputMethod.ibus.engines = with pkgs.ibus-engines; [
    rime
    # keyboard layout is wrong in anthy, e.g. punctuations
    # anthy
    # hinagara toggle setting is absent in mozc
    mozc
    hangul
  ];

  nixpkgs.config.allowUnfree = true;

  # vim vista need nerd fonts
  # https://github.com/liuchengxu/vista.vim/issues/74
  # https://github.com/liuchengxu/space-vim/wiki/tips#programming-fonts
  # available nerd fonts: nixpkgs/pkgs/data/fonts/nerdfonts/shas.nix
  ## use non-variable noto font for feishu and other old electron apps
  ## for more details see: https://github.com/NixOS/nixpkgs/issues/171976
  fonts.packages = with pkgs; [
    noto-fonts-cjk-sans
    noto-fonts-cjk-serif
    noto-fonts-emoji
    noto-fonts-color-emoji
    noto-fonts-extra
    (nerdfonts.override {
      # The best developer fonts, see https://www.nerdfonts.com/
      fonts = [
        "Hack"
        "Meslo"
        "SourceCodePro"
        "FiraCode"
        "Terminus"
        "Iosevka"
        "Monoid"
        "FantasqueSansMono"
      ];
    })
    # refs to pkgs/data/fonts/roboto-mono/default.nix
    # (stdenv.mkDerivation {
    #   name = "my_fonts";
    #   srcs = [(fetchurl {
    #     url = "https://github.com/lxgw/LxgwWenKai/releases/download/v1.311/LXGWWenKai-Bold.ttf";
    #     sha256 = "16111vvjii2hmnigjb44rjj39k8hjawbvwrb3f2f1ph4hv5wnvkn";
    #   }) (fetchurl {
    #     url = "https://github.com/lxgw/LxgwWenKai/releases/download/v1.311/LXGWWenKai-Regular.ttf";
    #     sha256 = "103mvbpg51jvda265f29sjq17jj76dgwz6f1qdmv6d99bb8b6x7w";
    #   })];
    #   sourceRoot = "./";
    #   unpackCmd = ''
    #     ttfName=$(basename $(stripHash $curSrc))
    #     cp $curSrc ./$ttfName
    #   '';
    #   installPhase = ''
    #     mkdir -p $out/share/fonts/truetype
    #     cp -a *.ttf $out/share/fonts/truetype/
    #   '';
    # })
  ];
  # enable fontDir /run/current-system/sw/share/X11/fonts
  fonts.fontDir.enable = true;
  fonts.fontconfig.defaultFonts = {
    monospace = [
      "DejaVu Sans Mono"
      "Noto Color Emoji"
      "Noto Emoji"
    ];
  };

  services.gpm.enable = true;

  hardware.xone.enable = true;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, lib, ...}:

{
  imports = [../../modules/cachix.nix];
  config = lib.mkIf (
    (builtins.pathExists config.cachix_dhall) &amp;&amp;
    (config.cachix_packages != [])
  ) {
    system.activationScripts = {
      cachix_push = config._cachix_push;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="currently-not-wayland-but-x11"><a class="header" href="#currently-not-wayland-but-x11">Currently, Not Wayland, But X11</a></h1>
<p>Here list wayland problems I have met.</p>
<h2 id="fcitx-input-method-not-work"><a class="header" href="#fcitx-input-method-not-work">fcitx input method not work</a></h2>
<h2 id="waydroid"><a class="header" href="#waydroid">waydroid</a></h2>
<p>waydroid tile not work</p>
<h2 id="tabbed-not-work"><a class="header" href="#tabbed-not-work">tabbed not work</a></h2>
<h2 id="gnome-terminal-headerbar-cannot-be-hidden"><a class="header" href="#gnome-terminal-headerbar-cannot-be-hidden">gnome terminal headerbar cannot be hidden</a></h2>
<p>Both gnome extension unite and gtk-title-bar
cannot hide gnome terminal(kitty and alacritty)'s headerbar.</p>
<ul>
<li>https://github.com/velitasali/gtktitlebar/issues/25</li>
<li>https://github.com/velitasali/gtktitlebar/issues/14</li>
</ul>
<h2 id="autokey-and-espanso-not-work-in-wayland"><a class="header" href="#autokey-and-espanso-not-work-in-wayland">autokey and espanso not work in wayland</a></h2>
<p>Autokey only works in X11,
while espanso officially disclaim it support wayland.
But my wayland experience is, espanso does not work either.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="homenix"><a class="header" href="#homenix">home.nix</a></h1>
<p><code>home.nix</code>是home-manager的入口配置文件，它导入了3个nix文件：</p>
<ul>
<li><a href="./opt.nix.html"><code>./opt.nix</code></a>：我定义的全局变量</li>
<li><a href="./usr/cli.nix.html"><code>./usr/cli.nix</code></a>：我的所有CLI程序的配置</li>
<li><a href="./usr/gui.nix.html"><code>./usr/gui.nix</code></a>：我的所有GUI程序的配置</li>
</ul>
<p>因为部分系统不需要GUI程序，比如安卓手机nix-on-droid或是树莓派等。
我利用环境变量<code>DISPLAY</code>用于判断是否导入GUI程序的配置。</p>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  opt = import ./opt.nix;
in {
  imports = [
    ./usr/modules/cachix.nix
    ./usr/cli.nix
  ] ++ lib.optionals opt.isGui [
    ./usr/gui.nix
  ];

  home.stateVersion = "19.09";
  programs.home-manager.enable = true;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cli-extranix-extra-cli-configs-added-to-minial-clinix"><a class="header" href="#cli-extranix-extra-cli-configs-added-to-minial-clinix">cli-extra.nix: Extra CLI configs (added to minial cli.nix)</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  opt = import ../opt.nix;
in {
  imports = [{
    home.packages = let
      pandora = pkgs.python3Packages.callPackage ./cli/pandora-chatgpt.nix {};
      chatgpt = pkgs.writeShellScriptBin "chatgpt" ''
        ${pandora}/bin/pandora -t ~/Gist/Pandora-ChatGPT/access_token.dat $@
      '';
    in [pandora chatgpt];
  }{
    home.packages = [
      pkgs.act
      (pkgs.writeShellScriptBin "act-podman" ''
        export DOCKER_HOST=unix://$XDG_RUNTIME_DIR/podman/podman.sock
        CMD=(
          "${pkgs.act}/bin/act"
          "--bind"

          # use podman
          "--container-daemon-socket" "unix://$XDG_RUNTIME_DIR/podman/podman.sock"

          # use host proxy
          "--container-options" "--network=host"
          "--env" "HTTPS_PROXY='http://127.0.0.1:${toString opt.proxyPort}'"
          "--env" "HTTP_PROXY='http://127.0.0.1:${toString opt.proxyPort}'"
          "--env" "FTP_PROXY='http://127.0.0.1:${toString opt.proxyPort}'"
          "--env" "https_proxy='http://127.0.0.1:${toString opt.proxyPort}'"
          "--env" "http_proxy='http://127.0.0.1:${toString opt.proxyPort}'"
          "--env" "ftp_proxy='http://127.0.0.1:${toString opt.proxyPort}'"

          "$@"
        )
        eval "''${CMD[@]}"
      '')
    ];
  }];

  home.packages = with pkgs; [
    # tools
    imagemagick

    # programming
    ## c
    cling # c/cpp repl
    ## javascript
    nodePackages.typescript
    ### node
    nodejs
    ## java
    openjdk

    ### pdfcrop
    (texlive.combine {inherit (pkgs.texlive) scheme-minimal pdfcrop;})
    # runXonY
    qemu
  ] ++ lib.optional (builtins.currentSystem == "x86_64-linux") quickemu;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  opt = import ../opt.nix;
  git-wip = builtins.derivation {
    name = "git-wip";
    system = builtins.currentSystem;
    src = pkgs.fetchurl {
      url = "https://raw.githubusercontent.com/bartman/git-wip/1c095e93539261370ae811ebf47b8d3fe9166869/git-wip";
      sha256 = "00gq5bwwhjy68ig26a62307pww2i81y3zcx9yqr8fa36fsqaw37h";
    };
    builder = pkgs.writeShellScript "git-wip-builder" ''
      source ${pkgs.stdenv}/setup
      mkdir -p $out/bin
      dst=$out/bin/git-wip
      cp $src $dst
      chmod +w $dst
      sed -i 's/#!\/bin\/bash/#!\/usr\/bin\/env bash/g' $dst
      chmod -w $dst
      chmod a+x $dst
    '';
  };
  fzf-doc = pkgs.writeScriptBin "fzf-doc" ''
    allCmds() {
      # bash alias
      compgen -A alias

      # external commands
      # https://unix.stackexchange.com/questions/94775/list-all-commands-that-a-shell-knows
      case "$PATH" in
        (*[!:]:) PATH="$PATH:" ;;
      esac
      set -f
      IFS_OLD="$IFS"
      IFS=:
      for dir in $PATH; do
        set +f
        [ -z "$dir" ] &amp;&amp; dir="."
        for file in "$dir"/*; do
          if [ -x "$file" ] &amp;&amp; ! [ -d "$file" ]; then
            echo "''${file##*/}"
          fi
        done
      done
      IFS="$IFS_OLD"
    }

    cd ~/Documents
    FILE=$(fzf)
    [ -z "$FILE" ] &amp;&amp; exit

    CMD=$(allCmds | fzf)
    [ -z "$CMD" ] &amp;&amp; exit

    case "$CMD" in
    # run gui cmd background
    o)
      # use nohup to run bash command in background and exit
      ## https://superuser.com/questions/448445/run-bash-script-in-background-and-exit-terminal
      # nohup not recognize bash alias like `o`, it's necessary to call bash
      eval nohup bash -ic '"$CMD \"$FILE\" &amp;"'
    ;;

    # run cli cmd foreground
    *)
      # FILE name may contain space, quote FILE name
      eval "$CMD" \"$FILE\"
    ;;
    esac
  '';
  sysconfig = (
    # &lt;...&gt; are expression search in NIX_PATH
    if (builtins.tryEval &lt;nixos-config&gt;).success
    then import &lt;nixpkgs/nixos&gt; {}
    else import &lt;nixpkgs/nixos&gt; {configuration={};}
  ).config;
in
{
  imports = lib.optionals (!opt.isMinimalConfig) [
    ./cli-extra.nix
  ] ++ [ # files
    ./cli/vim
    ./cli/tmux.nix
    ./cli/clash.nix
    ./cli/tailscale.nix
    # When init searxng, it throws `ERROR:searx.engines.wikidata: Fail to initialize`
    # I have no idea, so disable it.
    # ./cli/searxng.nix
  ] ++ [{ # functions &amp; attrs
    home.packages = [
      pkgs.fzf
      fzf-doc
    ];
    programs.bash.bashrcExtra = ''
      # FZF top-down display
      export FZF_DEFAULT_OPTS="--reverse"
    '';
  }{
    home.packages = lib.optional (!opt.isNixOnDroid) pkgs.hstr;
    programs.bash.bashrcExtra = lib.optionalString (!opt.isNixOnDroid) ''
      # HSTR configuration - add this to ~/.bashrc
      alias hh=hstr                    # hh to be alias for hstr
      export HSTR_CONFIG=hicolor       # get more colors
      shopt -s histappend              # append new history items to .bash_history
      export HISTCONTROL=ignorespace   # leading space hides commands from history
      # ensure synchronization between bash memory and history file
      export PROMPT_COMMAND="history -a;"
      # if this is interactive shell, then bind hstr to Ctrl-r (for Vi mode check doc)
      if [[ $- =~ .*i.* ]]; then bind '"\C-r": "\C-a hstr -- \C-j"'; fi
      # if this is interactive shell, then bind 'kill last command' to Ctrl-x k
      if [[ $- =~ .*i.* ]]; then bind '"\C-xk": "\C-a hstr -k \C-j"'; fi
    '';
  }{
    programs.ssh.enable = true;
    programs.ssh.includes = lib.optional (builtins.pathExists ~/Gist/Config/ssh.conf) "~/Gist/Config/ssh.conf";
    programs.bash.bashrcExtra = lib.optionalString opt.isNixOnDroid ''
      # start sshd
      if [[ -z "$(pidof sshd-start)" ]]; then
          tmux new -d -s sshd-start sshd-start
      fi
    '';
  }{
    home.packages = with pkgs; [
      gitui
      mr
      git-wip
      git-quick-stats
    ];
    programs.git = {
      enable = true;
      package = pkgs.gitFull;
      userEmail = "xieby1@outlook.com";
      userName = "xieby1";
      extraConfig = {
        core = {
          editor = "vim";
        };
        credential.helper = "store";
      };
      aliases = {
        viz = "log --all --decorate --oneline --graph";
      };
      lfs.enable = true;
    };
    home.file.mr = {
      text = if builtins.pathExists ~/Gist/Config/mrconfig
        then builtins.readFile ~/Gist/Config/mrconfig
        else "";
      target = ".mrconfig";
    };
    # mr status not work in non-home dir
    programs.bash.shellAliases.mr = "mr -d ~";
  }{
    home.packages = [pkgs.nix-index];
    home.file.nix_index_database = {
      source = builtins.fetchurl "https://github.com/Mic92/nix-index-database/releases/latest/download/index-${builtins.currentSystem}";
      target = ".cache/nix-index/files";
    };
  }{
</code></pre>
<h2 id="syncthing"><a class="header" href="#syncthing">Syncthing</a></h2>
<pre><code class="language-nix">    services.syncthing = {
      enable = true;
</code></pre>
<p>让syncthing的端口外部可访问。</p>
<pre><code class="language-nix">      extraOptions = lib.optional opt.isCli "--gui-address=0.0.0.0:8384";
    };
</code></pre>
<p>启用代理，因为有些syncthing的服务器似乎是被墙了的。</p>
<pre><code class="language-nix">    systemd.user.services.syncthing.Service.Environment = [
      # https://docs.syncthing.net/users/proxying.html
      "http_proxy=http://127.0.0.1:${toString opt.proxyPort}"
    ];
</code></pre>
<p>使用命令行浏览器browsh来实现syncthing-tui。</p>
<pre><code class="language-nix">    home.packages = lib.optional (!opt.isMinimalConfig) (
      pkgs.writeShellScriptBin "syncthing-tui" ''
        ${pkgs.browsh}/bin/browsh --firefox.path ${pkgs.firefox}/bin/firefox http://127.0.0.1:8384
      ''
    );
  }{
    home.packages = with pkgs; [
      cachix
    ];
    home.file.cachix_dhall = {
      source = if (builtins.pathExists ~/Gist/Config/cachix.dhall)
        then ~/Gist/Config/cachix.dhall
        else builtins.toFile "empty-cachix.dhall" "";
      target = ".config/cachix/cachix.dhall";
    };
  }{
    home.packages = with pkgs; [
      universal-ctags
    ];
    home.file.exclude_ctags = {
      text = ''
        # exclude ccls generated directories
        --exclude=.ccls*
      '';
      target = ".config/ctags/exclude.ctags";
    };
  }];

  home.packages = with pkgs; [
    # tools
    parallel
    comma
    xclip
    python3Packages.qrcode
    ripgrep
    ## archive
    unar
    ## manage
    htop
    nix-tree
    ## text
    pandoc
    ## compile
    gnumake
    makefile2graph
    remake
    ## draw
    graphviz
    figlet
    nyancat
    ## manual
    tldr
    ## file system
    file
    # magika # detect file content types with deep learning
    tree
    ## network
    wget
    axel
    bind.dnsutils # nslookup
    netcat
    nload
    nmap
    nethogs
    ## x11
    xdotool

    # programming
    inotify-tools
    clang-tools
    cmake
    capstone
    scc
    ## https://stackoverflow.com/questions/40165650/how-to-list-all-files-tracked-by-git-excluding-submodules
    (writeShellScriptBin "scc-git" "${scc}/bin/scc $(git grep --cached -l '')")
    sloccount
    flamegraph
    ## python
    ( python3.withPackages ( p: with p; [
      ipython
      pydot
    ]))
    ## c
    (lib.setPrio # make bintools less prior
      (bintools-unwrapped.meta.priority + 1)
      bintools-unwrapped
    )
    (if builtins.currentSystem == "x86_64-linux"
      then gcc_multi
      else gcc
    )
    gdb
    ### docs
    stdmanpages
    man-pages
    #gccStdenv
    bear
    ## xml
    libxml2
    ## bash
    bc
    ## nix
    nixos-option
    nix-output-monitor
    ### allow non-nixos access `man configuration.nix`
    # see: nixos/modules/misc/documentation.nix
    #        nixos/doc/manual/default.nix
    sysconfig.system.build.manual.nixos-configuration-reference-manpage
    nurl
  ];

  programs.eza.enable = true;

  # bash
  programs.bash.enable = true;
  programs.bash.shellAliases.o = "xdg-open";
  programs.bash.bashrcExtra = ''
    # rewrite prompt format
    u_green="\[\033[01;32m\]"
    u_blue="\[\033[01;34m\]"
    u_white="\[\033[00m\]"
    PS1="''${debian_chroot:+($debian_chroot)}"
    if [[ $HOSTNAME =~ qemu.* ]]; then
        PS1+="(qemu)"
    fi
    if [[ -n "$IN_NIX_SHELL" ]]; then
        PS1+="(''${name}.$IN_NIX_SHELL)"
    fi
    PS1+="''${u_green}\u${lib.optionalString (!opt.isNixOnDroid) "@\\h"}''${u_white}:"
    PS1+="''${u_blue}\w''${u_white}"
    PS1+="\n''${u_green}\$''${u_white} "
    unset u_green u_blue u_white
    ## change title
    ### https://unix.stackexchange.com/questions/177572/
    PS1+="\[\e]2;\w\a\]"

    # nixos obsidian
    export NIXPKGS_ALLOW_INSECURE=1

    # source my bashrc
    if [[ -f ~/Gist/Config/bashrc ]]; then
        source ~/Gist/Config/bashrc
    fi

    # user nix config setting
    export NIX_USER_CONF_FILES=~/.config/nixpkgs/nix/nix.conf
    if [[ -e ~/.nix-profile/etc/profile.d/nix.sh ]]; then
        source ~/.nix-profile/etc/profile.d/nix.sh
    fi

    # bash-completion, inspired by
    ##  https://discourse.nixos.org/t/whats-the-nix-way-of-bash-completion-for-packages/20209/16
    # system tools completion, e.g. nix
    XDG_DATA_DIRS+=":${sysconfig.system.path}/share"
    # home tools completion
    XDG_DATA_DIRS+=":${config.home.path}/share"
    export XDG_DATA_DIRS
    . ${pkgs.bash-completion}/etc/profile.d/bash_completion.sh

    # 解决tmux在nix-on-droid上不显示emoji和中文的问题
    export LANG=C.UTF-8

    if [[ -n $(command -v eza) ]]; then
        alias ls=eza
    fi
  '' + lib.optionalString opt.isWSL2 ''
    # use the working directory of the current tab as the starting directory for a new tab
    # https://learn.microsoft.com/en-us/windows/terminal/tutorials/new-tab-same-directory#using-actions-to-duplicate-the-path
    PROMPT_COMMAND=''${PROMPT_COMMAND:+"$PROMPT_COMMAND"}'printf "\e]9;9;%s\e\\" "$(wslpath -w "$PWD")"'
  '';
  ## after direnv's bash.initExtra
  programs.bash.initExtra = lib.mkOrder 2000 ''
    # https://stackoverflow.com/questions/1862510/how-can-the-last-commands-wall-time-be-put-in-the-bash-prompt
    function timer_start {
      _timer=''${_timer:-$SECONDS}
    }
    function timer_stop {
      last_timer=$(($SECONDS - $_timer))

      _notification_threthold=10
      if [[ $last_timer -ge $_notification_threthold ]]; then
        _notification="[''${last_timer}s⏰] Job finished!"
        if [[ "$TERM" =~ tmux ]]; then
          # https://github.com/tmux/tmux/issues/846
          printf '\033Ptmux;\033\x1b]99;;%s\033\x1b\\\033\\' "$_notification"
        else
          printf '\x1b]99;;%s\x1b\\' "$_notification"
        fi
      fi
    }
    function timer_unset {
      unset _timer
    }

    trap timer_start DEBUG

    PROMPT_COMMAND="timer_stop;$PROMPT_COMMAND"
    if [[ -n "$(echo $PROMPT_COMMAND | grep -o -e ';$')" ]]; then
      PROMPT_COMMAND+="timer_unset;"
    else
      PROMPT_COMMAND+=";timer_unset;"
    fi
  '';

  home.file.gdbinit = {
    source = pkgs.fetchurl {
      url = "https://raw.githubusercontent.com/cyrus-and/gdb-dashboard/2b107b27949d13f6ef041de6eec1ad2e5f7b4cbf/.gdbinit";
      sha256 = "02rxyk8hmk7xk1pyhnc5z6a2kqyd63703rymy9rfmypn6057i4sr";
      name = "gdbinit";
    };
    target = ".gdbinit";
  };
  home.file.gdb_dashboard_init = {
    text = ''
      # gdb-dashboard init file

      # available layout modules
      #   stack registers history assembly
      #   breakpoints expressions memory
      #   source threads variables
      dashboard -layout source

      # https://en.wikipedia.org/wiki/ANSI_escape_code
      #dashboard -style prompt
      ## fg bold blue
      dashboard -style prompt_not_running "\\[\\e[1;34m\\]$\\[\\e[0m\\]"
      ## fg bold green
      dashboard -style prompt_running "\\[\\e[1;32m\\]$\\[\\e[0m\\]"
    '';
    target = ".gdbinit.d/init";
  };

  programs.direnv.enable = true;
  programs.direnv.nix-direnv.enable = true;

  programs.man.generateCaches = true;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  opt = import ../../opt.nix;
  clashctl = pkgs.callPackage ./clashctl.nix {};
in {
  imports = [{
    home.packages = [
      pkgs.clash-meta
    ] ++ lib.optional (!opt.isNixOnDroid) clashctl;
    cachix_packages = lib.optional (!opt.isNixOnDroid) clashctl;

    systemd.user.services.clash = {
      Unit = {
        Description = "Auto start clash";
        After = ["network.target"];
      };
      Install = {
        WantedBy = ["default.target"];
      };
      Service = {
        ExecStart = "${pkgs.clash-meta.outPath}/bin/clash-meta -d ${config.home.homeDirectory}/Gist/clash";
      };
    };
    programs.bash.bashrcExtra = lib.mkBefore (lib.optionalString (!opt.isNixOnDroid) ''
      # proxy
      ## default
      HTTP_PROXY="http://127.0.0.1:${toString opt.proxyPort}/"
      ## microsoft wsl
      # if [[ $(uname -r) == *"microsoft"* ]]; then
      #     hostip=$(cat /etc/resolv.conf | grep nameserver | awk '{ print $2 }')
      #     export HTTP_PROXY="http://$hostip:${toString opt.proxyPort}"
      # fi
      export HTTPS_PROXY="$HTTP_PROXY"
      export HTTP_PROXY="$HTTP_PROXY"
      export FTP_PROXY="$HTTP_PROXY"
      export http_proxy="$HTTP_PROXY"
      export https_proxy="$HTTP_PROXY"
      export ftp_proxy="$HTTP_PROXY"
    '');
  }];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ lib
, rustPlatform
, fetchFromGitHub
}:
rustPlatform.buildRustPackage {
  name = "clashctl";

  src = fetchFromGitHub {
    # owner = "https://github.com/George-Miao/clashctl";
    owner = "George-Miao";
    repo = "clashctl";
    rev = "b09e1faf80f1a25fa855499d8b34d36491e5a081";
    hash = "sha256-c7y64SsZEKdC8+umCY8+XBwxAHxn4YpqR48ASbHpkdM=";
  };

  cargoHash = "sha256-2d+phmMJeHZsJy300GwUAnh8KTGzpHCCIg8x4Wr8ytE=";

  doCheck = false;

  meta = with lib; {
    description = "CLI for interacting with clash";
    homepage = "https://github.com/George-Miao/clashctl";
    license = licenses.mit;
    maintainers = with maintainers; [ xieby1 ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ buildPythonPackage
, lib
, nss
, nspr
, expat
, fetchPypi
}:
let
  rpath = lib.makeLibraryPath [
    nss
    nspr
    expat
  ];
in buildPythonPackage rec {
  pname = "kaleido";
  version = "0.2.1";
  format = "wheel";
  src = fetchPypi {
    inherit pname version format;
    platform = "manylinux1_x86_64";
    hash = "sha256-qiHPG/HHj4+lCp99ReEAPDh709b+CnZ8+780S5W9w6g=";
  };
  doCheck = false;
  postFixup = ''
    for file in $(find $out -type f \( -perm /0111 -o -name \*.so\* \) ); do
      patchelf --set-interpreter "$(cat $NIX_CC/nix-support/dynamic-linker)" "$file" || true
      patchelf --set-rpath ${rpath}:$out/lib/x86_64-linux-gnu $file || true
    done
    sed -i 's,#!/bin/bash,#!/usr/bin/env bash,' $out/lib/python3.11/site-packages/kaleido/executable/kaleido
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="binutilss-ld-and-gccs-ld-collsion"><a class="header" href="#binutilss-ld-and-gccs-ld-collsion">binutils's ld and gcc's ld collsion</a></h1>
<p>Background: I want to install <code>gcc</code> and <code>objdump</code>, where <code>objdump</code> is contained in <code>binutils</code>.
Home-manager tolds me <code>gcc</code>'s <code>ld</code> collides with <code>binutils</code>'s <code>ld</code>.
As I explore into <code>gcc</code> and <code>binutils</code>, weird thing comes.</p>
<p>Packages <code>binutils</code> and <code>gcc</code> both contain ld executable.
<code>binutils</code> and <code>gcc</code> has the same priority 10.</p>
<p>The WEIRD thing is,</p>
<ul>
<li><code>binutils</code> wants to have a lower priority than gcc-wrapper,
so sets its priority to 10,
see nixpkgs: <code>pkgs/development/tools/misc/binutils/default.nix</code>
<blockquote>
<p>Give binutils a lower priority than gcc-wrapper to prevent a
collision due to the ld/as wrappers/symlinks in the latter.</p>
</blockquote>
</li>
<li>Both <code>gcc</code> wrapper and all-packages set gcc priority to 10,
see nixpkgs: <code>pkgs/top-level/all-packages.nix</code> and
<code>pkgs/build-support/cc-wrapper/default.nix</code>
All-packages set priority by lowPrio function,
which will set priority to 10.
Cc-wrapper directly set priority to 10.</li>
</ul>
<p>As a result, <code>binutils</code> will definitely collide with <code>gcc</code>!</p>
<p>My solution: assign <code>binutils</code> a lower priority, like this</p>
<pre><code class="language-nix">home.packages = with pkgs; [
  (lib.setPrio # higher value, less prior
    (bintools-unwrapped.meta.priority + 1)
    bintools-unwrapped
  )
  gdb
]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nodejs-packages-npm-in-nixos"><a class="header" href="#nodejs-packages-npm-in-nixos">Nodejs packages (npm) in NixOS</a></h1>
<h1 id="nixos中的nodejs包npm"><a class="header" href="#nixos中的nodejs包npm">NixOS中的Nodejs包（npm）</a></h1>
<p>太长不看：手动暴露<code>buildNodePackage</code>，添加自定义的npm包。</p>
<p>nixpkgs中的node包虽多但有限，
遇到需要的node包不存在时，是个麻烦事。</p>
<p>让我觉得十分诡异的是，
nixpkgs中存在一个十分方便的添加node包的函数<code>nodeEnv.buildNodePackage</code>，
但是这个函数却不暴露出来给用户。
甚至，有些nixpkgs中的包为了使用这个函数，
复制粘贴该函数到自己的包中。</p>
<p>在这些奇怪的事情的基础上，
还衍生出来自动生成该<code>buildNodePackage</code>函数软件<code>node2nix</code>。</p>
<p>所以这真的是存在即合理嘛？
还是我学艺不精，不能理解设计者的意图？</p>
<p>一个简单的暴露<code>buildNodePackage</code>的方法，
直接导入<code>buildNodePackage</code>所在的文件。
为了跨平台可用，
路径的构建采用了一点使用了点点小把戏，</p>
<pre><code class="language-nix">&lt;nixpkgs&gt; + /pkgs/development/node-packages/node-env.nix
</code></pre>
<p>以@types/node为例子，nodepkgs.nix：</p>
<pre><code class="language-nix">{ ... }:
let
  pkgs = import &lt;nixpkgs&gt; {};
  nodeEnv = import (&lt;nixpkgs&gt; + /pkgs/development/node-packages/node-env.nix) {
    inherit (pkgs) lib stdenv nodejs python2;
    inherit pkgs;
    inherit (pkgs) libtool runCommand writeTextFile writeShellScript;
  };
  globalBuildInputs = [];
in {
  "@types/node" = nodeEnv.buildNodePackage {
    name = "_at_types_slash_node";
    packageName = "@types/node";
    version = "18.7.15";
    src = pkgs.fetchurl {
      url = "https://registry.npmjs.org/@types/node/-/node-18.7.15.tgz";
      sha512 = "XnjpaI8Bgc3eBag2Aw4t2Uj/49lLBSStHWfqKvIuXD7FIrZyMLWp8KuAFHAqxMZYTF9l08N1ctUn9YNybZJVmQ==";
    };
    buildInputs = globalBuildInputs;
    meta = {
      description = "TypeScript definitions for Node.js";
      homepage = "https://github.com/DefinitelyTyped/DefinitelyTyped/tree/master/types/node";
      license = "MIT";
    };
    production = true;
    bypassCache = true;
    reconstructLock = true;
  };
}
</code></pre>
<p>该nodepkgs.nix文件为用户自定义的node包，
可以像nixpkgs一样使用这个文件，例如导入</p>
<pre><code class="language-nix">myNodePkgs = import ./cli/nodepkgs.nix {}
</code></pre>
<p>包的表达式为<code>myNodePkgs."@types/node"</code>。</p>
<div style="break-before: page; page-break-before: always;"></div><div style="text-align:right; font-size:3em;">2023.05.03</div>
<h1 id="打包pythonpip包以pandora-chatgpt为例"><a class="header" href="#打包pythonpip包以pandora-chatgpt为例">打包python（pip）包，以pandora-chatgpt为例</a></h1>
<p><strong>太常不看</strong></p>
<ul>
<li>nix文件: https://github.com/xieby1/nix_config/blob/main/usr/cli/pandora-chatgpt.nix</li>
<li>使用方法：
<pre><code class="language-nix">pkgs.python3Packages.callPackage ./cli/pandora-chatgpt.nix {};
</code></pre>
</li>
<li>Add python optional dependencies (extras): see <a href="https://nixos.org/manual/nixpkgs/stable/">nixpkgs manual</a> 17.27.2.3.2. Optional extra dependencies</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ buildPythonPackage
, fetchPypi
, appdirs
, certifi
, flask
, flask-cors
, httpx
, loguru
, pyjwt
, pyperclip
, requests
, rich
, sentry-sdk
, waitress
, werkzeug
}:

buildPythonPackage rec {
  pname = "Pandora-ChatGPT";
  version = "1.2.5";
  src = fetchPypi {
    inherit pname version;
    hash = "sha256-tfGqBRf/0VyaBuXsZEH8LwAuJYfk7oimY5Y0M1d/Qxs=";
  };
  doCheck = false;
  preBuild = ''
    # ignore version
    sed -i 's/\~=[^;]*//g' requirements.txt
  '';
  propagatedBuildInputs = [
    appdirs
    certifi
    flask
    flask-cors
    httpx
  ] ++ httpx.optional-dependencies.socks ++ [
    loguru
    pyjwt
  ] ++ pyjwt.optional-dependencies.crypto ++ [
    pyperclip
    requests
  ] ++ requests.optional-dependencies.socks ++ [
    rich
    sentry-sdk
    waitress
    werkzeug
    flask
  ] ++ flask.optional-dependencies.async;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="python-in-nixnixos"><a class="header" href="#python-in-nixnixos">Python in Nix/NixOS</a></h1>
<div style="text-align:right; font-size:3em;">2023.05.03</div>
<div class="table-wrapper"><table><thead><tr><th>Project</th><th>Maintained</th><th>Description</th><th>Purity</th><th>Compatibility</th></tr></thead><tbody>
<tr><td>venv</td><td></td><td></td><td>❌</td><td>100%?</td></tr>
<tr><td>mach-nix</td><td>✅</td><td></td><td></td><td></td></tr>
<tr><td>pypi2nix</td><td>❌</td><td></td><td></td><td></td></tr>
<tr><td>pip2nix</td><td>✅</td><td></td><td>✅</td><td></td></tr>
<tr><td><code>buildPythonPackage</code></td><td>✅</td><td></td><td>✅</td><td></td></tr>
<tr><td>[TODO] poetry</td><td></td><td></td><td></td><td></td></tr>
<tr><td>[TODO] dream2nix</td><td></td><td></td><td></td><td></td></tr>
</tbody></table>
</div>
<h2 id="pip2nix"><a class="header" href="#pip2nix">pip2nix</a></h2>
<p>Noted: Latest version of pip2nix only use python39.
While nixpkgs 22.11 (current stable) is python310.
I dont to install multiple versions of python3.</p>
<p>If pip2nix can overcome the disadvantage of that
generate a long list of python packages,
and reuse python3Packages in nixpkgs,
I would prefer to use pip2nix completely.</p>
<p>Currently, I use <code>buildPythonPackage</code>.</p>
<h2 id="buildpythonpackage"><a class="header" href="#buildpythonpackage"><code>buildPythonPackage</code></a></h2>
<p><code>pkgs.python3Packages.buildPythonPackage</code></p>
<h2 id="venv"><a class="header" href="#venv">venv</a></h2>
<p>Use virtualenv, <code>pip</code> is available, no need to write nix expressions to install packages.</p>
<p>Code see https://xieby1.github.io/scripts/index.html#venvnix</p>
<h2 id="poetry"><a class="header" href="#poetry">poetry</a></h2>
<div style="text-align:right; font-size:3em;">2022.05.15</div>
<p>According to <a href="https://www.reddit.com/r/NixOS/comments/q71v0e/what_is_the_correct_way_to_setup_pip_with_nix_to/">What is the correct way to setup pip with nix to install any python package in an isolated nix environment</a>,
I found two useful tools to install python packages in Nix/NixOS</p>
<ul>
<li>[TODO] poetry</li>
<li>mach-nix</li>
</ul>
<h2 id="mach-nix"><a class="header" href="#mach-nix">mach-nix</a></h2>
<p>mach-nix github repo:
<a href="https://github.com/DavHau/mach-nix">github.com/DavHau/mach-nix</a></p>
<p>Here is [python_mach.nix]({{ site.repo_url }}/scripts/shell/python_mach.nix),
an example which create a shell with a python package called expmcc.</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  opt = import ../../opt.nix;
  searxng_yml = builtins.toFile "searxng.yml" ''
    # https://docs.searxng.org/admin/settings/settings.html#settings-yml-location
    # The initial settings.yml we be load from these locations:
    # * the full path specified in the SEARXNG_SETTINGS_PATH environment variable.
    # * /etc/searxng/settings.yml

    # Default settings see &lt;pkgs.searxng&gt;/lib/python3.11/site-packages/searx/settings.yml
    use_default_settings: true

    search:
      autocomplete: "google"
      default_lang: "en"

    server:
      # Is overwritten by $SEARXNG_SECRET
      secret_key: ${if builtins.pathExists ~/Gist/Config/passwordFile
                    then builtins.readFile ~/Gist/Config/passwordFile
                    else "miao"}

    outgoing:
      proxies:
        all://:
          - http://127.0.0.1:${toString opt.proxyPort}

    engines:
      - name: bilibili
        engine: bilibili
        shortcut: bil
        disabled: false

      - name: bing
        engine: bing
        shortcut: bi
        disabled: false

      - name: qwant
        disabled: true
    ui:
      results_on_new_tab: true
  '';
in {
  systemd.user.services.searxng = {
    Unit = {
      Description = "Auto start searxng";
      After = ["network.target"];
    };
    Install = {
      WantedBy = ["default.target"];
    };
    Service = {
      Environment = [
        "SEARXNG_SETTINGS_PATH=${searxng_yml}"
      ];
      ExecStart = "${pkgs.searxng}/bin/searx-run";
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><div style="text-align:right; font-size:3em;">2022.05.29</div>
<h1 id="静态链接以qemu为例"><a class="header" href="#静态链接以qemu为例">静态链接，以qemu为例</a></h1>
<p>太长不看</p>
<ul>
<li>实现了qemu静态链接，无任何动态链接库的依赖。
采用了两个版本的qemu，当前版本Nix的qemu（nix 21.11, qemu 6.1.1）
和qemu3.1.0这两个版本。</li>
<li>nix脚本：<a href="https://github.com/xieby1/xieby1.github.io/blob/main/src/scripts/nix/pkgs_qemu_static.nix">pkgs_qemu_static.nix</a></li>
</ul>
<h2 id="pkgsstatic及其源代码"><a class="header" href="#pkgsstatic及其源代码">pkgsStatic及其源代码</a></h2>
<p>Nixpkgs含有pkgsStatic软件包，但是大多软件无法直接使用。
需要进行手动修复。</p>
<p>pkgsStatic加载过程的源码</p>
<ul>
<li>
<p>pkgs/top-level/stage.nix
将crossSystem设置为static且abi为musl。
之所以用Musl是因为，</p>
<blockquote>
<p>Currently uses Musl on Linux (couldn’t get static glibc to work).</p>
</blockquote>
<p>其代码大致的如下，</p>
<pre><code class="language-nix">pkgsStatic = nixpkgsFun {
  crossSystem = {
    isStatic = true;
    parsed = stdenv.hostPlatform.parsed // {
      abi = musl;
};};};
</code></pre>
<ul>
<li>nixpkgsFun = newArgs: import pkgs/top-level/default.nix (...)
<ul>
<li>pkgs/top-level/default.nix: stdenvStages {..., crossSystem, ...}
<ul>
<li>pkgs/stdenv/default.nix: stagesCross
<ul>
<li>pkgs/stdenv/cross/default.nix: stdenvAdapters.makeStatic
<ul>
<li>pkgs/stdenv/adapters.nix: makeStatic
<ul>
<li>makeStaticLibraries
<ul>
<li>添加configureFlags "--enable-static" "--disable-shared"</li>
<li>添加cmakeFlags "-DBUILD_SHARED_LIBS:BOOL=OFF"</li>
<li>添加mesonFlags "-Ddefault_library=static"</li>
</ul>
</li>
<li>makeStaticBinaries
<ul>
<li>添加NIX_CFLAGS_LINK "-static"</li>
<li>添加configureFlags "--disable-shared"</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>TODO: 读懂makeStaticLibraries和makeStaticBinaries。</p>
<h2 id="基本思路"><a class="header" href="#基本思路">基本思路</a></h2>
<p>对于当前版本的qemu，使用pkgsStatic.qemu
，挨个修复编译报错即可。</p>
<p>对于历史版本的qemu，以3.1.0为例，编译方式已和现在有区别，
比如之前完全是configure, make，而现在引入了meson。
初步设想两种方案，</p>
<ol>
<li>嫁接老版本nixpkgs到当前版本
将qemu-3.1.0对应的nixpkgs嫁接到当前的nixpkgs</li>
<li>改造新版本nixpkgs以适应老版本
通过overlay,override方法修改当前nixpkgs的qemu的nix表达式</li>
</ol>
<p>我采用的第一种办法，将老版本nixpkgs嫁接到当前版本nixpkgs。
使用<a href="https://lazamar.co.uk/nix-versions">lazamar.co.uk/nix-versions</a>
查询支持qemu-3.1.0的nixpkgs版本。
引入qemu-3.1.0的示例代码如下，详细见<a href="https://github.com/xieby1/xieby1.github.io/blob/main/src/scripts/nix/pkgs_qemu_static.nix">pkgs_qemu_static.nix</a></p>
<pre><code class="language-nix"># get old nixpkgs which contains qemu-3.1.0
oldNixpkgsSrc = builtins.fetchTarball {...}
qemu31 = pkgs.callPackage (
  oldNixpkgsSrc + "/pkgs/applications/virtualization/qemu/default.nix"
) {...}
</code></pre>
<p>然后挨个修复编译报错即可。</p>
<h2 id="调试手段"><a class="header" href="#调试手段">调试手段</a></h2>
<h3 id="还原构建环境"><a class="header" href="#还原构建环境">还原构建环境</a></h3>
<pre><code class="language-bash"># 保留构建失败的现场
nix-build pkgs_qemu_static.nix -K
</code></pre>
<p>进入现场包含env-vars文件和失败时的源码文件夹。
恢复环境，</p>
<pre><code class="language-bash">. ./env-vars
. $stdenv/setup
</code></pre>
<h3 id="查看依赖树"><a class="header" href="#查看依赖树">查看依赖树</a></h3>
<pre><code class="language-bash">nix-store --query --tree &lt;xxx.drv&gt;
</code></pre>
<h3 id="结果"><a class="header" href="#结果">结果</a></h3>
<p>目前仅需要命令行的qemu，因此为了省事，
我去掉了声音和图像支持。</p>
<p>注：在NixOS 21.11上和在ubuntu 22配合nix上编译出来的qemu二进制文件一模一样。</p>
<pre><font color="#4E9A06"><b>xieby1@yoga14s</b></font>:<font color="#3465A4"><b>~</b></font>
<font color="#4E9A06"><b>$</b></font> pkgs_qemu_static.nix 
/nix/store/gs6plgyc0jr9i5qams0ifksijnq9hkq2-qemu-static-x86_64-unknown-linux-musl-6.1.1
/nix/store/lm9kl1nm7bs4hy6l4qng03k4srx1x28n-qemu-3.1.0-x86_64-unknown-linux-musl
<font color="#4E9A06"><b>xieby1@yoga14s</b></font>:<font color="#3465A4"><b>~</b></font>
<font color="#4E9A06"><b>$</b></font> ldd result/bin/qemu-system-x86_64 
	not a dynamic executable
<font color="#4E9A06"><b>xieby1@yoga14s</b></font>:<font color="#3465A4"><b>~</b></font>
<font color="#4E9A06"><b>$</b></font> result/bin/qemu-system-x86_64 --version
QEMU emulator version 6.1.1
Copyright (c) 2003-2021 Fabrice Bellard and the QEMU Project developers
<font color="#4E9A06"><b>xieby1@yoga14s</b></font>:<font color="#3465A4"><b>~</b></font>
<font color="#4E9A06"><b>$</b></font> ldd result-2/bin/qemu-system-x86_64 
	not a dynamic executable
<font color="#4E9A06"><b>xieby1@yoga14s</b></font>:<font color="#3465A4"><b>~</b></font>
<font color="#4E9A06"><b>$</b></font> result-2/bin/qemu-system-x86_64  --version
QEMU emulator version 3.1.0
Copyright (c) 2003-2018 Fabrice Bellard and the QEMU Project developers</pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tailscaleheadscale"><a class="header" href="#tailscaleheadscale">Tailscale/Headscale</a></h1>
<h2 id="overview"><a class="header" href="#overview">overview</a></h2>
<ul>
<li>client
<ul>
<li>tailscale</li>
<li>tailscaled</li>
</ul>
</li>
<li>server
<ul>
<li>headscale</li>
</ul>
</li>
</ul>
<h2 id="command"><a class="header" href="#command">Command</a></h2>
<p>TODO: exit node</p>
<ul>
<li>https://www.reddit.com/r/Tailscale/comments/w9mtow/question_about_headscale_and_routing/</li>
<li>https://icloudnative.io/posts/how-to-set-up-or-migrate-headscale/</li>
</ul>
<p>TODO: headtail config
TODO: nix config</p>
<ul>
<li>rootless service</li>
<li>root service</li>
</ul>
<pre><code class="language-bash">tailscale --socket /tmp/tailscaled.sock up --login-server http://82.157.197.100
tailscale --socket /tmp/tailscaled.sock up --login-server http://82.157.197.100 --force-reauth
</code></pre>
<h3 id="enable-routes-exit-node"><a class="header" href="#enable-routes-exit-node">enable routes, exit node</a></h3>
<p>sudo tailscale --socket /tmp/tailscaled.sock up --login-server http://82.157.197.100 --advertise-routes=0.0.0.0/0,::/0 --accept-routes=true</p>
<p>sudo docker exec headscale headscale nodes routes enable -i 13 -a -r 0.0.0.0/0 -r ::/0</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  opt = import ../../opt.nix;
  tailscale-bash-completion = builtins.derivation {
    name = "tailscale-bash-completion";
    system = builtins.currentSystem;
    src = builtins.fetchurl "https://gist.githubusercontent.com/cmtsij/f0d0be209224a7bdd67592695e1427de/raw/tailscale";
    builder = pkgs.writeShellScript "tailscale-bash-completion-builder" ''
      source ${pkgs.stdenv}/setup
      dstdir=$out/share/bash-completion/completions
      dst=$dstdir/tailscale
      mkdir -p $dstdir
      cp $src $dst
    '';
  };
  tailscale-wrapper = {suffix, httpPort, socks5Port}: let
    tailscale-wrapped = pkgs.writeShellScriptBin "tailscale-${suffix}" ''
      tailscale --socket /tmp/tailscale-${suffix}.sock $@
    '';
    stateDir = "${config.home.homeDirectory}/.local/share/tailscale-${suffix}";
    tailscaled-wrapped = pkgs.writeShellScriptBin "tailscaled-${suffix}" ''
      TS_LOGS_DIR="${stateDir}" \
        ${pkgs.tailscale}/bin/tailscaled \
        --tun userspace-networking \
        --outbound-http-proxy-listen=localhost:${httpPort} \
        --socks5-server=localhost:${socks5Port} \
        --socket=/tmp/tailscale-${suffix}.sock \
        --state=${stateDir}/tailscaled.state \
        --statedir=${stateDir} \
        $@
    '';
    tailscale-wrapped-bash-completion = builtins.derivation {
      name = "tailscale-${suffix}-bash-completion";
      system = builtins.currentSystem;
      builder = pkgs.writeShellScript "tailscale-${suffix}-bash-completion-builder" ''
        source ${pkgs.stdenv}/setup
        reldir=share/bash-completion/completions
        dstdir=$out/$reldir
        dst=$dstdir/tailscale-${suffix}
        mkdir -p $dstdir
        touch $dst
        echo ". ${tailscale-bash-completion}/$reldir/tailscale" &gt;&gt; $dst
        echo "complete -F _tailscale tailscale-${suffix}" &gt;&gt; $dst
      '';
    };
  in {
    home.packages = [
      tailscale-wrapped
      tailscaled-wrapped
      tailscale-wrapped-bash-completion
    ];
    systemd.user.services."tailscaled-${suffix}" = {
      Unit = {
        Description = "Auto start tailscaled-${suffix} userspace network";
        After = ["clash.service"];
      };
      Install = {
        WantedBy = ["default.target"];
      };
      Service = {
        Environment = [
          "HTTPS_PROXY=http://127.0.0.1:${toString opt.proxyPort}"
          "HTTP_PROXY=http://127.0.0.1:${toString opt.proxyPort}"
          "https_proxy=http://127.0.0.1:${toString opt.proxyPort}"
          "http_proxy=http://127.0.0.1:${toString opt.proxyPort}"
        ];
        ExecStart = "${tailscaled-wrapped}/bin/tailscaled-${suffix}";
      };
    };
    programs.bash.bashrcExtra = lib.optionalString opt.isNixOnDroid ''
      # start tailscale-${suffix}
      if [[ -z "$(pidof tailscaled-${suffix})" ]]; then
          tmux new -d -s tailscaled-${suffix} tailscaled-${suffix}
      fi
    '';
  };
in {
  imports = [{
    home.packages = [pkgs.tailscale tailscale-bash-completion];
  }
    # (tailscale-wrapper {suffix="headscale"; httpPort="1055"; socks5Port="1065";})
    (tailscale-wrapper {suffix="official";  httpPort="1056"; socks5Port="1066";})
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tmux"><a class="header" href="#tmux">tmux</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  opt = import ../../opt.nix;
in {
  home.packages = [pkgs.tmux];
</code></pre>
<h2 id="bash-config-for-tmux"><a class="header" href="#bash-config-for-tmux">bash config for tmux</a></h2>
<p>Auto start tmux in non-GUI device.
mkAfter ensure the tmux config is appended to the tail of .bashrc.</p>
<pre><code class="language-nix">  programs.bash.bashrcExtra = lib.mkAfter (lib.optionalString (!opt.isGui) ''
    # Auto start tmux
    # see: https://unix.stackexchange.com/questions/43601/how-can-i-set-my-default-shell-to-start-up-tmux
    # ~~1. tmux exists on the system~~, nix ensure that tmux does exist
    # 2. we're in an interactive shell, and
    # 3. tmux doesn't try to run within itself
    if [ -n "$PS1" ] &amp;&amp; [[ ! "$TERM" =~ screen ]] &amp;&amp; [[ ! "$TERM" =~ tmux ]] &amp;&amp; [ -z "$TMUX" ]; then
      exec tmux
    fi
  '');
</code></pre>
<h2 id="tmux-config-file"><a class="header" href="#tmux-config-file">tmux config file</a></h2>
<pre><code class="language-nix">  home.file.tmux = {
    text = ''
      # display status at top
      set -g status-position top
      set -g status-right ""

      # status bar
      ## display title on terminal
      set -g set-titles on
      set -g window-status-format "#F#I #W #{=/-20/…:pane_title}"
      set -g window-status-current-format "🐶#F#I #W #{=/-20/…:pane_title}"
      ## hide status bar when only one window
      ### refer to
      ### https://www.reddit.com/r/tmux/comments/6lwb07/is_it_possible_to_hide_the_status_bar_in_only_a/
      ### It not good, since its global!
      # if -F "#{==:#{session_windows},1}" "set -g status off" "set -g status on"
      # set-hook -g window-linked 'if -F "#{==:#{session_windows},1}" "set -g status off" "set -g status on"'
      # set-hook -g window-unlinked 'if -F "#{==:#{session_windows},1}" "set -g status off" "set -g status on"'
      ## color
      ### colour256的前10个和终端(gnome-terminal tango)的配色一致
      set -g status-style "bg=white fg=black"
      set -g window-status-last-style "bg=white fg=green bold"
      set -g window-status-current-style "bg=black fg=green bold"
      # set -g window-status-separator "|"

      # enable mouse scroll
      set -g mouse on

      # window index start from 1
      set -g base-index 1
      setw -g pane-base-index 1

      # auto re-number
      set -g renumber-windows on

      # Set new panes to open in current directory
      bind c new-window -c "#{pane_current_path}"
      bind '"' split-window -c "#{pane_current_path}"
      bind % split-window -h -c "#{pane_current_path}"

      # alt-num select window
      bind-key -n M-1 select-window -t 1
      bind-key -n M-2 select-window -t 2
      bind-key -n M-3 select-window -t 3
      bind-key -n M-4 select-window -t 4
      bind-key -n M-5 select-window -t 5
      bind-key -n M-6 select-window -t 6
      bind-key -n M-7 select-window -t 7
      bind-key -n M-8 select-window -t 8
      bind-key -n M-9 select-window -t 9
      # ctrl-t new window
      bind-key -n C-t new-window -c "#{pane_current_path}"

      # vi key bindings
      set -g mode-keys vi
      set -g status-keys vi

      # Home, End key not work in nix-on-droid
      # https://stackoverflow.com/questions/18600188/home-end-keys-do-not-work-in-tmux
      bind-key -n Home send Escape "OH"
      bind-key -n End send Escape "OF"

      set -g allow-passthrough on
    '';
    target = ".tmux.conf";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="neovim"><a class="header" href="#neovim">📑neovim</a></h1>
<p>xieby1's neovim config!</p>
<p>See <a href="usr/cli/vim/./default.nix.html">default.nix</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="drawit-ascii-art-drawing"><a class="header" href="#drawit-ascii-art-drawing">DrawIt: ascii art drawing</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  DrawIt = pkgs.vimUtils.buildVimPlugin {
    name = "DrawIt";
    src = pkgs.fetchFromGitHub {
      owner = "vim-scripts";
      repo = "DrawIt";
      rev = "master"; # I believe it wont update ^_*, so its safe
      sha256 = "0yn985pj8dn0bzalwfc8ssx62m01307ic1ypymil311m4gzlfy60";
    };
  };
in {
  programs.neovim = {
    plugins = [
      DrawIt
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim.plugins = [{
    plugin = pkgs.vimUtils.buildVimPlugin {
      pname = "codecompanion.nvim";
      # currently lastest
      version = "2025-1-27";
      src = pkgs.fetchFromGitHub {
        owner = "olimorris";
        repo = "codecompanion.nvim";
        rev = "f8b9dce0468708c3b280abb045927c6864a17869";
        hash = "sha256-1EMzh3TaQxj+eMLjizHwntl/6ZqTHRlxFF6IOSROnuA=";
      };
      meta.homepage = "https://github.com/olimorris/codecompanion.nvim/";
    };
    type = "lua";
    # https://codecompanion.olimorris.dev/configuration/adapters.html
    config = ''
      require("codecompanion").setup({
        adapters = {
          deepseek = function()
            return require("codecompanion.adapters").extend("deepseek", {
              env = {
                api_key = "cmd:cat ~/Gist/Vault/deepseek_api_key_nvim.txt",
              },
              schema = {
                model = {
                  default = "deepseek-chat",
                },
              },
            })
          end,
        },
        display = {
          chat = {
            diff = {
              enabled = true,
            },
          },
        },
        strategies = {
          chat = {
            adapter = "deepseek",
          },
          inline = {
            adapter = "deepseek",
          },
        },
      })
    '';
  }];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="my-nvim-color-scheme"><a class="header" href="#my-nvim-color-scheme">🎨My nvim color scheme</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-color-scheme = {
    plugin = pkgs.vimPlugins.sonokai;
    config = ''
      nnoremap &lt;leader&gt;c :set termguicolors!&lt;CR&gt;
      set termguicolors

      let g:sonokai_transparent_background = 1

      let g:sonokai_colors_override = {
      \ 'black':    ['#111215', '237'],
      \ 'bg0':      ['#22232a', '235'],
      \ 'bg1':      ['#33353f', '236'],
      \ 'bg2':      ['#444754', '236'],
      \ 'bg3':      ['#555869', '237'],
      \ 'bg4':      ['#666a7e', '237'],
      \ 'grey':     ['#a5a5a6', '246'],
      \ 'grey_dim': ['#787879', '240'],
      \}

      " custom sonokai,
      " see section "How to use custom colors" of `:h sonokai.vim`
      function! s:sonokai_custom() abort
        let l:palette = sonokai#get_palette('default', {})
        call sonokai#highlight('StatusLine', l:palette.black, l:palette.fg, 'bold')
        call sonokai#highlight('StatusLineNC', l:palette.black, l:palette.grey, 'bold')
      endfunction
      augroup SonokaiCustom
        autocmd!
        autocmd ColorScheme sonokai call s:sonokai_custom()
      augroup END

      colorscheme sonokai
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-color-scheme
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="conform-nvim-formatter"><a class="header" href="#conform-nvim-formatter">conform-nvim: formatter</a></h1>
<p>TODO: replace my conform-nvim with nixpkgs's one.</p>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-conform-nvim = let
    nvim_doc_tools = pkgs.fetchFromGitHub {
      owner = "stevearc";
      repo = "nvim_doc_tools";
      rev = "2fe4503c704ac816efdbbbf70d0c070ed3052bba";
      sha256 = "sha256-PtUMBHB+1IV8Q2L6pYKKvx7bliq63Z+2v8IDC5mvAeo=";
    };
    nvim-typecheck-action = pkgs.fetchFromGitHub {
      owner = "stevearc";
      repo = "nvim-typecheck-action";
      rev = "0a5ddc13b800c50bac699edd443f494a089824cd";
      sha256 = "sha256-Mzzt2A0WCeaeIDiCWgHii+RUQNlQssPxK5/LVaEgpbU=";
    };
    neodev_nvim = pkgs.fetchFromGitHub {
      owner = "folke";
      repo = "neodev.nvim";
      rev = "627b5b543f4df551fcddb99c17a8e260c453400d";
      sha256 = "sha256-S8/dUOcVPUeh54ZTELql/H5nW3DghpCtWzyxaPjZbCw=";
    };
  in {
    plugin = pkgs.vimUtils.buildVimPlugin {
      name = "conform.nvim";
      src = pkgs.fetchFromGitHub {
        owner = "stevearc";
        repo = "conform.nvim";
        rev = "a36c68d2cd551e49883ddb2492c178d915567f58";
        sha256 = "sha256-aul/6sQZMljF3nc+WrRhVEObytu4wkoVyTM5HognK7E=";
      };
      buildInputs = with pkgs; [
        python3Packages.pyparsing
        python3
        luajitPackages.luacheck
        stylua
        git
        lua-language-server
      ];
      preBuild = ''
        sed -i 's/all: doc lint test/all: doc/g' Makefile

        mkdir -p scripts/nvim_doc_tools
        cp -r ${nvim_doc_tools}/* scripts/nvim_doc_tools/
        # disable ShaDa
        sed -i 's/nvim --headless/nvim --headless -i NONE/' scripts/nvim_doc_tools/util.py

        mkdir -p scripts/nvim-typecheck-action
        cp -r ${nvim-typecheck-action}/* scripts/nvim-typecheck-action/
        patchShebangs scripts/nvim-typecheck-action/

        mkdir -p scripts/nvim-typecheck-action/libs/neodev.nvim
        cp -r ${neodev_nvim}/* scripts/nvim-typecheck-action/libs/neodev.nvim/
      '';
    };
    type = "lua";
    config = ''
      require("conform").setup({
        formatters_by_ft = {
          nix = { "nixfmt" },
          c = { "clang_format" },
          cpp = { "clang_format" },
        },
      })

      -- refer to https://github.com/stevearc/conform.nvim/blob/master/doc/recipes.md#format-command
      vim.api.nvim_create_user_command("TrimWhitespace", function(args)
        local range = nil
        if args.count ~= -1 then
          local end_line = vim.api.nvim_buf_get_lines(0, args.line2 - 1, args.line2, true)[1]
          range = {
            start = { args.line1, 0 },
            ["end"] = { args.line2, end_line:len() },
          }
        end
        require("conform").format({ formatters = {"trim_whitespace"}, range = range })
      end, { range = true })
      vim.keymap.set({'n','v'}, '&lt;leader&gt;f', ':TrimWhitespace&lt;CR&gt;')

      vim.api.nvim_create_user_command("Format", function(args)
        local range = nil
        if args.count ~= -1 then
          local end_line = vim.api.nvim_buf_get_lines(0, args.line2 - 1, args.line2, true)[1]
          range = {
            start = { args.line1, 0 },
            ["end"] = { args.line2, end_line:len() },
          }
        end
        require("conform").format({ async = true, lsp_fallback = true, range = range })
      end, { range = true })
      vim.keymap.set({'n','v'}, '&lt;leader&gt;F', ':Format&lt;CR&gt;')
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-conform-nvim
    ];
    extraPackages = with pkgs; [
      nixfmt-rfc-style
      clang-tools
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  opt = import ../../../opt.nix;
in {
</code></pre>
<p>Plugins with customizations:</p>
<pre><code class="language-nix">  imports = [
    ./nvim-metals
    ./conform-nvim.nix
    ./nvim-lspconfig.nix
    ./nvim-cmp.nix
    ./vim-mark.nix
    ./DrawIt.nix
    ./nvim-treesitter.nix
    ./nvim-config-local.nix
    ./leap-nvim.nix
    ./telescope-nvim.nix
    ./git-wip.nix
    ./vim-floaterm.nix
    ./vista-vim.nix
    ./vim-markdown.nix
    ./vim-hexokinase.nix
    ./gitsigns-nvim.nix
    ./color-scheme.nix
    ./hbac-nvim.nix
    ./winshift-nvim.nix
    ./smartyank-nvim.nix
    ./mini-nvim.nix
    ./vim-easy-align.nix
    ./codecompanion-nvim.nix
  ];

  programs.bash.shellAliases.view = "nvim -R";
</code></pre>
<p>Set nvim as manpager.
see nvim <code>:h :Man</code>.
nvim manpage huge mange is SLOW! E.g. man configuration.nix.</p>
<pre><code class="language-nix">  programs.bash.shellAliases.nman = "env MANPAGER='nvim +Man!' man";

  programs.neovim = {
    enable = true;
    viAlias = true;
    vimAlias = true;
    vimdiffAlias = true;

</code></pre>
<p>Plugins without customizations:</p>
<pre><code class="language-nix">    plugins = with pkgs.vimPlugins; [
      vim-smoothie
      vim-fugitive
      vim-nix
      vim-markdown-toc
      vim-commentary
      tabular
      vim-plugin-AnsiEsc
    ] ++ (lib.optional opt.isGui markdown-preview-nvim);

</code></pre>
<p>Vim config</p>
<pre><code class="language-nix">    extraConfig = ''
      " vim
      "" Highlight searches
      set hlsearch
      nnoremap &lt;F3&gt; :nohlsearch&lt;CR&gt;
      "" Show line number
      set number
      "" Always show the signcolumn, otherwise it would shift the text each time
      "" diagnostics appear/become resolved
      set signcolumn=number
      "" indent
      "set smartindent " not good, indentation in empty line cannot be auto removed
      """ show existing tab with 4 spaces width
      set tabstop=4
      """ when indenting with '&gt;', use 4 spaces width
      set shiftwidth=4
      """ specicial indent
      au FileType markdown setlocal shiftwidth=2 tabstop=2
      """ On pressing tab, insert 4 spaces
      set expandtab
      """ line wrap with ident
      set breakindent
      """" horizontally scroll 4 characters
      nnoremap z&lt;left&gt; 4zh
      nnoremap z&lt;right&gt; 4zl
      "" tags support, ';' means upward search, refering to http://vimdoc.sourceforge.net/htmldoc/editing.html#file-searching
      set tags=./tags;
      "" Fold
      """ fold text to be the first and last line
      """ refer to sbernheim4's reply at
      """ https://github.com/nvim-treesitter/nvim-treesitter/pull/390
      function! GetSpaces(foldLevel)
          if &amp;expandtab == 1
              " Indenting with spaces
              let str = repeat(" ", a:foldLevel / (&amp;shiftwidth + 1) - 1)
              return str
          elseif &amp;expandtab == 0
              " Indenting with tabs
              return repeat(" ", indent(v:foldstart) - (indent(v:foldstart) / &amp;shiftwidth))
          endif
      endfunction
      function! MyFoldText()
          let startLineText = getline(v:foldstart)
          let endLineText = trim(getline(v:foldend))
          let indentation = GetSpaces(foldlevel("."))
          let spaces = repeat(" ", 200)
          let str = indentation . startLineText . " …… " . endLineText . spaces
          return str
      endfunction
      "" toggle foldmethod between manual and indent
      set foldmethod=indent
      :function ToggleFoldmethod()
      : if (&amp;foldmethod == "manual")
      :   set foldmethod=indent
      : else
      :   set foldmethod=manual
      : endif
      :endfunction
      nnoremap &lt;Leader&gt;z :call ToggleFoldmethod()&lt;CR&gt;:echo &amp;foldmethod&lt;CR&gt;
      "" Custom display for text when folding
      set foldtext=MyFoldText()
      """ Set the foldlevel to a high setting,
      """ files are always loaded with opened folds.
      set foldlevel=20
      """ mouse support " select by pressing shift key!
      set mouse=a
      """ matchit.vim " :h matchit-install
      packadd! matchit
      "" Preview
      nnoremap &lt;leader&gt;[ :pc&lt;CR&gt;
      "" highlight unwanted whitespace
      set list
      set listchars=tab:&gt;-,trail:-
      "" syntax
      syntax on
      "" backspace
      set backspace=indent,eol,start
      "" wrap line
      """ https://stackoverflow.com/questions/248102/is-there-any-command-to-toggle-enable-auto-text-wrapping
      :function ToggleWrap()
      : if (&amp;wrap == 1)
      :   set nowrap
      : else
      :   set wrap
      : endif
      :endfunction
      nnoremap &lt;F9&gt; :call ToggleWrap()&lt;CR&gt;
      set updatetime=400
      "" highlight current line
      set cursorlineopt=number
      augroup CursorLine
        au!
        au VimEnter,WinEnter,BufWinEnter * setlocal cursorline
        au WinLeave * setlocal nocursorline
      augroup END

      " filetype
      augroup filetype
          " detect LLVM IR file
          au! BufRead,BufNewFile *.ll     set filetype=llvm
          " cpp " from gem5
          au! BufRead,BufNewFile *.hh.inc,*.cc.inc set filetype=cpp
      augroup END

      " set terminal title
      "" https://stackoverflow.com/questions/15123477/tmux-tabs-with-name-of-file-open-in-vim
      autocmd BufEnter * let &amp;titlestring = "" . expand("%:t")
      set title

      nnoremap &lt;F10&gt; :echo "hi&lt;" . synIDattr(synID(line("."),col("."),1),"name") . '&gt; trans&lt;'
      \ . synIDattr(synID(line("."),col("."),0),"name") . "&gt; lo&lt;"
      \ . synIDattr(synIDtrans(synID(line("."),col("."),1)),"name") . "&gt;"&lt;CR&gt;

      " highlight
      augroup HiglightTODO
          autocmd!
          autocmd WinEnter,VimEnter * :silent! call matchadd('Todo', 'TODO', -1)
      augroup END

      " wildmenu
      " see: https://github.com/neovim/neovim/pull/11001
      cnoremap &lt;expr&gt; &lt;Up&gt;    pumvisible() ? "\&lt;Left&gt;"  : "\&lt;Up&gt;"
      cnoremap &lt;expr&gt; &lt;Down&gt;  pumvisible() ? "\&lt;Right&gt;" : "\&lt;Down&gt;"
      cnoremap &lt;expr&gt; &lt;Left&gt;  pumvisible() ? "\&lt;Up&gt;"    : "\&lt;Left&gt;"
      cnoremap &lt;expr&gt; &lt;Right&gt; pumvisible() ? "\&lt;Down&gt;"  : "\&lt;Right&gt;"
    '';
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="git-wip-auto-wip-branch"><a class="header" href="#git-wip-auto-wip-branch">git-wip: auto wip branch</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  git-wip = pkgs.vimUtils.buildVimPlugin {
    name = "git-wip";
    src = pkgs.fetchFromGitHub {
      owner = "bartman";
      repo = "git-wip";
      rev = "1c095e93539261370ae811ebf47b8d3fe9166869";
      hash = "sha256-rjvg6sTOuUM3ltD3DuJqgBEDImLrsfdnK52qxCbu8vo=";
    };
    preInstall = "cd vim";
  };
in {
  programs.neovim = {
    plugins = [
      git-wip
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gitsigns-nvim-git-support"><a class="header" href="#gitsigns-nvim-git-support">gitsigns-nvim: git support</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-gitsigns-nvim = {
    plugin = pkgs.vimPlugins.gitsigns-nvim;
    type = "lua";
    config = ''
      require('gitsigns').setup {
        signs_staged_enable = false,
        signcolumn = false,
        numhl      = true,
        linehl     = true,

        current_line_blame = true,

        -- keymaps
        on_attach = function(bufnr)
          local gs = package.loaded.gitsigns

          local function map(mode, l, r, opts)
            opts = opts or {}
            opts.buffer = bufnr
            vim.keymap.set(mode, l, r, opts)
          end

          -- Navigation
          map('n', ']c', function()
            if vim.wo.diff then return ']c' end
            vim.schedule(function() gs.next_hunk() end)
            return '&lt;Ignore&gt;'
          end, {expr=true})

          map('n', '[c', function()
            if vim.wo.diff then return '[c' end
            vim.schedule(function() gs.prev_hunk() end)
            return '&lt;Ignore&gt;'
          end, {expr=true})

          -- Actions
          map({'n', 'v'}, '&lt;leader&gt;hs', ':Gitsigns stage_hunk&lt;CR&gt;')
          map({'n', 'v'}, '&lt;leader&gt;hr', ':Gitsigns reset_hunk&lt;CR&gt;')
          map('n', '&lt;leader&gt;hS', gs.stage_buffer)
          map('n', '&lt;leader&gt;hu', gs.undo_stage_hunk)
          map('n', '&lt;leader&gt;hR', gs.reset_buffer)
          map('n', '&lt;leader&gt;hp', gs.preview_hunk)
          map('n', '&lt;leader&gt;hb', function() gs.blame_line{full=true} end)
          map('n', '&lt;leader&gt;tb', gs.toggle_current_line_blame)
          map('n', '&lt;leader&gt;hd', gs.diffthis)
          map('n', '&lt;leader&gt;hD', function() gs.diffthis('~') end)
          map('n', '&lt;leader&gt;td', gs.toggle_deleted)

          -- Text object
          map({'o', 'x'}, 'ih', ':&lt;C-U&gt;Gitsigns select_hunk&lt;CR&gt;')
        end
      }
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-gitsigns-nvim
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hbac-nvim-auto-close-buffer"><a class="header" href="#hbac-nvim-auto-close-buffer">hbac-nvim: auto close buffer</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-hbac = {
    plugin = pkgs.vimUtils.buildVimPlugin {
      name = "hbac.nvim";
      src = pkgs.fetchFromGitHub {
        owner = "axkirillov";
        repo = "hbac.nvim";
        rev = "e2e8333aa56ef43a577ac3a2a2e87bdf2f0d4cbb";
        hash = "sha256-7+e+p+0zMHPJjpnKNkL7QQHZJGQ1DFZ6fsofcsVNXaY=";
      };
    };
    type = "lua";
    config = ''
      require("hbac").setup({
        autoclose     = true, -- set autoclose to false if you want to close manually
        threshold     = 10, -- hbac will start closing unedited buffers once that number is reached
        close_command = function(bufnr)
          vim.api.nvim_buf_delete(bufnr, {})
        end,
        close_buffers_with_windows = false, -- hbac will close buffers with associated windows if this option is `true`
        telescope = {
          -- See #telescope-configuration below
          },
      })
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-hbac
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-leap-nvim = {
    plugin = pkgs.vimPlugins.leap-nvim;
    type = "lua";
    config = ''
      require('leap').create_default_mappings()
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-leap-nvim
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mini-nvim-a-nvim-distro"><a class="header" href="#mini-nvim-a-nvim-distro">mini-nvim: a nvim distro</a></h1>
<p>mini-nvim is wonderful nvim plugin!
I found it due to below link:
indent-blankline.nvim is too complex.
However, it does not support basic functionality like highlight current indentation
See: https://github.com/lukas-reineke/indent-blankline.nvim/issues/649</p>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-mini-nvim = {
    plugin = pkgs.vimPlugins.mini-nvim;
    type = "lua";
    config = ''
      require('mini.indentscope').setup{
        options = {
          try_as_border = true,
        },
      }

      -- mini.animate looks promising, and can totally replace vim-smoothie
      -- However, bugs seem exist:
      -- * touchpad scroll become slow
      -- * background color blinks when create window
      -- * background color broken after q::q
      -- require('mini.animate').setup()

      require('mini.icons').setup()
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-mini-nvim
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nvim-cmp-completion"><a class="header" href="#nvim-cmp-completion">nvim-cmp: completion</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-nvim-cmp = {
    plugin = pkgs.vimPlugins.nvim-cmp;
    type = "lua";
    config = ''
      local cmp = require'cmp'

      cmp.setup({
        preselect = cmp.PreselectMode.None,
        snippet = {
          -- REQUIRED - you must specify a snippet engine
          expand = function(args)
            require('luasnip').lsp_expand(args.body) -- For `luasnip` users.
          end,
        },
        mapping = cmp.mapping.preset.insert({
          ['&lt;C-u&gt;'] = cmp.mapping.scroll_docs(-4), -- Up
          ['&lt;C-d&gt;'] = cmp.mapping.scroll_docs(4), -- Down
          -- C-b (back) C-f (forward) for snippet placeholder navigation.
          ['&lt;C-Space&gt;'] = cmp.mapping.complete(),

          -- https://github.com/hrsh7th/nvim-cmp/issues/1753
          -- The "Safely select entries with &lt;CR&gt;" example from wiki does not work correctly in command mode
          ["&lt;CR&gt;"] = cmp.mapping({
            i = function(fallback)
              if cmp.visible() and cmp.get_active_entry() then
                cmp.confirm({ behavior = cmp.ConfirmBehavior.Replace, select = false })
              else
                fallback()
              end
            end,
            s = cmp.mapping.confirm({ select = true }),
            c = cmp.mapping.confirm({ behavior = cmp.ConfirmBehavior.Replace, select = true }),
          }),

          ['&lt;Tab&gt;'] = cmp.mapping(function(fallback)
            if cmp.visible() then
              cmp.select_next_item()
            else
              fallback()
            end
          end, { 'i', 's' }),
          ['&lt;S-Tab&gt;'] = cmp.mapping(function(fallback)
            if cmp.visible() then
              cmp.select_prev_item()
            else
              fallback()
            end
          end, { 'i', 's' }),
        }),
        sources = cmp.config.sources({{
          name = 'nvim_lsp',
        }}, {{
          name = 'luasnip',
        }}, {{
          name = 'buffer',
          option = {
            -- completion using words from visible buffers
            get_bufnrs = function()
              local bufs = {}
              for _, win in ipairs(vim.api.nvim_list_wins()) do
                bufs[vim.api.nvim_win_get_buf(win)] = true
              end
              return vim.tbl_keys(bufs)
            end
          },
        }}, {{
          name = 'path',
    '' + pkgs.lib.optionalString (builtins.currentSystem=="x86_64-linux") ''
        }}, {{
          name = 'cmp_tabnine',
    '' + ''
        }})
      })
    '';
  };
  my-cmp-tabnine = {
    plugin = pkgs.vimPlugins.cmp-tabnine;
    type = "lua";
    config = ''
      local tabnine = require('cmp_tabnine.config')

      tabnine:setup({
        max_lines = 1000,
        max_num_results = 20,
        sort = true,
        run_on_every_keystroke = true,
        snippet_placeholder = '..',
        ignored_file_types = {
          -- default is not to ignore
          -- uncomment to ignore in lua:
          -- lua = true
        },
        show_prediction_strength = false
      })
    '';
  };
in {
  programs.neovim = {
    plugins = with pkgs.vimPlugins; [
      my-nvim-cmp
      cmp-nvim-lsp
      cmp-buffer
      cmp-path
      luasnip
      cmp_luasnip
    ] ++ pkgs.lib.optional (builtins.currentSystem == "x86_64-linux") my-cmp-tabnine;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nvim-config-local-load-local-vim-config"><a class="header" href="#nvim-config-local-load-local-vim-config">nvim-config-local: load local vim config</a></h1>
<pre><code class="language-nix"># TODO: use native neovim local local config ability.
{ config, pkgs, stdenv, lib, ... }:
let
  my-nvim-config-local = {
    plugin = pkgs.vimUtils.buildVimPlugin {
      name = "nvim-config-local";
      src = pkgs.fetchFromGitHub {
        owner = "klen";
        repo = "nvim-config-local";
        rev = "af59d6344e555917209f7304709bbff7cea9b5cc";
        sha256 = "1wg6g4rqpj12sjj0g1qxqgcpkzr7x82lk90lf6qczim97r3lj9hy";
      };
    };
    config = ''
      lua &lt;&lt; EOF
      require('config-local').setup {
        lookup_parents = true,
        silent = true,
      }
      EOF
      augroup config-local
        autocmd BufEnter * nested lua require'config-local'.source()
      augroup END
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-nvim-config-local
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nvim-lspconfig"><a class="header" href="#nvim-lspconfig">nvim-lspconfig</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-nvim-lspconfig = {
    plugin = pkgs.vimPlugins.nvim-lspconfig;
    type = "lua";
    config =
</code></pre>
<h2 id="global-mappings"><a class="header" href="#global-mappings">Global mappings.</a></h2>
<pre><code class="language-nix">    ''
      -- See `:help vim.diagnostic.*` for documentation on any of the below functions
      vim.keymap.set('n', '&lt;space&gt;e', vim.diagnostic.open_float)
      vim.keymap.set('n', '[d', vim.diagnostic.goto_prev)
      vim.keymap.set('n', ']d', vim.diagnostic.goto_next)
      vim.keymap.set('n', '&lt;space&gt;q', vim.diagnostic.setloclist)

      -- Use LspAttach autocommand to only map the following keys
      -- after the language server attaches to the current buffer
      vim.api.nvim_create_autocmd('LspAttach', {
        group = vim.api.nvim_create_augroup('UserLspConfig', {}),
        callback = function(ev)
          -- Enable completion triggered by &lt;c-x&gt;&lt;c-o&gt;
          vim.bo[ev.buf].omnifunc = 'v:lua.vim.lsp.omnifunc'

          -- Buffer local mappings.
          -- See `:help vim.lsp.*` for documentation on any of the below functions
          local opts = { buffer = ev.buf }
          vim.keymap.set('n', 'gD', vim.lsp.buf.declaration, opts)
          vim.keymap.set('n', 'gd', vim.lsp.buf.definition, opts)
          vim.keymap.set('n', 'gr', vim.lsp.buf.references, opts)
          vim.keymap.set('n', 'gi', vim.lsp.buf.implementation, opts)
          vim.keymap.set('n', 'K', vim.lsp.buf.hover, opts)
          vim.keymap.set('n', '&lt;C-k&gt;', vim.lsp.buf.signature_help, opts)
          vim.keymap.set('n', '&lt;space&gt;wa', vim.lsp.buf.add_workspace_folder, opts)
          vim.keymap.set('n', '&lt;space&gt;wr', vim.lsp.buf.remove_workspace_folder, opts)
          vim.keymap.set('n', '&lt;space&gt;wl', function() print(vim.inspect(vim.lsp.buf.list_workspace_folders())) end, opts)
          vim.keymap.set('n', '&lt;space&gt;D', vim.lsp.buf.type_definition, opts)
          vim.keymap.set('n', '&lt;space&gt;rn', vim.lsp.buf.rename, opts)
          vim.keymap.set({ 'n', 'v' }, '&lt;space&gt;ca', vim.lsp.buf.code_action, opts)
          vim.keymap.set('n', '&lt;space&gt;f', function() vim.lsp.buf.format { async = true } end, opts)
        end,
      })
    ''
</code></pre>
<h2 id="text"><a class="header" href="#text">Text</a></h2>
<pre><code class="language-nix">    + ''
      local paths = {
        -- vim.fn.stdpath("config") .. "/spell/ltex.dictionary.en-US.txt",
        vim.fn.expand("%:p:h") .. "/.ltexdict",
      }
      local words = {}
      for _, path in ipairs(paths) do
        local f = io.open(path)
        if f then
          for word in f:lines() do
            table.insert(words, word)
          end
        f:close()
        end
      end

      require('lspconfig').ltex.setup{
        settings = {
          ltex = {
            -- Supported languages:
            -- https://valentjn.github.io/ltex/settings.html#ltexlanguage
            -- https://valentjn.github.io/ltex/supported-languages.html#code-languages
            language = "en-US", -- "zh-CN" | "en-US",
            filetypes = { "bib", "gitcommit", "markdown", "org", "plaintex", "rst", "rnoweb", "tex", "pandoc" },
            dictionary = {
              ['en-GB'] = words,
            },
          },
        },
      }
    ''
</code></pre>
<h2 id="cc"><a class="header" href="#cc">C/C++</a></h2>
<h3 id="why-use-clangd-instead-of-ccls"><a class="header" href="#why-use-clangd-instead-of-ccls">Why use clangd instead of ccls?</a></h3>
<p>I encountered the problem below,
when view https://github.com/xieby1/openc910 smart_run/logical/tb/sim_main1.cpp</p>
<pre><code>LSP[ccls]: Error NO_RESULT_CALLBACK_FOUND: {
  error = {
    code = -32603,
    message = "failed to index /home/xieby1/Codes/openc910/smart_run/work/fputc.c"
  },
  id = 1,
  jsonrpc = "2.0"
}
</code></pre>
<p>After some searching, I found</p>
<p><a href="https://github.com/neovim/neovim/issues/15844">GitHub: neovim: issue: lsp: NO_RESULT_CALLBACK_FOUND with ccls, rust-analyzer #15844</a></p>
<p>sapphire-arches found:</p>
<blockquote>
<p>Something is causing the r-a LSP to send two replies with the same ID, see the attached log:
lsp_debug.log</p>
<p>It would be nice for the neovim LSP to handle this more gracefully (not filling my screen with garbage and taking focus), but I do think the bug is in R-A here? The problem seems to be related to editor.action.triggerParameterHints?</p>
</blockquote>
<p><a href="https://github.com/MaskRay/ccls/issues/836">GitHub: ccls: issue: I'm very confused about this question, it's about ccls or neovim built in LSP? #836</a></p>
<p>No one try to fix the two-replies problem in ccls.
However, nimaipatel recommanded <a href="https://github.com/p00f/clangd_extensions.nvim">clangd_extensions</a>.</p>
<pre><code class="language-nix">    + ''
      require('lspconfig').clangd.setup{
        filetypes = { "c", "cc", "cpp", "c++", "objc", "objcpp", "cuda", "proto" }
      }
      require("clangd_extensions.inlay_hints").setup_autocmd()
      require("clangd_extensions.inlay_hints").set_inlay_hints()
    ''
</code></pre>
<h2 id="nix"><a class="header" href="#nix">Nix</a></h2>
<pre><code class="language-nix">    + ''
      require('lspconfig').nixd.setup{}
    ''
</code></pre>
<h2 id="html"><a class="header" href="#html">Html</a></h2>
<pre><code class="language-nix">    + ''
      require('lspconfig').html.setup{}
    ''
</code></pre>
<h2 id="python"><a class="header" href="#python">Python</a></h2>
<pre><code class="language-nix">    + ''
      require('lspconfig').pyright.setup{}
    ''
</code></pre>
<h2 id="lua"><a class="header" href="#lua">Lua</a></h2>
<pre><code class="language-nix">    + ''
      require('lspconfig').lua_ls.setup{}
    ''
</code></pre>
<h2 id="auto-completion"><a class="header" href="#auto-completion">Auto completion</a></h2>
<pre><code class="language-nix">    + ''
      -- Add additional capabilities supported by nvim-cmp
      local capabilities = require("cmp_nvim_lsp").default_capabilities()

      -- Enable some language servers with the additional completion capabilities offered by nvim-cmp
      local servers = {
        'ltex',
        'clangd',
        'nixd',
        'html',
        'pyright',
        'lua_ls',
      }
      for _, lsp in ipairs(servers) do
        require('lspconfig')[lsp].setup {
          -- on_attach = my_custom_on_attach,
          capabilities = capabilities,
        }
      end
    '';
  };
</code></pre>
<h2 id="setting-up-my-nvim-lspconfig"><a class="header" href="#setting-up-my-nvim-lspconfig">Setting up my nvim-lspconfig</a></h2>
<pre><code class="language-nix">in {
  programs.neovim = {
    plugins = [
      my-nvim-lspconfig
      pkgs.vimPlugins.clangd_extensions-nvim
    ];
    extraPackages = with pkgs; [
      clang-tools
      ltex-ls
      nixd
      vscode-langservers-extracted # html
      pyright
      lua-language-server
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nvim-metals-scala-lsp"><a class="header" href="#nvim-metals-scala-lsp">nvim-metals: Scala LSP</a></h1>
<p>The JRE proxy need subtle configuration.</p>
<pre><code class="language-nix">{ config, pkgs, ... }:
let
  opt = import ../../../../opt.nix;
  jre_with_proxy = pkgs.callPackage ./jre_with_proxy.nix {
    jre = pkgs.openjdk_headless;
    proxyHost = "127.0.0.1";
    proxyPort = toString opt.proxyPort;
  };
  my-nvim-metals = {
    plugin = pkgs.vimPlugins.nvim-metals;
    type = "lua";
    config = ''
      -- lspconfig.metals.setup{}
      local metals_config = require("metals").bare_config()
      metals_config.find_root_dir_max_project_nesting = 2
      metals_config.root_patterns = {
        "build.sbt",
        "build.sc",
        ".git",
      }
      metals_config.settings = {
        showImplicitArguments = true,
        excludedPackages = { "akka.actor.typed.javadsl", "com.github.swagger.akka.javadsl" },
        serverProperties = {
          "-Dhttps.proxyHost=127.0.0.1",
          "-Dhttps.proxyPort=${toString opt.proxyPort}",
          "-Dhttp.proxyHost=127.0.0.1",
          "-Dhttp.proxyPort=${toString opt.proxyPort}",
        },
        -- see `:h metalsBinaryPath`, "Another setting for you crazy Nix kids." Hahaha!
        metalsBinaryPath = "${pkgs.metals.override {jre = jre_with_proxy;}}/bin/metals",
        javaHome = "${jre_with_proxy}",
        showImplicitArguments = true,
        showImplicitConversionsAndClasses = true,
        showInferredType = ture,
      }
      metals_config.capabilities = require("cmp_nvim_lsp").default_capabilities()
      -- Autocmd that will actually be in charging of starting the whole thing
      local nvim_metals_group = vim.api.nvim_create_augroup("nvim-metals", { clear = true })
      vim.api.nvim_create_autocmd("FileType", {
        group = nvim_metals_group,
        pattern = { "scala", "sbt" },
        callback = function()
          require("metals").initialize_or_attach(metals_config)
        end,
      })
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-nvim-metals
    ];
    extraPackages = [
      (pkgs.coursier.override {
        jre = jre_with_proxy;
      })
    ];

  };
  # nvim-metals proxy for bloop
  home.file.jvmopts = {
    text = ''
      -Dhttps.proxyHost=127.0.0.1
      -Dhttps.proxyPort=${toString opt.proxyPort}
      -Dhttp.proxyHost=127.0.0.1
      -Dhttp.proxyPort=${toString opt.proxyPort}
    '';
    target = ".bloop/.jvmopts";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="jre-with-proxy"><a class="header" href="#jre-with-proxy">JRE with Proxy</a></h1>
<p>Let JRE aware of proxy by default.
This package can be used standalone, while my main usage is for nvim-metals lsp.
Without proxy, the scala package update make me headached.</p>
<p>For usage example, see <a href="usr/cli/vim/nvim-metals/./default.nix">my nvim-metals config</a></p>
<pre><code class="language-nix">{ stdenv
, writeShellScript
, jre
, proxyHost
, proxyPort
}: let
  java_with_proxy_sh = writeShellScript "java" ''
    ${jre}/bin/java -Dhttp.proxyHost=${proxyHost} -Dhttp.proxyPort=${proxyPort} -Dhttps.proxyHost=${proxyHost} -Dhttps.proxyPort=${proxyPort} "$@"
  '';
in builtins.derivation rec {
  name = "jre_with_proxy";
  system = builtins.currentSystem;
  builder = writeShellScript "${name}-builder" ''
    source ${stdenv}/setup

    mkdir -p $out
    for dir in ${jre}/*; do
      ln -s $dir $out/
    done

    rm $out/bin
    mkdir -p $out/bin
    for file in ${jre}/lib/openjdk/bin/*; do
      ln -s $file $out/bin/
    done

    rm $out/bin/java
    ln -s ${java_with_proxy_sh} $out/bin/java
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nvim-treesitter-languages-parsing"><a class="header" href="#nvim-treesitter-languages-parsing">nvim-treesitter: languages parsing</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-nvim-treesitter = {
    # Available languages see:
    #   https://github.com/nvim-treesitter/nvim-treesitter
    # see `pkgs.tree-sitter.builtGrammars.`
    # with `tree-sitter-` prefix and `-grammar` suffix removed
    plugin = pkgs.vimPlugins.nvim-treesitter.withPlugins (p: with p; [
      c
      cpp
      python
      markdown
      lua
    ]);
    type = "lua";
    config = ''
      require 'nvim-treesitter.configs'.setup {
        -- TODO: https://github.com/NixOS/nixpkgs/issues/189838
        -- ensure_installed = {"c", "cpp", "python", "markdown"},
        ensure_installed = {},
        sync_install = false,
        highlight = {
          enable = true,
          additional_vim_regex_highlighting = false,
          disable = {
            "nix",
          },
        },
      }
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-nvim-treesitter
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="smartyank-nvim-smart-yank-to-clipboard"><a class="header" href="#smartyank-nvim-smart-yank-to-clipboard">smartyank-nvim: smart yank to clipboard</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-smartyank-nvim = {
    plugin = pkgs.vimPlugins.smartyank-nvim;
    type = "lua";
    config = ''
      require('smartyank').setup {
        highlight = {
          enabled = false, -- not enable highlight yanked text
        },
        validate_yank = function() return vim.v.operator == '"+y' end,
      }
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-smartyank-nvim
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="telescope-nvim"><a class="header" href="#telescope-nvim">telescope-nvim</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-telescope-nvim = {
    plugin = pkgs.vimPlugins.telescope-nvim;
    config = ''
      " search relative to file
      "" https://github.com/nvim-telescope/telescope.nvim/pull/902
      nnoremap ff &lt;cmd&gt;lua require('telescope.builtin').find_files({cwd=require'telescope.utils'.buffer_dir()})&lt;cr&gt;
      nnoremap fg &lt;cmd&gt;lua require('telescope.builtin').live_grep({cwd=require'telescope.utils'.buffer_dir()})&lt;cr&gt;
      nnoremap fF &lt;cmd&gt;lua require('telescope.builtin').find_files()&lt;cr&gt;
      nnoremap fG &lt;cmd&gt;lua require('telescope.builtin').live_grep()&lt;cr&gt;
      nnoremap fb &lt;cmd&gt;lua require('telescope.builtin').buffers()&lt;cr&gt;
      nnoremap fh &lt;cmd&gt;lua require('telescope.builtin').help_tags()&lt;cr&gt;
      nnoremap ft &lt;cmd&gt;lua require('telescope.builtin').treesitter()&lt;cr&gt;
      nnoremap fc &lt;cmd&gt;lua require('telescope.builtin').command_history()&lt;cr&gt;
      nnoremap fC &lt;cmd&gt;lua require('telescope.builtin').commands()&lt;cr&gt;
    '';
  };
  my-telescope-fzf-native-nvim = {
    plugin = pkgs.vimPlugins.telescope-fzf-native-nvim;
    type = "lua";
    config = ''
      require('telescope').setup {
        extensions = {fzf = {}},
        defaults = {
          layout_strategy = 'vertical'
        }
      }
      require('telescope').load_extension('fzf')
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-telescope-nvim
      my-telescope-fzf-native-nvim
      pkgs.vimPlugins.plenary-nvim
    ];
    extraPackages = with pkgs; [
      ripgrep
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vim-easy-align-a-simple-easy-to-use-vim-alignment-plugin"><a class="header" href="#vim-easy-align-a-simple-easy-to-use-vim-alignment-plugin">vim-easy-align: A simple, easy-to-use Vim alignment plugin.</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-vim-easy-align = {
    plugin = pkgs.vimPlugins.vim-easy-align;
    config = ''
      " Start interactive EasyAlign in visual mode (e.g. vipga)
      xmap ga &lt;Plug&gt;(EasyAlign)

      " Start interactive EasyAlign for a motion/text object (e.g. gaip)
      nmap ga &lt;Plug&gt;(EasyAlign)

      let g:easy_align_delimiters = {
      \ '&gt;': { 'pattern': '&gt;&gt;\|=&gt;\|&gt;' },
      \ '/': {
      \     'pattern':         '//\+\|/\*\|\*/',
      \     'delimiter_align': 'l',
      \     'ignore_groups':   ['!Comment'] },
      \ ']': {
      \     'pattern':       '[\]]',
      \     'left_margin':   0,
      \     'right_margin':  0,
      \     'stick_to_left': 0
      \   },
      \ '[': {
      \     'pattern':       '[\[]',
      \     'left_margin':   0,
      \     'right_margin':  0,
      \     'stick_to_left': 0
      \   },
      \ ')': {
      \     'pattern':       '[)]',
      \     'left_margin':   0,
      \     'right_margin':  0,
      \     'stick_to_left': 0
      \   },
      \ '(': {
      \     'pattern':       '[(]',
      \     'left_margin':   0,
      \     'right_margin':  0,
      \     'stick_to_left': 0
      \   },
      \ }
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-vim-easy-align
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vim-floaterm-floating-terminal"><a class="header" href="#vim-floaterm-floating-terminal">vim-floaterm: floating terminal</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-vim-floaterm = {
    plugin = pkgs.vimPlugins.vim-floaterm;
    config = ''
      nmap &lt;Leader&gt;t :FloatermNew --cwd=&lt;buffer&gt;&lt;CR&gt;
      " let g:floaterm_keymap_new = '&lt;Leader&gt;t'
      let g:floaterm_width = 0.8
      let g:floaterm_height = 0.8
      " Set floaterm window's background
      hi Floaterm guibg=black
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-vim-floaterm
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vim-hexokinase-display-colors"><a class="header" href="#vim-hexokinase-display-colors">vim-hexokinase: display colors</a></h1>
<h2 id="highlight-color-code"><a class="header" href="#highlight-color-code">highlight color code</a></h2>
<p>TLDR: vim-hexokinase isn't perfect but works.
It need works in <code>termguicolors</code> mode.
It is better to choose a color scheme which is visualized in gui mode.
And it is very tricky to setting colors in <code>termguicolors</code> &amp; <code>notermguicolors</code> the same, which is insane.</p>
<p>It would be convenient, if color code can be visualised in editor, especially in web programming.
I found two candidates plugins to achieve this goal,
<a href="https://github.com/ap/vim-css-color">vim-css-color</a>,
<a href="https://github.com/RRethy/vim-hexokinase">vim-hexokinase</a>.</p>
<p>Vim-css-color is not compatible with tree-sitter, due to regex based highlight.
See <a href="https://github.com/ap/vim-css-color/issues/164">Github Issue: Neovim tree sitter support</a> for details.
Vim-css-color sometimes cannot render same text color.
I need to scroll my vim viewport, then it <strong>may</strong> render color correctly.</p>
<p>Vim-hexokinase is good, but must depends on <code>termguicolors</code> is turned on.
<code>termguicolors</code> will enable 24-bit RGB color,
while originally vim uses Base16 color.
The result is the color theme you familiar with will be changed.</p>
<p>Here is the visual comparison between vim-css-color and vim-hexokinase.
I copy these text as html from my vim.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">vcc</th><th style="text-align: center">vcc tgc</th><th style="text-align: center">vh tgc</th></tr></thead><tbody>
<tr><td style="text-align: center"><span style="background-color:#FF0000"><font color="#EEEEEC">#ff0000</font></span></td><td style="text-align: center"><span style="background-color:#FF0000"><font color="#FFFFFF">#ff0000</font></span></td><td style="text-align: center"><span style="background-color:#FF0000"><font color="#FFFFFF">#ff0000</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF0000"><font color="#EEEEEC">#ff1111</font></span></td><td style="text-align: center"><span style="background-color:#FF1111"><font color="#FFFFFF">#ff1111</font></span></td><td style="text-align: center"><span style="background-color:#FF1111"><font color="#FFFFFF">#ff1111</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF0000"><font color="#EEEEEC">#ff2222</font></span></td><td style="text-align: center"><span style="background-color:#FF2222"><font color="#FFFFFF">#ff2222</font></span></td><td style="text-align: center"><span style="background-color:#FF2222"><font color="#FFFFFF">#ff2222</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF0000"><font color="#EEEEEC">#ff3333</font></span></td><td style="text-align: center"><span style="background-color:#FF3333"><font color="#FFFFFF">#ff3333</font></span></td><td style="text-align: center"><span style="background-color:#FF3333"><font color="#FFFFFF">#ff3333</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF5F5F"><font color="#2E3436">#ff4444</font></span></td><td style="text-align: center"><span style="background-color:#FF4444"><font color="#000000">#ff4444</font></span></td><td style="text-align: center"><span style="background-color:#FF4444"><font color="#FFFFFF">#ff4444</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF5F5F"><font color="#2E3436">#ff5555</font></span></td><td style="text-align: center"><span style="background-color:#FF5555"><font color="#000000">#ff5555</font></span></td><td style="text-align: center"><span style="background-color:#FF5555"><font color="#FFFFFF">#ff5555</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF5F5F"><font color="#2E3436">#ff6666</font></span></td><td style="text-align: center"><span style="background-color:#FF6666"><font color="#000000">#ff6666</font></span></td><td style="text-align: center"><span style="background-color:#FF6666"><font color="#FFFFFF">#ff6666</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF8787"><font color="#2E3436">#ff7777</font></span></td><td style="text-align: center"><span style="background-color:#FF7777"><font color="#000000">#ff7777</font></span></td><td style="text-align: center"><span style="background-color:#FF7777"><font color="#FFFFFF">#ff7777</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF8787"><font color="#2E3436">#ff8888</font></span></td><td style="text-align: center"><span style="background-color:#FF8888"><font color="#000000">#ff8888</font></span></td><td style="text-align: center"><span style="background-color:#FF8888"><font color="#FFFFFF">#ff8888</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF8787"><font color="#2E3436">#ff9999</font></span></td><td style="text-align: center"><span style="background-color:#FF9999"><font color="#000000">#ff9999</font></span></td><td style="text-align: center"><span style="background-color:#FF9999"><font color="#FFFFFF">#ff9999</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FFAFAF"><font color="#2E3436">#ffaaaa</font></span></td><td style="text-align: center"><span style="background-color:#FFAAAA"><font color="#000000">#ffaaaa</font></span></td><td style="text-align: center"><span style="background-color:#FFAAAA"><font color="#000000">#ffaaaa</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FFAFAF"><font color="#2E3436">#ffbbbb</font></span></td><td style="text-align: center"><span style="background-color:#FFBBBB"><font color="#000000">#ffbbbb</font></span></td><td style="text-align: center"><span style="background-color:#FFBBBB"><font color="#000000">#ffbbbb</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FFD7D7"><font color="#2E3436">#ffcccc</font></span></td><td style="text-align: center"><span style="background-color:#FFCCCC"><font color="#000000">#ffcccc</font></span></td><td style="text-align: center"><span style="background-color:#FFCCCC"><font color="#000000">#ffcccc</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FFD7D7"><font color="#2E3436">#ffdddd</font></span></td><td style="text-align: center"><span style="background-color:#FFDDDD"><font color="#000000">#ffdddd</font></span></td><td style="text-align: center"><span style="background-color:#FFDDDD"><font color="#000000">#ffdddd</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#EEEEEE"><font color="#2E3436">#ffeeee</font></span></td><td style="text-align: center"><span style="background-color:#FFEEEE"><font color="#000000">#ffeeee</font></span></td><td style="text-align: center"><span style="background-color:#FFEEEE"><font color="#000000">#ffeeee</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FFFFFF"><font color="#2E3436">#ffffff</font></span></td><td style="text-align: center"><span style="background-color:#FFFFFF"><font color="#000000">#ffffff</font></span></td><td style="text-align: center"><span style="background-color:#FFFFFF"><font color="#000000">#ffffff</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#000000"><font color="#EEEEEC">#000000</font></span></td><td style="text-align: center"><span style="background-color:#000000"><font color="#FFFFFF">#000000</font></span></td><td style="text-align: center"><span style="background-color:#000000"><font color="#FFFFFF">#000000</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#121212"><font color="#EEEEEC">#111111</font></span></td><td style="text-align: center"><span style="background-color:#111111"><font color="#FFFFFF">#111111</font></span></td><td style="text-align: center"><span style="background-color:#111111"><font color="#FFFFFF">#111111</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#262626"><font color="#EEEEEC">#222222</font></span></td><td style="text-align: center"><span style="background-color:#222222"><font color="#FFFFFF">#222222</font></span></td><td style="text-align: center"><span style="background-color:#222222"><font color="#FFFFFF">#222222</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#303030"><font color="#EEEEEC">#333333</font></span></td><td style="text-align: center"><span style="background-color:#333333"><font color="#FFFFFF">#333333</font></span></td><td style="text-align: center"><span style="background-color:#333333"><font color="#FFFFFF">#333333</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#444444"><font color="#EEEEEC">#444444</font></span></td><td style="text-align: center"><span style="background-color:#444444"><font color="#FFFFFF">#444444</font></span></td><td style="text-align: center"><span style="background-color:#444444"><font color="#FFFFFF">#444444</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#585858"><font color="#EEEEEC">#555555</font></span></td><td style="text-align: center"><span style="background-color:#555555"><font color="#FFFFFF">#555555</font></span></td><td style="text-align: center"><span style="background-color:#555555"><font color="#FFFFFF">#555555</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#626262"><font color="#EEEEEC">#666666</font></span></td><td style="text-align: center"><span style="background-color:#666666"><font color="#FFFFFF">#666666</font></span></td><td style="text-align: center"><span style="background-color:#666666"><font color="#FFFFFF">#666666</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#767676"><font color="#EEEEEC">#777777</font></span></td><td style="text-align: center"><span style="background-color:#777777"><font color="#FFFFFF">#777777</font></span></td><td style="text-align: center"><span style="background-color:#777777"><font color="#FFFFFF">#777777</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#878787"><font color="#2E3436">#888888</font></span></td><td style="text-align: center"><span style="background-color:#888888"><font color="#000000">#888888</font></span></td><td style="text-align: center"><span style="background-color:#888888"><font color="#FFFFFF">#888888</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#9E9E9E"><font color="#2E3436">#999999</font></span></td><td style="text-align: center"><span style="background-color:#999999"><font color="#000000">#999999</font></span></td><td style="text-align: center"><span style="background-color:#999999"><font color="#FFFFFF">#999999</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#A8A8A8"><font color="#2E3436">#aaaaaa</font></span></td><td style="text-align: center"><span style="background-color:#AAAAAA"><font color="#000000">#aaaaaa</font></span></td><td style="text-align: center"><span style="background-color:#AAAAAA"><font color="#FFFFFF">#aaaaaa</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#BCBCBC"><font color="#2E3436">#bbbbbb</font></span></td><td style="text-align: center"><span style="background-color:#BBBBBB"><font color="#000000">#bbbbbb</font></span></td><td style="text-align: center"><span style="background-color:#BBBBBB"><font color="#000000">#bbbbbb</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#D0D0D0"><font color="#2E3436">#cccccc</font></span></td><td style="text-align: center"><span style="background-color:#CCCCCC"><font color="#000000">#cccccc</font></span></td><td style="text-align: center"><span style="background-color:#CCCCCC"><font color="#000000">#cccccc</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#DADADA"><font color="#2E3436">#dddddd</font></span></td><td style="text-align: center"><span style="background-color:#DDDDDD"><font color="#000000">#dddddd</font></span></td><td style="text-align: center"><span style="background-color:#DDDDDD"><font color="#000000">#dddddd</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#EEEEEE"><font color="#2E3436">#eeeeee</font></span></td><td style="text-align: center"><span style="background-color:#EEEEEE"><font color="#000000">#eeeeee</font></span></td><td style="text-align: center"><span style="background-color:#EEEEEE"><font color="#000000">#eeeeee</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FFFFFF"><font color="#2E3436">#ffffff</font></span></td><td style="text-align: center"><span style="background-color:#FFFFFF"><font color="#000000">#ffffff</font></span></td><td style="text-align: center"><span style="background-color:#FFFFFF"><font color="#000000">#ffffff</font></span></td></tr>
</tbody></table>
</div>
<p>Vim-css-color with out <code>termguicolors</code> cannot display color correctly (or say precisely),
if you dont believe your eye, see the source code of this page.</p>
<p>I think vim-hexokinase with a <code>termguicolors</code> toggle is a acceptable compromise.
Toggle <code>termguicolors</code> by <code>:set termguicolors!</code>.
I personally prefer to assign <code>&lt;leader&gt;c</code> to toggle <code>termguicolors</code>.</p>
<h3 id="cterm--gui"><a class="header" href="#cterm--gui">cterm &amp; gui</a></h3>
<p>TLDR: I still haven't find a elegant solution to keep <code>termguicolors</code> and <code>notermguicolors</code> visually same.</p>
<p>neovim has 2 color schemes cterm &amp; gui,
see <code>:h cterm-colors</code> &amp; <code>:h gui-colors</code>.
Default sntax colors are different in these two schemes.
For example, <code>:verbose highlight Comment</code> returns</p>
<pre><code class="language-vim">Comment        xxx ctermfg=14 guifg=#80a0ff
        Last set from /nix/store/pr1pwjjsm3k45rwi3w0xh2296rpymjlz-neovim-unwrapped-0.5.1/share/nvim/runtime/syntax/syncolor.vim
</code></pre>
<p>which means ctermfg uses the 14th color in ANSI colors,
while guifg use a hex color code.
The detailed setting is located in <code>${VIMRUNTIME}/syntax/syncolor.vim</code>.</p>
<p>I create a new syncolor.vim based the default one,
and modify the all ctermfg and guifg to same color name, like below.
The colors in two schemes are still different.</p>
<pre><code class="language-vim">if !exists("syntax_cmd") || syntax_cmd == "on"
  " ":syntax on" works like in Vim 5.7: set colors but keep links
  command -nargs=* SynColor hi &lt;args&gt;
  command -nargs=* SynLink hi link &lt;args&gt;
else
  if syntax_cmd == "enable"
    " ":syntax enable" keeps any existing colors
    command -nargs=* SynColor hi def &lt;args&gt;
    command -nargs=* SynLink hi def link &lt;args&gt;
  elseif syntax_cmd == "reset"
    " ":syntax reset" resets all colors to the default
    command -nargs=* SynColor hi &lt;args&gt;
    command -nargs=* SynLink hi! link &lt;args&gt;
  else
    " User defined syncolor file has already set the colors.
    finish
  endif
endif

" Many terminals can only use six different colors (plus black and white).
" Therefore the number of colors used is kept low. It doesn't look nice with
" too many colors anyway.
" Careful with "cterm=bold", it changes the color to bright for some terminals.
" There are two sets of defaults: for a dark and a light background.
if &amp;background == "dark"
  SynColor Comment	term=bold cterm=NONE ctermfg=Cyan ctermbg=NONE gui=NONE guifg=Cyan guibg=NONE
  SynColor Constant	term=underline cterm=NONE ctermfg=Magenta ctermbg=NONE gui=NONE guifg=Magenta guibg=NONE
  SynColor Special	term=bold cterm=NONE ctermfg=LightRed ctermbg=NONE gui=NONE guifg=LightRed guibg=NONE
  SynColor Identifier	term=underline cterm=bold ctermfg=Cyan ctermbg=NONE gui=bold guifg=Cyan guibg=NONE
  SynColor Statement	term=bold cterm=NONE ctermfg=Yellow ctermbg=NONE gui=NONE guifg=Yellow guibg=NONE
  SynColor PreProc	term=underline cterm=NONE ctermfg=LightBlue ctermbg=NONE gui=NONE guifg=LightBlue guibg=NONE
  SynColor Type		term=underline cterm=NONE ctermfg=LightGreen ctermbg=NONE gui=NONE guifg=LightGreen guibg=NONE
  SynColor Underlined	term=underline cterm=underline ctermfg=LightBlue gui=underline guifg=LightBlue
  SynColor Ignore	term=NONE cterm=NONE ctermfg=black ctermbg=NONE gui=NONE guifg=black guibg=NONE
else
  SynColor Comment	term=bold cterm=NONE ctermfg=DarkBlue ctermbg=NONE gui=NONE guifg=DarkBlue guibg=NONE
  SynColor Constant	term=underline cterm=NONE ctermfg=DarkRed ctermbg=NONE gui=NONE guifg=DarkBlue guibg=NONE
  SynColor Special	term=bold cterm=NONE ctermfg=DarkMagenta ctermbg=NONE gui=NONE guifg=DarkMagenta guibg=NONE
  SynColor Identifier	term=underline cterm=NONE ctermfg=DarkCyan ctermbg=NONE gui=NONE guifg=DarkCyan guibg=NONE
  SynColor Statement	term=bold cterm=NONE ctermfg=Brown ctermbg=NONE gui=bold guifg=Brown guibg=NONE
  SynColor PreProc	term=underline cterm=NONE ctermfg=DarkMagenta ctermbg=NONE gui=NONE guifg=DarkMagenta guibg=NONE
  SynColor Type		term=underline cterm=NONE ctermfg=DarkGreen ctermbg=NONE gui=NONE guifg=DarkGreen guibg=NONE
  SynColor Underlined	term=underline cterm=underline ctermfg=DarkMagenta gui=underline guifg=DarkMagenta
  SynColor Ignore	term=NONE cterm=NONE ctermfg=white ctermbg=NONE gui=NONE guifg=white guibg=NONE
endif
SynColor Error		term=reverse cterm=NONE ctermfg=White ctermbg=Red gui=NONE guifg=White guibg=Red
SynColor Todo		term=standout cterm=NONE ctermfg=Black ctermbg=Yellow gui=NONE guifg=Black guibg=Yellow
</code></pre>
<p>The Magenta is especially dazzling,
and cannot change it by below tries.</p>
<p>Refers to <a href="https://github.com/vim/vim/issues/2353">Change Vim's terminal colors when termguicolors is set #2353</a>,
<a href="http://neovim.io/doc/user/nvim_terminal_emulator.html#nvim-terminal-emulator-configuration">nvim-terminal-emulator-configuration</a>,</p>
<p><code>let g:terminal_color_13 = '#AD7FA8' " Magenta</code> doesn't work.</p>
<p>Finally I choose to add a color-scheme manager,
and choose a theme which has both cterm &amp; gui color scheme.</p>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-vim-hexokinase = {
    plugin = pkgs.vimPlugins.vim-hexokinase;
    config = ''
      let g:Hexokinase_highlighters = ['backgroundfull']
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-vim-hexokinase
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vim-mark-multi-color-highlight"><a class="header" href="#vim-mark-multi-color-highlight">vim-mark: multi-color highlight</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  vim-ingo-library = pkgs.vimUtils.buildVimPlugin {
    name = "vim-ingo-library";
    src = pkgs.fetchFromGitHub {
      owner = "inkarkat";
      repo = "vim-ingo-library";
      rev = "8ea0e934d725a0339f16375f248fbf1235ced5f6";
      sha256 = "1rabyhayxswwh85lp4rzi2w1x1zbp5j0v025vsknzbqi0lqy32nk";
    };
  };
  my-vim-mark = {
    plugin = pkgs.vimUtils.buildVimPlugin {
      name = "vim-mark";
      src = pkgs.fetchFromGitHub {
        owner = "inkarkat";
        repo = "vim-mark";
        rev = "7f90d80d0d7a0b3696f4dfa0f8639bba4906d037";
        sha256 = "0n8r0ks58ixqv7y1afliabiqwi55nxsslwls7hni4583w1v1bbly";
      };
    };
    config = ''
      " clear highlight created by vim-mark
      nnoremap &lt;leader&gt;&lt;F3&gt; :MarkClear&lt;CR&gt;
      " show all marks
      nnoremap &lt;leader&gt;M :Marks&lt;CR&gt;
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-vim-mark
      vim-ingo-library
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vim-markdown-md-support"><a class="header" href="#vim-markdown-md-support">vim-markdown: md support</a></h1>
<p>我主要使用这个插件的对齐表格的功能，<code>:TableFormat</code>，超酷炫！</p>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-vim-markdown = {
    plugin = pkgs.vimPlugins.vim-markdown;
    config = ''
      let g:vim_markdown_new_list_item_indent = 2
      let g:vim_markdown_no_default_key_mappings = 1
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-vim-markdown # format table
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vista-vim-lsp-symbols"><a class="header" href="#vista-vim-lsp-symbols">vista-vim: lsp symbols</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-vista-vim = {
    plugin = pkgs.vimPlugins.vista-vim;
    config = ''
      let g:vista_default_executive = 'nvim_lsp'
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-vista-vim
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="winshift-nvim-rearrange-windows"><a class="header" href="#winshift-nvim-rearrange-windows">winshift-nvim: rearrange windows</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-winshift-nvim = {
    plugin = pkgs.vimPlugins.winshift-nvim;
    type = "lua";
    config = ''
      -- Lua
      require("winshift").setup({
        highlight_moving_win = true,  -- Highlight the window being moved
        focused_hl_group = "Visual",  -- The highlight group used for the moving window
        -- moving_win_options = {
        --   -- These are local options applied to the moving window while it's
        --   -- being moved. They are unset when you leave Win-Move mode.
        --   wrap = true,
        --   cursorline = false,
        --   cursorcolumn = false,
        --   colorcolumn = "",
        -- },
        keymaps = {
          disable_defaults = false, -- Disable the default keymaps
          win_move_mode = {
            ["h"] = "left",
            ["j"] = "down",
            ["k"] = "up",
            ["l"] = "right",
            ["H"] = "far_left",
            ["J"] = "far_down",
            ["K"] = "far_up",
            ["L"] = "far_right",
            ["&lt;left&gt;"] = "left",
            ["&lt;down&gt;"] = "down",
            ["&lt;up&gt;"] = "up",
            ["&lt;right&gt;"] = "right",
            ["&lt;S-left&gt;"] = "far_left",
            ["&lt;S-down&gt;"] = "far_down",
            ["&lt;S-up&gt;"] = "far_up",
            ["&lt;S-right&gt;"] = "far_right",
          },
        },
        ---A function that should prompt the user to select a window.
        ---
        ---The window picker is used to select a window while swapping windows with
        ---`:WinShift swap`.
        ---@return integer? winid # Either the selected window ID, or `nil` to
        ---   indicate that the user cancelled / gave an invalid selection.
        window_picker = function()
          return require("winshift.lib").pick_window({
            -- A string of chars used as identifiers by the window picker.
            picker_chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890",
            filter_rules = {
              -- This table allows you to indicate to the window picker that a window
              -- should be ignored if its buffer matches any of the following criteria.
              cur_win = true, -- Filter out the current window
              floats = true,  -- Filter out floating windows
              filetype = {},  -- List of ignored file types
              buftype = {},   -- List of ignored buftypes
              bufname = {},   -- List of vim regex patterns matching ignored buffer names
            },
            ---A function used to filter the list of selectable windows.
            ---@param winids integer[] # The list of selectable window IDs.
            ---@return integer[] filtered # The filtered list of window IDs.
            filter_func = nil,
          })
        end,
      })

      vim.keymap.set('n', '&lt;C-W&gt;m', '&lt;Cmd&gt;WinShift&lt;CR&gt;')
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-winshift-nvim
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  opt = import ../opt.nix;
  xelfviewer = pkgs.callPackage ./gui/xelfviewer.nix {};
in
{
  imports = [
    ./gui/mime.nix
    ./gui/kdeconnect.nix
    ./gui/xdot.nix
    ./gui/firefox.nix
  ] ++ (lib.optionals (builtins.currentSystem=="x86_64-linux") [
    ./gui/rustdesk.nix
  ]) ++ (if !opt.isWSL2 then [
    ./gui/gnome.nix
    ./gui/terminal.nix
    ./gui/singleton_web_apps.nix
    ./gui/rofi.nix
  ] else [{ # install fonts for WSL
    fonts.fontconfig.enable = true;
    home.packages = with pkgs; [
      noto-fonts-cjk-sans
      noto-fonts-cjk-serif
      noto-fonts-emoji
    ];
  }]);

  home.packages = with pkgs; [
    libnotify
    # browser
  ] ++ pkgs.lib.optionals (builtins.currentSystem=="x86_64-linux") [
    google-chrome
    microsoft-edge
  ] ++ [
    # network
  ] ++ pkgs.lib.optionals (builtins.currentSystem=="x86_64-linux") [
    feishu
    (wechat-uos.override {
      buildFHSEnv = args: buildFHSEnv (args // {
        # bubble wrap wechat-uos's home directory
        extraBwrapArgs = [
          "--bind ${config.home.homeDirectory}/.local/share/wechat-uos /home"
          "--chdir /home"
        ];
      });
    })
    # wine weixin waste too much memory, more than 4GB!!!
    #(import ./gui/weixin.nix {})
    nur.repos.linyinfeng.wemeet
    nur.repos.xddxdd.dingtalk
    # telegram desktop not provide aarch64 prebuilt
    tdesktop
  ] ++ [
    transmission_4-gtk
    # text
    #wpsoffice
    libreoffice
    meld
    # TODO: use this after switching to wayland
    #wl-clipboard
    textsnatcher
    # draw
    drawio
    #aseprite-unfree
    inkscape
    gimp
    # viewer
  ] ++ pkgs.lib.optionals (builtins.currentSystem=="x86_64-linux") [
    imhex
    xelfviewer
  ] ++ [
    vlc
  ] ++ pkgs.lib.optionals (builtins.currentSystem=="x86_64-linux") [
    ghidra
  ] ++ [
    # management
  ] ++ pkgs.lib.optionals (builtins.currentSystem=="x86_64-linux") [
    zotero
  ] ++ [
    barrier
    keepassxc
    # entertainment
    antimicrox
  ];

  xdg.mime.types = {
    drawio = {
      name = "draw-io";
      type = "text/draw-io";
      pattern = "*.drawio";
      defaultApp = "drawio.desktop";
    };
  };

  home.file.autostart_barrier = {
    source = "${pkgs.barrier}/share/applications/barrier.desktop";
    target = ".config/autostart/barrier.desktop";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><div style="text-align:right; font-size:3em;">2022.05.11</div>
<h1 id="安装deb包以飞书为例"><a class="header" href="#安装deb包以飞书为例">安装deb包，以飞书为例</a></h1>
<p><strong>太长不看</strong></p>
<ul>
<li>nix文件: https://github.com/xieby1/nix_config/blob/main/usr/gui/feishu.nix</li>
<li>使用方法:
<pre><code class="language-nix">home.packages = with pkgs; [
  (callPackage ./feishu.nix {})
];
</code></pre>
</li>
</ul>
<p>参考nixpkgs/pkgs/applications/networking/instant-messengers/skypeforlinux/default.nix</p>
<h2 id="测试环境"><a class="header" href="#测试环境">测试环境</a></h2>
<p>nix-build -E "with import <nixpkgs> {}; callPackage ./default.nix {}"</p>
<h2 id="权限问题"><a class="header" href="#权限问题">权限问题</a></h2>
<p>nix-build遇到dpkg -x解压失败。
但是手动执行dpkg -x一切正常。</p>
<p>https://unix.stackexchange.com/questions/138188/easily-unpack-deb-edit-postinst-and-repack-deb</p>
<p>确认是权限问题的实验</p>
<p>是s权限的问题。
nix-build下不能添加s权限。
原因未知</p>
<p>复现方法</p>
<pre><code class="language-bash">touch $out/miao
chmox +s $out/miao
ls -l $out/miao
</code></pre>
<p>解决方法，使用fakeroot.</p>
<h2 id="补全库"><a class="header" href="#补全库">补全库</a></h2>
<p>使用ldd脚本，获取所有elf所需的库，挨个添加进rpath即可。</p>
<h2 id="桌面"><a class="header" href="#桌面">桌面</a></h2>
<p>application/<em>.desktop
menu/</em>.menu // 负责图标</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
{
  programs.firefox = {
    enable = true;
    # If state version ≥ 19.09 then this should be a wrapped Firefox
    package = pkgs.firefox.overrideAttrs (old: {
      desktopItem = old.desktopItem.override {
        exec = "env MOZ_USE_XINPUT2=1 firefox --name firefox %U";
      };
    });
    profiles.xieby1 = {
      # id is default 0, thus this profile is default
      extensions = with pkgs.nur.repos.rycee.firefox-addons; [
        # 😾😾😾 Chinese users cannot use ad block extensions
        # https://discourse.mozilla.org/t/chinese-users-cant-use-ad-blocker-extensions/94823
        ublock-origin
      ];
      settings = {
        # Automatically enable extensions
        "extensions.autoDisableScopes" = 0;
      };
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gnome-in-nixos"><a class="header" href="#gnome-in-nixos">Gnome in NixOS</a></h1>
<h2 id="插件"><a class="header" href="#插件">插件</a></h2>
<h2 id="桌面快捷键"><a class="header" href="#桌面快捷键">桌面快捷键</a></h2>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
# gnome extensions and settings
# no need log out to reload extension: &lt;alt&gt;+F2 r
let
  opt = import ../../opt.nix;
in{
  home.packages = (with pkgs; [
    gnome-sound-recorder
    dconf-editor
    devhelp
  ])
  ++ (with pkgs.gnomeExtensions; [
    unite
    clipboard-indicator
    bing-wallpaper-changer
    # random-wallpaper-wip-v3
    gtile
    pkgs.pkgsu.gnomeExtensions.hide-top-bar
    dash-to-dock
    always-show-titles-in-overview
    customize-ibus
    # replace system-monitor(-next) with vitals
    # refers to https://github.com/mgalgs/gnome-shell-system-monitor-applet/issues/57
    # vitals
    system-monitor-next
  ]);

  # Setting: `gsettings set &lt;key(dot)&gt; &lt;value&gt;`
  # Getting: `dconf dump /&lt;key(path)&gt;`
  dconf.settings = {
    "org/gnome/shell" = {
      disable-extension-version-validation = true;
      ## enabled gnome extensions
      disable-user-extensions = false;
      disabled-extensions = [];
      enabled-extensions = [
        "BingWallpaper@ineffable-gmail.com"
        "clipboard-indicator@tudmotu.com"
        "gTile@vibou"
        "hidetopbar@mathieu.bidon.ca"
        # "Vitals@CoreCoding.com"
        "system-monitor-next@paradoxxx.zero.gmail.com"
        "unite@hardpixel.eu"
        "dash-to-dock@micxgx.gmail.com"
        # "randomwallpaper@iflow.space"
        "Always-Show-Titles-In-Overview@gmail.com"
        "customize-ibus@hollowman.ml"
      ];

      ## dock icons
      favorite-apps = [
        "org.gnome.Nautilus.desktop"
        "firefox.desktop"
        "microsoft-edge.desktop"
        "calendar.desktop"
        "todo.desktop"
        "google-chrome.desktop"
        ];
    };
    ## extensions settings
    # "org/gnome/shell/extensions/vitals" = {
    #   fixed-widths = true;
    #   hide-icons = true;
    #   hot-sensors = [
    #     "_processor_usage_"
    #     "_memory_usage_"
    #     "__network-rx_max__"
    #     "__network-tx_max__"
    #   ];
    #   show-fan = false;
    #   show-system = false;
    #   show-temperature = false;
    #   show-voltage = false;
    #   update-time = 2;
    # };
    "org/gnome/shell/extensions/system-monitor" = {
      compact-display = true;
      icon-display = false;
      cpu-style = "digit";
      memory-style = "digit";
      net-style = "digit";
    };
    "org/gnome/shell/extensions/gtile" = {
      animation=true;
      global-presets=true;
      grid-sizes="6x4,8x6";
      preset-resize-1=["&lt;Super&gt;bracketleft"];
      preset-resize-2=["&lt;Super&gt;bracketright"];
      preset-resize-3=["&lt;Super&gt;period"];
      preset-resize-4=["&lt;Super&gt;slash"];
      preset-resize-5=["&lt;Super&gt;apostrophe"];
      preset-resize-6=["&lt;Super&gt;semicolon"];
      preset-resize-7=["&lt;Super&gt;comma"];
      resize1="2x2 1:1 1:1";
      resize2="2x2 2:1 2:1";
      resize3="2x2 1:2 1:2";
      resize4="2x2 2:2 2:2";
      resize5="4x8 2:2 3:7";
      resize6="1x2 1:1 1:1";
      resize7="1x2 1:2 1:2";
      show-icon=false;
    };

    "org/gnome/desktop/session" = {
      idle-delay=lib.hm.gvariant.mkUint32 0; # never turn off screen
    };
    "org/gnome/settings-daemon/plugins/power" = {
      ambient-enabled=false;
      idle-dim=false;
      power-button-action="nothing";
      sleep-inactive-ac-timeout=3600;
      sleep-inactive-ac-type="nothing";
      sleep-inactive-battery-type="suspend";
    };
    "org/gnome/shell/extensions/hidetopbar" = {
      mouse-sensitive = true;
      enable-active-window=false;
      enable-intellihide=true;
      shortcut-delay = 0.0;
      shortcut-keybind = ["&lt;Super&gt;h"];
    };
    "org/gnome/shell/extensions/unite" = {
      app-menu-ellipsize-mode="end";
      extend-left-box=false;
      greyscale-tray-icons=false;
      hide-app-menu-icon=false;
      hide-dropdown-arrows=true;
      hide-window-titlebars="always";
      notifications-position="center";
      reduce-panel-spacing=true;
      show-window-buttons="always";
      use-activities-text = false;
      window-buttons-placement="last";
      window-buttons-theme="materia";
      restrict-to-primary-screen=false;
    };
    "org/gnome/shell/extensions/bingwallpaper" = {
      market="zh-CN";
      delete-previous=true;
      download-folder="/tmp/pictures";
    };
    "org/gnome/shell/extensions/dash-to-dock" = {
      click-action="focus-or-appspread";
    };
    "org/gnome/shell/extensions/space-iflow-randomwallpaper" = {
      auto-fetch = true;
      change-lock-screen = true;
      hours = 8;
      minutes = 29;
      source = "genericJSON";
      # source = "wallhaven";
    };
    "org/gnome/shell/extensions/space-iflow-randomwallpaper/genericJSON" = {
      generic-json-request-url = "http://www.bing.com/HPImageArchive.aspx?format=js&amp;idx=0&amp;n=1&amp;mkt=zh-CN";
      generic-json-response-path = "$.images[0].url";
      generic-json-url-prefix = "http://www.bing.com";
    };
    "org/gnome/shell/extensions/space-iflow-randomwallpaper/wallhaven" ={
      wallhaven-keyword="cardcaptor sakura";
    };


    # predefined keyboard shortcuts
    "org/gnome/desktop/wm/keybindings" = {
      switch-applications=[];
      switch-applications-backward=[];
      switch-windows=["&lt;Alt&gt;Tab"];
      switch-windows-backward=["&lt;Shift&gt;&lt;Alt&gt;Tab"];
      maximize=["&lt;Super&gt;Up"];
      unmaximize=["&lt;Super&gt;Down"];
      minimize=[];
      move-to-workspace-left=["&lt;Control&gt;Home"];
      move-to-workspace-right=["&lt;Control&gt;End"];
    };
    "org/gnome/shell/extensions/clipboard-indicator" =
    {
      move-item-first=true;
    };

    # nautilus
    "org/gtk/settings/file-chooser" = {
      sort-directories-first=true;
    };

    "org/gnome/desktop/interface" = {
      enable-hot-corners=false;
      show-battery-percentage=true;
      switch-input-source=["&lt;Control&gt;space"];
      switch-input-source-backward=["&lt;Shift&gt;&lt;Control&gt;space"];
    };

    # proxy
    "system/proxy" = {mode = "manual";};
    "system/proxy/ftp" = {host="127.0.0.1"; port=opt.proxyPort;};
    "system/proxy/http" = {host="127.0.0.1"; port=opt.proxyPort;};
    "system/proxy/https" = {host="127.0.0.1"; port=opt.proxyPort;};

    # input method
    "org/gnome/desktop/input-sources" = {
      sources = with lib.hm.gvariant; mkArray
      "(${lib.concatStrings [type.string type.string]})" [
        (mkTuple ["xkb"  "us"])
        (mkTuple ["ibus" "rime"])
        (mkTuple ["ibus" "mozc-jp"])
        (mkTuple ["ibus" "hangul"])
      ];
    };
    "org/gnome/shell/extensions/customize-ibus" = {
      candidate-orientation = lib.hm.gvariant.mkUint32 1;
      custom-font="Iosevka Nerd Font 16";
      enable-orientation=true;
      input-indicator-only-on-toggle=false;
      input-indicator-only-use-ascii=false;
      use-custom-font=true;
      use-indicator-show-delay=true;
    };
    "org/gnome/mutter" = {
      dynamic-workspaces = true;
    };
  };

  # inspired by https://discourse.nixos.org/t/how-to-set-the-bookmarks-in-nautilus/36143
  home.activation.nautilus_bookmarks = lib.hm.dag.entryAfter [ "writeBoundary" ] ''
    # WSL2 may not have folder ~/.config/gtk-3.0
    $DRY_RUN_CMD mkdir -p $VERBOSE_ARG ~/.config/gtk-3.0
    $DRY_RUN_CMD ln -sf $VERBOSE_ARG ~/Gist/Config/nautilus_bookmarks ~/.config/gtk-3.0/bookmarks
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kde-connect"><a class="header" href="#kde-connect">KDE Connect</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  mykdeconnect = pkgs.plasma5Packages.kdeconnect-kde;
</code></pre>
<p>This customized version of KDE Connect allow share PC's keyboard smoothly to android.</p>
<pre><code class="language-nix">  #mykdeconnect = pkgs.kdeconnect.overrideAttrs (old: {
  #  patches = [( pkgs.fetchpatch {
  #    url = "https://raw.githubusercontent.com/xieby1/kdeconnect-kde-enhanced/4610431b932b2fab05d7e0fc55e7306dc7ff0910/diff.patch";
  #    hash = "sha256-NL/TVOMEhdJ/W7UTxjF7Qjnq7JciNvl08BC1wrBfvHo=";
  #  })];
  #  # cmakeFlags = "-DCMAKE_BUILD_TYPE=Debug -DQT_FORCE_STDERR_LOGGING=1";
  #});
in {
  home.packages = [
    mykdeconnect
  ];
</code></pre>
<p>Auto startup KDE Connect after Gnome GUI login.</p>
<pre><code class="language-nix">  home.file.kde_connect_indicator = {
    source = "${mykdeconnect}/share/applications/org.kde.kdeconnect.nonplasma.desktop";
    target = ".config/autostart/org.kde.kdeconnect.nonplasma.desktop";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># https://nixos.org/manual/nixos/stable/#sec-writing-modules
# refers to syncthing module

# list options:
#   home-manager option xdg.mime.types.\"*\"
#   nixos option
{ config
, lib
, pkgs
, ...
}:
with lib;
let
  cfg = config.xdg.mime.types;
in
{
  options = {
    xdg.mime.types = mkOption {
      default = {};
      description = "Set MIME types and default applications.";
      example = ''
        xdg.mime.types.dot = {
          name = "graphviz-dot";
          type = "text/graphviz-dot";
          pattern = "*.dot";
          defaultApp = "xdot.desktop";
        };
      '';
      type = types.attrsOf (types.submodule ({name, ...}:
      {
        options = {
          name = mkOption {
            type = types.str;
            default = name;
            description = "The name of the xml file.";
          };
          type = mkOption {
            type = types.str;
            default = "";
            description = "The mime-type.";
          };
          pattern = mkOption {
            type = types.str;
            default = "";
            description = "The glob pattern.";
          };
          defaultApp = mkOption {
            type = types.str;
            default = "";
            description = "Default application for opening this MIME type.";
          };
        };
      }));
    };
  };

  # builtins.mapAttrs (n: v: {wang=v.miao;}) {file1={miao=1;}; file2={miao=2;};}
  # =&gt; {file1={wang=1;}; file2={wang=2;};}
  config = {
    home.file = builtins.mapAttrs (n: v: {
      text = ''
        &lt;?xml version="1.0"?&gt;
        &lt;mime-info xmlns='http://www.freedesktop.org/standards/shared-mime-info'&gt;
          &lt;mime-type type="${v.type}"&gt;
            &lt;glob pattern="${v.pattern}"/&gt;
          &lt;/mime-type&gt;
        &lt;/mime-info&gt;
      '';
      target = ".local/share/mime-types/${v.name}.xml";
      onChange = ''
        ${pkgs.xdg-utils}/bin/xdg-mime install ~/.local/share/mime-types/${v.name}.xml
        ${pkgs.xdg-utils}/bin/xdg-mime default ${v.defaultApp} ${v.type}
      '';
    }) cfg;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-rofi = pkgs.rofi.override {
    plugins = with pkgs; [
      # rofi-file-browser
    ];
  };
in
{
  home.packages = with pkgs; [
    my-rofi
  ];

  # gnome keyboard shortcuts
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys".custom-keybindings = [
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/rofi_window/"
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/rofi_x/"
  ];
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/rofi_window" = {
    binding="&lt;Super&gt;w";
    command="rofi -show window";
    name="rofi window";
  };
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/rofi_x" = let
    x = pkgs.writeScript "x" ''
      cd ${config.home.homeDirectory}/Gist/script/bash/
      xdotool type --clearmodifiers --delay 30 \
        "$(ls --color=never x-* | rofi -dmenu | xargs bash -c)"
    '';
  in {
    binding="&lt;Super&gt;x";
    command="${x}";
    name="rofi x";
  };

  home.file.rofi_config = {
    target = ".config/rofi/config.rasi";
    text = ''
      /* This is a comment */
      /* rofi -dump-config */

      configuration {
        modes: [
          window,
          drun,
          run,
          ssh
          /* file-browser-extended */
        ];
        terminal: "kitty";
        dpi: 1;
        show-icons: true;
      }
      filebrowser {
        directory: "~/Documents";
      }

      /* man rofi-theme */

      window {
        width: 80%;
      }
    '';
  };

  # home.file.rofi_file_browser_config = let
  #   openDir = pkgs.writeScript "openDir" ''
  #     if [[ -d "$1" ]]; then
  #       xdg-open "$1"
  #     elif [[ -f "$1" ]]; then
  #       xdg-open "''${1%/*}"
  #     fi
  #   '';
  # in {
  #   target = ".config/rofi/file-browser";
  #   text = ''
  #     # This is a comment
  #     dir ~/Documents
  #     depth 0
  #     no-sort-by-type
  #     sort-by-depth

  #     # BUG: rofi -show-icons causes segmentation fault
  #     # oc-search-path
  #     # oc-cmd "nautilus"
  #     # oc-cmd "${openDir}"
  #   '';
  # };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rustdesk-the-remote-desktop-app"><a class="header" href="#rustdesk-the-remote-desktop-app">rustdesk, the remote desktop app</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
{
  home.packages = [
</code></pre>
<p>The new version of rustdesk is rustdesk-flutter,
which is cached in offical nix binary cache.</p>
<pre><code class="language-nix">    pkgs.rustdesk-flutter
  ];
</code></pre>
<p>Auto startup rustdesk after Gnome GUI login.</p>
<pre><code class="language-nix">  home.file.autostart_rustdesk_desktop = {
    source = "${pkgs.rustdesk-flutter}/share/applications/rustdesk.desktop";
    target = ".config/autostart/rustdesk.desktop";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, lib, ... }:
let
  # You Can Change To Chrome-Like Browser Here!
  chromeLikeBrowser = if (lib.meta.availableOn builtins.currentSystem pkgs.microsoft-edge.meta.platforms)
    then "${pkgs.microsoft-edge}/bin/microsoft-edge"
    else "${pkgs.chromium}/bin/chromium";

  singleton = pkgs.writeShellScriptBin "singleton.sh" ''
    if [[ $# -lt 2 || $1 == "-h" ]]
    then
      echo "Usage: ''${0##*/} &lt;window&gt; &lt;command and its args&gt;"
      echo "  Only start a app once, if the app is running"
      echo "  then bring it to foreground"
      exit 0
    fi

    if [[ "$1" == "kdeconnect.app" ]]
    then
      WID=$(${pkgs.xdotool}/bin/xdotool search --classname "$1")
    else
      WID=$(${pkgs.xdotool}/bin/xdotool search --onlyvisible --name "$1")
    fi

    if [[ -z $WID ]]
    then
      eval "''${@:2}"
    else
      for WIN in $WID
      do
        CURDESK=$(${pkgs.xdotool}/bin/xdotool get_desktop)
        ${pkgs.xdotool}/bin/xdotool set_desktop_for_window $WIN $CURDESK
        ${pkgs.xdotool}/bin/xdotool windowactivate $WIN
      done
    fi
  '';
  singleton_sh = "${singleton}/bin/singleton.sh";

  webapp_common = ''
    if [[ $# -lt 2 || "$1" == "-h" ]]
    then
      echo "Usage: ''${0##*/} &lt;window&gt; &lt;url&gt;"
      echo "  Only start a webapp once, if the app is running"
      echo "  then bring it to foreground"
      exit 0
    fi

    # check URL prefix
    URL=$2
    if [[ "$URL" =~ ^~ ]]
    then
      URL="file://$HOME/''${URL#\~/}"
    fi
    if [[ "$URL" =~ ^\/ ]]
    then
      URL="file://$URL"
    fi
    if [[ "$URL" =~ ^(file|https?)?:\/\/ ]]
    then
      true
    else
      URL="https://$URL"
    fi
  '';
  webapp = pkgs.writeShellScriptBin "webapp.sh" ''
    ${webapp_common}
    ${singleton_sh} "$1" ${chromeLikeBrowser} --app="$URL"
  '';
  webapp_no_cors = pkgs.writeShellScriptBin "webapp_no_cors.sh" ''
    ${webapp_common}
    ${singleton_sh} "$1" ${chromeLikeBrowser} --user-data-dir=~/.chrome_no_cors --disable-web-security --app="$URL"
  '';
  webapp_sh = "${webapp}/bin/webapp.sh";
  webapp_no_cors_sh = "${webapp_no_cors}/bin/webapp_no_cors.sh";
  open_my_cheatsheet_md_sh = pkgs.writeShellScript "open_my_cheatsheet_md" ''
     cd ${config.home.homeDirectory}/Documents/Tech
     kitty nvim my_cheatsheet.mkd -c Vista
     make
  '';
in
{
  home.packages = [singleton webapp webapp_no_cors];

  # gnome keyboard shortcuts
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys".custom-keybindings = [
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/my_cheatsheet_html/"
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/my_cheatsheet_md/"
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/bing_dict/"
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/hjxd_jp/"
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/kdeconnect_app/"
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/devdocs/"
  ];
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/my_cheatsheet_html" = {
    binding="&lt;Alt&gt;space";
    command="gtk-launch my_cheatsheet_html.desktop";
    name="cheatsheet";
  };
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/my_cheatsheet_md" = {
    binding="&lt;Alt&gt;c";
    command="gtk-launch my_cheatsheet_md.desktop";
    name="edit cheatsheet";
  };
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/bing_dict" = {
    binding="&lt;Alt&gt;b";
    command="gtk-launch bing_dict.desktop";
    name="bing dict";
  };
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/hjxd_jp" = {
    binding="&lt;Alt&gt;j";
    command="gtk-launch hjxd_jp.desktop";
    name="日语词典";
  };
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/kdeconnect_app" = {
    binding="&lt;Alt&gt;k";
    command="gtk-launch kdeconnect_app.desktop";
    name="KDE Connect";
  };
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/devdocs" = {
    binding="&lt;Alt&gt;d";
    command="gtk-launch devdocs.desktop";
    name="Devdocs";
  };

  xdg.desktopEntries = {
    # web apps
    ## microsoft's
    todo = {
      name = "Microsoft To Do";
      genericName = "ToDo";
      exec = "${webapp_sh} \"To Do\" https://to-do.live.com/";
      icon = builtins.fetchurl {
        url = "http://www.google.com/s2/favicons?domain=https://to-do.live.com&amp;sz=128";
        name = "ToDo.png";
      };
    };
    calendar = {
      name = "Microsoft Calendar";
      exec = "${webapp_sh} Outlook https://outlook.live.com/calendar";
      icon = (pkgs.fetchurl {
        url = "https://cdn.cdnlogo.com/logos/o/82/outlook.svg";
        sha256 = "0544z9vmghp4lgapl00n99vksm0gq8dfwrp7rvfpp44njnh6b6dz";
      }).outPath;
    };
    outlook = {
      name = "Microsoft Outlook";
      exec = "${webapp_sh} Outlook https://outlook.live.com";
      icon = (pkgs.fetchurl {
        url = "https://cdn.cdnlogo.com/logos/o/82/outlook.svg";
        sha256 = "0544z9vmghp4lgapl00n99vksm0gq8dfwrp7rvfpp44njnh6b6dz";
      }).outPath;
    };
    word = {
      name = "Word";
      genericName = "office";
      exec = "${webapp_sh} Word https://www.office.com/launch/word";
      icon = (pkgs.fetchurl {
        url = "https://cdn.cdnlogo.com/logos/w/19/word.svg";
        sha256 = "1ig0d8afacfl7m1n0brx82iw8c2iif3skb8dwjly4fzxikzvfmn4";
      }).outPath;
    };
    excel = {
      name = "Excel";
      genericName = "office";
      exec = "${webapp_sh} Excel https://www.office.com/launch/excel";
      icon = (pkgs.fetchurl {
        url = "https://cdn.cdnlogo.com/logos/m/96/microsoft-excel.png";
        sha256 = "07ch9kb3s82m47mm414gvig6zg2h4yffmvjvg7bvr7sil8476cs8";
      }).outPath;
    };
    powerpoint = {
      name = "PowerPoint";
      genericName = "office ppt";
      exec = "${webapp_sh} PowerPoint https://www.office.com/launch/powerpoint";
      icon = (pkgs.fetchurl {
        url = "https://cdn.cdnlogo.com/logos/p/67/powerpoint.svg";
        sha256 = "1pnb2nna2b26kyn0i92xmgdpcrqhw1cpl3vv7vvvlsxrldndhclr";
      }).outPath;
    };
    onedrive = {
      name = "OneDrive";
      exec = "${webapp_sh} OneDrive https://onedrive.live.com";
      icon = (pkgs.fetchurl {
        url = "https://cdn.cdnlogo.com/logos/m/73/microsoft-onedrive.svg";
        sha256 = "10sjz81xjcqfkd7v11vhpvdp0s2a8la9wipc3aapgybg822vhjck";
      }).outPath;
    };
    ## others
    suishouji = {
      name = "随手记";
      genericName = "suishouji";
      exec = "${webapp_sh} 随手记 https://www.sui.com/";
      icon = (pkgs.fetchurl {
        url = "https://res.sui.com/favicon.ico";
        sha256 = "01vm275n169r0ly8ywgq0shgk8lrzg79d1aarshwybwxwffj4q0q";
      }).outPath;
    };
    webweixin = {
      name = "网页微信";
      genericName = "weixin";
      exec = ''${webapp_sh} "微信|weixin" https://wx.qq.com/'';
      icon = (pkgs.fetchurl {
        url = "https://cdn.cdnlogo.com/logos/w/79/wechat.svg";
        sha256 = "1xk1dsia6favc3p1rnmcncasjqb1ji4vkmlajgbks0i3xf60lskw";
      }).outPath;
    };
    my_cheatsheet_html = {
      name = "Cheatsheet HTML";
      genericName = "cheatsheet";
      exec = ''${webapp_sh} "markdown cheatsheet" ${config.home.homeDirectory}/Documents/Tech/my_cheatsheet.html'';
    };
    bing_dict = {
      name = "Bing Dict";
      genericName = "dictionary";
      exec = ''${webapp_sh} "搜索 词典" https://cn.bing.com/dict/'';
    };
    hjxd_jp = {
      name = "日语词典";
      genericName = "riyucidian";
      exec = "${webapp_sh} 日语词典 https://dict.hjenglish.com/jp/";
    };
    devdocs = {
      name = "DevDocs";
      genericName = "devdocs";
      exec = "${webapp_sh} DevDocs https://devdocs.io/";
      icon = (pkgs.fetchurl {
        url = "https://devdocs.io/images/webapp-icon-512.png";
        sha256 = "0bbimjp8r4fwzgd094wady2ady1fqz0crnyy2iwa835g7yivix24";
      }).outPath;
    };
    clash = let
      metacubexd = builtins.fetchTarball "https://github.com/MetaCubeX/metacubexd/archive/gh-pages.zip";
    in {
      name = "clash";
      exec = "${webapp_no_cors_sh} metacubexd file://${metacubexd}/index.html";
      icon = "${metacubexd}/pwa-192x192.png";
    };

    # singleton apps
    my_cheatsheet_md = {
      name = "Cheatsheet MD";
      genericName = "cheatsheet";
      exec = "${singleton_sh} my_cheatsheet.mkd ${open_my_cheatsheet_md_sh}";
    };
    kdeconnect_app = {
      name = "(S) KDE Connect App";
      genericName = "kdeconnect";
      exec = "${singleton_sh} kdeconnect.app kdeconnect-app";
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
{
  # Terminal Comparsion
  # * gnome-terminal
  #   * Pros
  #   * Cons
  #     * Wrong window size, when window is tiled (e.g. use gTile)
  #     * Icon display incorrectly (e.g. Vim-vista)
  #     * It's hard to hide top bar
  # * alacritty
  #   * Pros
  #     * Esay configurable
  #     * Icon display correctly (e.g. Vim-vista)
  #     * input method fcitx works
  #   * Cons
  #     * Not native tab support
  #       https://github.com/alacritty/alacritty/issues/3129
  #       The developer(s?) with poor attitude
  #       * Compromise: tabbed
  #     * Alacritty is not work with espanso
  #       https://github.com/federico-terzi/espanso/issues/787
  #       https://github.com/federico-terzi/espanso/issues/1088
  #       In espanso auto mode, alacritty definitely will be stucked.
  #       In clipboard, alacritty may be stucked.
  #     * emoji display poorly.
  # * kitty
  #   * Pros
  #     * Esay configurable
  #   * Cons
  #     * Icon display incorrectly (e.g. Vim-vista)
  #     * input method support solved by fcitx5
  # * hyper
  #   * Cons
  #     * scroll speed is too fast!

  # shortcuts
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys".custom-keybindings = [
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/kitty/"
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/fzf-doc/"
  ];
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/kitty" = {
    binding="&lt;Primary&gt;&lt;Alt&gt;t";
    command = "kitty";
    name="terminal";
  };
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/fzf-doc" = {
    binding="&lt;Super&gt;f";
    # bash alias needs interative bash (-i)
    # https://askubuntu.com/questions/1109564/alias-not-working-inside-bash-shell-script
    command="kitty bash -i fzf-doc";
    name="fzf-doc";
  };

  programs.kitty = {
    enable = true;
    environment = {
      "TERM" = "xterm";
    };
    font = {
      name = "";
      size = 16;
    };
    settings = {
      cursor_blink_interval = "0.8";
      remember_window_size = "no";
      initial_window_width = "80c";
      initial_window_height = "20c";

      # tab
      tab_bar_edge = "top";
      tab_bar_style = "separator";
      active_tab_foreground   = "#e2e2e3";
      active_tab_background   = "#2c2e34";
      active_tab_title_template = "🐱{fmt.fg.red}{bell_symbol}{activity_symbol}{fmt.fg.tab}{title}";
      inactive_tab_foreground = "#2c2e34";
      inactive_tab_background = "#e2e2e3";

      # tango dark
      background              = "#2c2e34";
      foreground              = "#e2e2e3";
      cursor                  = "#e2e2e3";
      color0                  = "#2c2e34";
      color8                  = "#555753";
      color1                  = "#cc0000";
      color9                  = "#ef2929";
      color2                  = "#4e9a06";
      color10                 = "#8ae234";
      color3                  = "#c4a000";
      color11                 = "#fce94f";
      color4                  = "#3465a4";
      color12                 = "#729fcf";
      color5                  = "#75507b";
      color13                 = "#ad7fa8";
      color6                  = "#06989a";
      color14                 = "#34e2e2";
      color7                  = "#e2e2e3";
      color15                 = "#eeeeec";
      # selection_foreground    = "#2c2e34";
      # selection_background    = "#e2e2e3";
    };
    extraConfig = ''
      map ctrl+equal change_font_size all +2.0
      map ctrl+plus change_font_size all +2.0
      map ctrl+kp_add change_font_size all +2.0
      map ctrl+minus change_font_size all -2.0
      map ctrl+kp_subtract change_font_size all -2.0
      map ctrl+0 change_font_size all 0

      map alt+1 goto_tab 1
      map alt+2 goto_tab 2
      map alt+3 goto_tab 3
      map alt+4 goto_tab 4
      map alt+5 goto_tab 5
      map alt+6 goto_tab 6
      map alt+7 goto_tab 7
      map alt+8 goto_tab 8
      map alt+9 goto_tab 9
      map alt+0 goto_tab 99

      map ctrl+shift+t new_tab_with_cwd
      map ctrl+shift+n new_os_window_with_cwd
      map ctrl+shift+f launch --location=hsplit --allow-remote-control kitty +kitten search.py @active-kitty-window-id

      # disable opening of URLs with a plain click
      mouse_map left click ungrabbed no_op

      #: moves the window into a new tab
      map f1 detach_window new-tab
      #: asks which tab to move the window into
      map f2 detach_window ask


      action_alias launch_window launch --cwd=current
      # Window layout
      enabled_layouts splits

      # Split and Create a new window
      map f5 launch_window --location=hsplit
      map f6 launch_window --location=vsplit

      # Goto window
      map alt+left neighboring_window left
      map alt+right neighboring_window right
      map alt+up neighboring_window up
      map alt+down neighboring_window down
    '';
  };

  home.file.kitty_search = {
    source = pkgs.fetchurl {
      url = "https://github.com/trygveaa/kitty-kitten-search/raw/0760138fad617c5e4159403cbfce8421ccdfe571/search.py";
      sha256 = "1w50fimqsbmqk9zhdmq8k2v1b36iwsglpbqaavpglw0acam3xid7";
    };
    target = ".config/kitty/search.py";
  };
  home.file.kitty_scrool_mark = {
    source = pkgs.fetchurl {
      url = "https://github.com/trygveaa/kitty-kitten-search/raw/0760138fad617c5e4159403cbfce8421ccdfe571/scroll_mark.py";
      sha256 = "1a1l7sp2x247da8fr54wwq7ffm987wjal9nw2f38q956v3cfknzi";
    };
    target = ".config/kitty/scroll_mark.py";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="typora"><a class="header" href="#typora">Typora</a></h1>
<p>采用nixpkgs支持的最后的typora版本，即0.9.98。</p>
<pre><code class="language-nix">mytypora = (pkgs.callPackage (pkgs.fetchurl {
  url = "https://raw.githubusercontent.com/NixOS/nixpkgs/137f19d1d48b6d7c7901bb86729a2bce3588d4e9/pkgs/applications/editors/typora/default.nix";
  sha256 = "057dk4hl4fljn50098g7l35sh7gwm7zqqqlrczv5lhmpgxi971c1";
}) {}).overrideAttrs (old: {
  src = pkgs.fetchurl {
    url = "https://web.archive.org/web/20211222112532/https://download.typora.io/linux/typora_0.9.98_amd64.deb";
    sha256 = "1srj1fdcblfdsfvdnrqnwsxd3y8qd1h45p4sf1mxn6hr7z2s6ai6";
  };
});
</code></pre>
<p>注：我尝试打包0.11.18，
发现这个版本会检测文件完整性，
因此基本上没办法用nix进行二次打包。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="wayland"><a class="header" href="#wayland">Wayland</a></h1>
<pre><code class="language-nix">virtualisation.waydroid.enable = true;
</code></pre>
<p>尝试使用weston，消息来源参考：</p>
<ul>
<li>https://github.com/waydroid/waydroid/issues/470
<ul>
<li>https://wiki.archlinux.org/title/Waydroid</li>
</ul>
</li>
</ul>
<p>wayland images: <code>/var/lib/waydroid/images/</code></p>
<pre><code class="language-bash">weston --scale=2

# 在weston里
waydroid show-full-ui
</code></pre>
<p>weston快捷键参考<code>man weston-bindings</code></p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs ? import &lt;nixpkgs&gt; {}
, wrapWine ? import ./wrapWine.nix {inherit pkgs;}
}:

let
  name = "weixin";
  installer = builtins.fetchurl "https://dldir1.qq.com/weixin/Windows/WeChatSetup.exe";
  regfile = builtins.toFile "${name}.reg" ''
    Windows Registry Editor Version 5.00

    # [HKEY_LOCAL_MACHINE\System\CurrentControlSet\Hardware Profiles\Current\Software\Fonts]
    # "LogPixels"=dword:000000F0

    [HKEY_CURRENT_USER\Software\Wine\X11 Driver]
    "Decorated"="N"
  '';
  bin = wrapWine {
    inherit name;
    executable = "$WINEPREFIX/drive_c/Program Files/Tencent/WeChat/WeChat.exe";
    tricks = ["riched20" "msls31"];
    setupScript = ''
      LANG="zh_CN.UTF-8"
    '';
    firstrunScript = ''
      # prevent weixin polluting my Documents folder
      rm -f $WINEPREFIX/drive_c/users/$USER/Documents
      mkdir -p $WINEPREFIX/drive_c/users/$USER/Documents

      wine ${installer}

      # 占用磁盘空间持续增加
      # https://github.com/vufa/deepin-wine-wechat-arch/issues/225
      mkdir -p $WINEPREFIX/drive_c/users/xieby1/AppData/Roaming/Tencent/WeChat/xweb/crash/Crashpad/
      touch $WINEPREFIX/drive_c/users/xieby1/AppData/Roaming/Tencent/WeChat/xweb/crash/Crashpad/reports
    '';
    inherit regfile;
  };
  desktop = pkgs.makeDesktopItem {
    inherit name;
    desktopName = "Wine微信";
    genericName = "weixin";
    type = "Application";
    exec = "${bin}/bin/${name}";
    icon = pkgs.fetchurl {
      url = "https://cdn.cdnlogo.com/logos/w/79/wechat.svg";
      sha256 = "1xk1dsia6favc3p1rnmcncasjqb1ji4vkmlajgbks0i3xf60lskw";
    };
  };
in
pkgs.symlinkJoin {
  inherit name;
  paths = [bin desktop];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># based on https://github.com/lucasew/nixcfg/blob/49d44c1a655f1c20d7354ecea942c78704067d50/pkgs/wrapWine.nix
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  inherit (builtins) length concatStringsSep;
  inherit (pkgs) lib cabextract
    writeShellScriptBin symlinkJoin;
  inherit (lib) makeBinPath;
in
{ is64bits ? false
, wine ? if is64bits then pkgs.wineWowPackages.stable else pkgs.wine
, wineFlags ? ""
, executable
, chdir ? null
, name
, tricks ? [ ]
, setupScript ? ""
, firstrunScript ? ""
, home ? ""
, regfile ? null
}:
let
  wineBin = "${wine}/bin/wine${if is64bits then "64" else ""}";
  requiredPackages = [
    wine
    cabextract
  ];
  PATH = makeBinPath requiredPackages;
  NAME = name;
  WINEARCH =
    if is64bits
    then "win64"
    else "win32";
  WINE_NIX = "$HOME/.wine-nix";
  WINEPREFIX = "${WINE_NIX}/${name}";
  setupHook = ''
    ${wine}/bin/wineboot
  '';
  tricksHook =
    if (length tricks) &gt; 0 then
      let
        tricksStr = concatStringsSep " " tricks;
        tricksCmd = ''
          ${pkgs.winetricks}/bin/winetricks ${tricksStr}
        '';
      in
      tricksCmd
    else "";
  run = writeShellScriptBin name ''
    export APP_NAME="${NAME}"
    export WINEARCH=${WINEARCH}
    export WINE_NIX=${WINE_NIX}
    export PATH=$PATH:${PATH}
    export WINEPREFIX="${WINEPREFIX}"
    export EXECUTABLE="${executable}"
    mkdir -p "$WINE_NIX"
    ${setupScript}
    if [ ! -e "$EXECUTABLE" ] # if the executable does not exist
    then
      ${if regfile!=null
        then ''${wineBin} regedit /C ${regfile}''
        else ""
      }
      ${setupHook}
      ${tricksHook}
      ${firstrunScript}
    else # no automatically run after installation!
      ${if chdir != null
        then ''cd "${chdir}"''
        else ""}
      if [ ! "$REPL" == "" ]; # if $REPL is setup then start a shell in the context
      then
        bash
        exit 0
      fi

      ${wineBin} ${wineFlags} "$EXECUTABLE" "$@"
    fi
  '';
  clean = writeShellScriptBin "${name}-clean" ''
    read -p "Are you sure you want to clean ${WINEPREFIX}? &lt;y/N&gt; " prompt
    if [[ $prompt =~ [yY](es)* ]]; then
      rm ${WINEPREFIX} -rf
    fi
  '';
  winecfg = writeShellScriptBin "${name}-cfg" ''
    export WINEARCH=${WINEARCH}
    WINEPREFIX=${WINE_NIX}/${name} winecfg $@
  '';
  _wine = writeShellScriptBin "${name}-wine" ''
    export WINEARCH=${WINEARCH}
    WINEPREFIX=${WINE_NIX}/${name} ${wineBin} $@
  '';
in
symlinkJoin {
  inherit name;
  paths = [run clean winecfg _wine];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="xdot-the-dot-graphviz-viewer"><a class="header" href="#xdot-the-dot-graphviz-viewer">xdot, the dot (graphviz) viewer</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
</code></pre>
<p>Add a xdot.desktop for my xdot.</p>
<pre><code class="language-nix">  myxdot = pkgs.symlinkJoin {
    name = "myxdot";
    paths = [
      pkgs.xdot
      (pkgs.makeDesktopItem {
        name = "xdot";
        desktopName = "xdot";
        exec = "xdot %U";
  })];};
in {
  home.packages = [
    myxdot
  ];
</code></pre>
<p>Open *.dot files with xdot.desktop by default.</p>
<pre><code class="language-nix">  xdg.mime.types.dot = {
    name = "graphviz-dot";
    type = "text/graphviz-dot";
    pattern = "*.dot";
    defaultApp = "xdot.desktop";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{
  lib,
  stdenv,
  fetchurl,
  dpkg,
  qt5
}:
let
  version = "0.05";
  rpath = lib.makeLibraryPath [
    qt5.qtbase
  ] + ":${stdenv.cc.cc.lib}/lib64";
  src =
    if stdenv.hostPlatform.system == "x86_64-linux" then
      fetchurl {
        urls = [
          "https://github.com/horsicq/XELFViewer/releases/download/0.05/xelfviewer_0.05_Ubuntu_22.04_amd64.deb"
        ];
        sha256 = "0l6j0pnpfzwr8205xzis95k4x2la0mfy08bv6hfg32rh3bw906bz";
      }
    else
      throw "xelfviewer is not supported on ${stdenv.hostPlatform.system}";
in
stdenv.mkDerivation {
  pname = "xelfviewer";
  inherit version;

  system = "x86_64-linux";

  inherit src;

  nativeBuildInputs = [ qt5.wrapQtAppsHook ];

  buildInputs = [ dpkg ];

  dontUnpack = true;
  installPhase = ''
    mkdir -p $out
    dpkg-deb -x $src $out
    mv $out/usr/* $out/
    rm -r $out/usr
  '';

  postFixup = ''
    for file in $(find $out -type f \( -perm /0111 -o -name \*.so\* \) ); do
      patchelf --set-interpreter "$(cat $NIX_CC/nix-support/dynamic-linker)" "$file" || true
      patchelf --set-rpath ${rpath}:$out/lib/xelfviewer $file || true
    done
  '';

  meta = with lib; {
    description = "XELFViewer";
    homepage = "https://github.com/horsicq/XELFViewer";
    license = licenses.mit;
    maintainers = with maintainers; [ xieby1 ];
    platforms = [ "x86_64-linux" ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, lib, ...}:

{
  imports = [../../modules/cachix.nix];
  config = lib.mkIf (
    (builtins.pathExists config.cachix_dhall) &amp;&amp;
    (config.cachix_packages != [])
  ) {
    home.activation.cachix_push = lib.hm.dag.entryAfter ["writeBoundary"] config._cachix_push;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nix-on-droidnix"><a class="header" href="#nix-on-droidnix">nix-on-droid.nix</a></h1>
<p><code>nix-on-droid.nix</code>是安卓nix-on-droid的入口配置文件。
因为原生termux并不能直接运行nix，
所以nix-on-droid的作者基于termux使用proot搞出来一个能运行nix的termux分支。</p>
<p>nix-on-droid并未自带很多常用linux命令行工具，
因此<code>nix-on-droid.nix</code>主要负责配置那些在linux常用的，但nix-on-droid没有默认提供的命令行工具。
其他命令行工具的配置则复用home-manager的配置<a href="./home.nix.html"><code>./home.nix</code></a>。
下面是我的带注解的<code>nix-on-droid.nix</code>代码。</p>
<pre><code class="language-nix">{ pkgs, config, ... }:

{
</code></pre>
<p>添加<code>sshd-start</code>命令，用于在安卓上启动sshd服务。
通常安卓上是没有root权限的，无法写/etc/目录的文件，
因此将ssh的tmp目录和配置目录设定到home下面。
这部分内容参考<a href="https://github.com/t184256/nix-on-droid/wiki/SSH-access">nix-on-droid wiki: SSH access</a></p>
<pre><code class="language-nix">  imports = [(let
    sshdTmpDirectory = "${config.user.home}/sshd-tmp";
    sshdDirectory = "${config.user.home}/sshd";
    pathToPubKey = "${config.user.home}/.ssh/id_rsa.pub";
    port = 8022;
    sshd-start = pkgs.writeScriptBin "sshd-start" ''
      #!${pkgs.runtimeShell}

      echo "Starting sshd in non-daemonized way on port ${toString port}"
      ${pkgs.openssh}/bin/sshd -f "${sshdDirectory}/sshd_config" -D
    '';
  in {
    environment.packages = with pkgs; [
      sshd-start
    ];
    build.activation.sshd = ''
      $DRY_RUN_CMD mkdir $VERBOSE_ARG --parents "${config.user.home}/.ssh"
      $DRY_RUN_CMD cat ${pathToPubKey} &gt; "${config.user.home}/.ssh/authorized_keys"

      if [[ ! -d "${sshdDirectory}" ]]; then
        $DRY_RUN_CMD rm $VERBOSE_ARG --recursive --force "${sshdTmpDirectory}"
        $DRY_RUN_CMD mkdir $VERBOSE_ARG --parents "${sshdTmpDirectory}"

        $VERBOSE_ECHO "Generating host keys..."
        $DRY_RUN_CMD ${pkgs.openssh}/bin/ssh-keygen -t rsa -b 4096 -f "${sshdTmpDirectory}/ssh_host_rsa_key" -N ""

        $VERBOSE_ECHO "Writing sshd_config..."
        $DRY_RUN_CMD echo -e "HostKey ${sshdDirectory}/ssh_host_rsa_key\nPort ${toString port}\n" &gt; "${sshdTmpDirectory}/sshd_config"

        $DRY_RUN_CMD mv $VERBOSE_ARG "${sshdTmpDirectory}" "${sshdDirectory}"
      fi
    '';
  }) ({
</code></pre>
<p>自动配置termux。</p>
<pre><code class="language-nix">    build.activation.termux = ''
      DIR=${config.user.home}/.termux
      mkdir -p $DIR
      symlink() {
        if [[ -e $1 &amp;&amp; ! -e $2 ]]; then
          #echo "ln -s $1 $2"
          ln -s $1 $2
        fi
      }
      SRC=${config.user.home}/Gist/Config/termux.properties
      DST=$DIR/termux.properties
      symlink $SRC $DST
      SRC=${config.user.home}/Gist/Config/colors.properties
      DST=$DIR/colors.properties
      symlink $SRC $DST
    '';
  })];

</code></pre>
<p>下面是非常直观的软件安装。</p>
<pre><code class="language-nix">  # Simply install just the packages
  environment.packages = with pkgs; [
    # User-facing stuff that you really really want to have
    vim  # or some other editor, e.g. nano or neovim
    # Some common stuff that people expect to have
    diffutils
    findutils
    utillinux
    tzdata
    hostname
    man
    gnugrep
    gnupg
    gnused
    gnutar
    bzip2
    gzip
    xz
    zip
    unzip
    gawk
    openssh
    nettools
    (lib.setPrio # make bintools less prior
      (busybox.meta.priority + 10)
      busybox
    )
  ];

  # Backup etc files instead of failing to activate generation if a file already exists in /etc
  environment.etcBackupExtension = ".bak";

  # Read the changelog before changing this value
  system.stateVersion = "21.11";

</code></pre>
<p>导入home-manager的配置文件<a href="./home.nix">./home.nix</a>的配置。
如此操作，所有home-manager的软件和配置都能nix-on-droid中复用。</p>
<pre><code class="language-nix">  home-manager.config = import ./home.nix;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>用于自动push包到cachix的模块。
尽管cachix watch-store能自动push，但是我想更细粒度地管理需要push的包，所以有了这个模块。</p>
<pre><code class="language-nix">{ config, pkgs, lib, ...}:

{
  options = {
    cachix_packages = lib.mkOption {
      type = lib.types.listOf lib.types.package;
      default = [];
      description = ''
        This list of packages.

        If the the cachix.dhall file exists and cachix_packages is not empty,
        then the packages in cachix_packages will be pushed to cachix.
      '';
    };
    cachix_dhall = lib.mkOption {
      type = lib.types.str;
      default = "/home/xieby1/Gist/Config/cachix.dhall";
      description = ''
        The path of cachix.dhall.
      '';
    };
    cachix_name = lib.mkOption {
      type = lib.types.str;
      default = "xieby1";
      description = ''
        The cachix name.
      '';
    };
    _cachix_push = lib.mkOption {
      type = lib.types.str;
      default = ''
        echo Pushing packages to cachix:
        ${lib.concatMapStrings (x: "echo 📦"+x+"\n") config.cachix_packages}
        ${pkgs.cachix}/bin/cachix -c ${config.cachix_dhall} push ${config.cachix_name} ${builtins.toString config.cachix_packages}
      '';
      description = ''
        (Internal usage) The script of pushing packages to cachix.
      '';
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="module-1"><a class="header" href="#module-1">Module</a></h1>
<p>nixpkgs/lib/modules.nix:
从<code>loadModule</code>可以看出，imports可以接受Function、Attr、路径，不能够嵌套List。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nixpkgs"><a class="header" href="#nixpkgs">Nixpkgs</a></h1>
<h2 id="nixpkgs-crosssystem"><a class="header" href="#nixpkgs-crosssystem">nixpkgs crossSystem</a></h2>
<ul>
<li>default.nix
<ul>
<li>pkgs/top-level/impure.nix
<ul>
<li>pkgs/top-level/default.nix
<ul>
<li>lib.systems.elaborate crossSystem0;
<ul>
<li>lib/systems/default.nix: elaborate
<ul>
<li>parsed = parse.mkSystemFromString ... args.system; // args.system = crossSystem
<ul>
<li>lib/systems/parse.nix
<ul>
<li>mkSystemFromString = s: mkSystemFromSkeleton (mkSkeletonFromList (lib.splitString "-" s));
<ul>
<li>mkSkeletonFromList</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>注意mkSkeletonFromList通过
<code>${toString (length l)}</code>
实现了一个根据l长度的switch case。</p>
<p>crossSystem的4个域分别为cpu-vendor-kernel-abi</p>
<h2 id="import-nixpkgs"><a class="header" href="#import-nixpkgs">import nixpkgs</a></h2>
<p><code>import &lt;nixpgks&gt; {}</code>
的加载流程</p>
<ul>
<li>default.nix
<ul>
<li>pkgs/top-level/impure.nix
<ul>
<li>pkgs/top-level/default.nix
<ul>
<li>stdenvStages import pkgs/stdenv/default.nix
<ul>
<li>stagesLinux = import pkgs/stdenv/linux/
<ul>
<li>thisStdenv, stdenv = import pkgs/stdenv/generic/default.nix
<ul>
<li>import lib/default.nix
<h1 id="this-is-where-customisationnix-come-from"><a class="header" href="#this-is-where-customisationnix-come-from">this is where customisation.nix come from</a></h1>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>allPackages import pkgs/top-level/stage.nix
<ul>
<li>allPackages import pkgs/top-level/all-packages.nix</li>
</ul>
</li>
<li>boot = import pkgs/stdenv/booter.nix</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>vim_configurable.override {python = python3}
vimUtils.makeCustomizable (vim.override {python = python3})
vimUtils.makeCustomizable (vim.override {python = python3})</p>
<p>似乎是一个浮现override变量的最小集
f = a:{res = a+1;}
fo = pkgsMiao.makeOverride f
f 2</p>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="打包编译32位程序"><a class="header" href="#打包编译32位程序">打包/编译32位程序</a></h1>
<p>参考<a href="https://nixos.wiki/wiki/Packaging/32bit_Applications">Packaging/32bit Applications</a>。</p>
<h2 id="仅32位"><a class="header" href="#仅32位">仅32位</a></h2>
<p>打包使用pkgs.pkgsi686Linux.stdenv.mkDerivation</p>
<p>编译使用pkgs.pkgsi686Linux.gcc</p>
<h2 id="32位且64位"><a class="header" href="#32位且64位">32位且64位</a></h2>
<p>打包使用pkgs.multiStdenv.mkDerivation。</p>
<p>编译使用pkgs.gcc_multi。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="auto-push-packages-to-cachix"><a class="header" href="#auto-push-packages-to-cachix">Auto Push Packages to Cachix</a></h1>
<p><strong>Objective</strong>:
Automatically push specific built packages to cachix during <code>home-manager switch</code>/<code>nixos-rebuild switch</code>/<code>nix-shell</code>.</p>
<p>Although there are several existing ways to achieve this:</p>
<ul>
<li>cachix's <a href="https://docs.cachix.org/pushing">watch-exec and watch-store</a></li>
<li>nix-build's <a href="https://nixos.org/manual/nix/stable/advanced-topics/post-build-hook">post-build-hook</a></li>
</ul>
<p>However, the granularity of these methods is coarse; they push all packages to cachix.
Is there a way to allow users to control which packages are pushed?</p>
<h2 id="conclusion-first"><a class="header" href="#conclusion-first">Conclusion First</a></h2>
<p>Use <strong>hooks</strong> to push the selected packages to cachix:</p>
<div class="table-wrapper"><table><thead><tr><th>Scenario</th><th>Hook</th><th>Example</th></tr></thead><tbody>
<tr><td>home-manager</td><td><code>home.activation</code></td><td><a href="docs/howto/auto_push_to_cachix/../../../modules/cachix.nix.html">modules/cachix.nix</a>, <a href="docs/howto/auto_push_to_cachix/../../../usr/modules/cachix.nix.html">usr/modules/cachix.nix</a></td></tr>
<tr><td>nixos-rebuild</td><td><code>system.activationScripts</code></td><td><a href="docs/howto/auto_push_to_cachix/../../../modules/cachix.nix.html">modules/cachix.nix</a>, <a href="docs/howto/auto_push_to_cachix/../../../sys/modules/cachix.nix.html">sys/modules/cachix.nix</a></td></tr>
<tr><td>nix-shell</td><td><code>shellHook</code></td><td><a href="https://github.com/xieby1/openc910/blob/main/shell.nix">openc910/shell.nix</a></td></tr>
</tbody></table>
</div>
<hr />
<h2 id="my-explorations"><a class="header" href="#my-explorations">My Explorations</a></h2>
<p><strong>Possible solutions</strong>:
Add a wrapper called <code>cachixPackages</code>, which recives the packages to be pushed and cachix information.
This <code>cachixPackages</code> is a dummy package whose build stages will push the packages to cachix.
However, normal nix packages are not allowed network access during building.
To tackle this, like how fetch* series functions are implemented, the <a href="https://nixos.org/manual/nix/stable/language/advanced-attributes#adv-attr-outputHash">fixed-output derivation</a> can be utilized to allow network access.</p>
<p>However, the above method seems not work as below,
because cachix needs accesses to some resources beyond nix-build process (such as nix-build's sandbox).</p>
<pre><code class="language-bash">nix-build test.nix
...
cachix: CppStdException e "\ESC[31;1merror:\ESC[0m creating directory '\ESC[35;1m/nix/var\ESC[0m': \ESC[35;1mPermission denied\ESC[0m"(Just "nix::SysError")
result 1
...
</code></pre>
<p>Even though I disable the nix-build sandbox by using <code>--no-sandbox</code>,
the cachix still does not satisfy as below.</p>
<pre><code class="language-bash">$ nix-build test.nix --no-sandbox
...
cachix: CppStdException e "\ESC[31;1merror:\ESC[0m cannot open connection to remote store '\ESC[35;1mdaemon\ESC[0m': \ESC[35;1m\ESC[31;1merror:\ESC[0m reading from file: \ESC[35;1mConnection reset by peer\ESC[0m\ESC[0m"(Just "nix::Error")
...
</code></pre>
<p>If you curious about my demo of <code>cachixPackages</code> and its test,
see <a href="docs/howto/auto_push_to_cachix/./cachix-package.nix.html">cachix-package.nix</a> and <a href="docs/howto/auto_push_to_cachix/./test.nix.html">test.nix</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cachixpackage"><a class="header" href="#cachixpackage">cachixPackage</a></h1>
<p>This file try to implement a package wrapper, which will automatically push <code>pkg</code> to cachix upon building.
However, this method seems not work, due to limited resources in nix-build environment.
For more details, see <a href="docs/howto/auto_push_to_cachix/./index.html">here</a>.</p>
<pre><code class="language-nix">{ cachix
, stdenv
, writeShellScript
}:

{ pkg
, sha256
, cachix_dhall
, cachix_name
, name ? "cachixed"
}:

builtins.derivation {
  inherit name;
  system = builtins.currentSystem;
  builder = writeShellScript "cachix-package-builder" ''
    source ${stdenv}/setup
    echo ${pkg} &gt; $out
    if [[ -f "${cachix_dhall}" ]]; then
      ${cachix}/bin/cachix -c ${cachix_dhall} push ${cachix_name} ${pkg}
      result=$?
      echo result $result
      exit $result
    fi
  '';

  outputHashMode = "flat";
  outputHashAlgo = "sha256";
  outputHash = sha256;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="test-for-cachixpackage"><a class="header" href="#test-for-cachixpackage">Test for cachixPackage</a></h1>
<p>To run the test:</p>
<pre><code class="language-bash"># run with nix-build sandbox
nix-build test.nix
# run without nix-build sandbox
nix-build test.nix --no-sandbox
</code></pre>
<pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
  cachixPackage = import ./cachix-package.nix {inherit (pkgs) cachix stdenv writeShellScript;};
in cachixPackage {
  pkg = pkgs.hello;
  sha256 = "01vm275n169r0ly8ywgq0shgk8lrzg79d1aarshwybwxwffj4q0q";
  cachix_dhall = /home/xieby1/Gist/Config/cachix.dhall;
  cachix_name = "xieby1";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="备份binary-cache"><a class="header" href="#备份binary-cache">备份binary cache</a></h1>
<h2 id="场景"><a class="header" href="#场景">场景</a></h2>
<p>官方binary cache没有的包， 自己花了很长时间编译出来。
值得把编译出来的的包及其依赖全部保存下来。</p>
<h2 id="目前的问题"><a class="header" href="#目前的问题">目前的问题</a></h2>
<p>nix copy --to <path> 备份的/nix/store如何使用？</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="交叉编译和安装跨平台程序"><a class="header" href="#交叉编译和安装跨平台程序">交叉编译和安装跨平台程序</a></h1>
<p>nixpkgs原生支持x86和arm指令集。
通过对nixpkgs配置可以轻松实现交叉编译，
跨平台程序的安装等功能。</p>
<h2 id="太长不看"><a class="header" href="#太长不看">太长不看</a></h2>
<ul>
<li>
<p>x86_64上的aarch64交叉编译器</p>
<p><code>(with import &lt;nixpkgs&gt; {crossSystem="aarch64-linux";}; stdenv.cc)</code></p>
</li>
<li>
<p>aarch64的hello应用程序</p>
<p><code>(with import &lt;nixpkgs&gt; {localSystem.system="aarch64-linux";crossSystem="aarch64-linux";}; hello)</code></p>
</li>
<li>
<p>应用于nix-shell的例子</p>
<p><a href="https://xieby1.github.io/scripts/index.html#shell_cross_platformnix">shell_cross_platform.nix</a></p>
</li>
</ul>
<h2 id="目录-1"><a class="header" href="#目录-1">目录</a></h2>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="docs/howto/cross.html#%E7%AE%80%E4%BB%8B">简介</a></li>
<li><a href="docs/howto/cross.html#localsystem%E5%92%8Ccrosssystem%E7%9A%84%E8%AF%AD%E6%B3%95"><code>localSystem</code>和<code>crossSystem</code>的语法</a>
<ul>
<li><a href="docs/howto/cross.html#cpu-vendor-kernel-abi">cpu-vendor-kernel-abi</a>
<ul>
<li><a href="docs/howto/cross.html#cpu">cpu</a>
<ul>
<li><a href="docs/howto/cross.html#cputypes">cpuTypes</a></li>
</ul>
</li>
<li><a href="docs/howto/cross.html#vendor">vendor</a></li>
<li><a href="docs/howto/cross.html#kernel">kernel</a></li>
<li><a href="docs/howto/cross.html#abi">abi</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="docs/howto/cross.html#localsystem%E5%92%8Ccrosssystem%E7%9A%84%E5%BA%94%E7%94%A8"><code>localSystem</code>和<code>crossSystem</code>的应用</a>
<ul>
<li><a href="docs/howto/cross.html#aarch64%E4%BA%A4%E5%8F%89%E5%B7%A5%E5%85%B7%E9%93%BE%E5%92%8C%E7%A8%8B%E5%BA%8F%E7%9A%84%E8%AF%A6%E7%BB%86%E4%BE%8B%E5%AD%90">aarch64交叉工具链和程序的详细例子</a></li>
<li><a href="docs/howto/cross.html#mips%E4%BA%A4%E5%8F%89%E5%B7%A5%E5%85%B7%E9%93%BE%E7%9A%84%E4%BE%8B%E5%AD%90">mips交叉工具链的例子</a></li>
</ul>
</li>
<li><a href="docs/howto/cross.html#%E5%BC%95%E7%94%A8">引用</a></li>
</ul>
<!-- vim-markdown-toc -->
<h2 id="简介"><a class="header" href="#简介">简介</a></h2>
<p>nixpkgs<sup class="footnote-reference"><a href="#version">1</a></sup>众多输入参数中，包含<code>localSystem</code>和<code>crossSystem</code><sup class="footnote-reference"><a href="#localSystem_crossSystem">2</a></sup>。</p>
<ul>
<li>
<p><code>localSystem</code></p>
<blockquote>
<p>The system packages will be built on.</p>
</blockquote>
<p>本地系统，即工具链运行的平台。</p>
</li>
<li>
<p><code>crossSystem</code></p>
<blockquote>
<p>The system packages will ultimately be run on.</p>
</blockquote>
<p>程序运行的平台。</p>
</li>
</ul>
<p>通过<code>localSystem</code>和<code>crossSystem</code>不同值的组合，
可以实现交叉编译、安装其他架构的原生应用。
下面从<code>localSystem</code>和<code>crossSystem</code>的语法和应用两方面进行介绍。
语法章节从nixpkgs源码的角度出发，介绍其语法的组成。
应用章节围绕一个nix-shell脚本的实际例子，
介绍x86_64平台的交叉编译和安装aarch64架构的原生应用的方法。</p>
<h2 id="localsystem和crosssystem的语法"><a class="header" href="#localsystem和crosssystem的语法"><code>localSystem</code>和<code>crossSystem</code>的语法</a></h2>
<p><code>localSystem</code>和<code>crossSystem</code>由4个维度去刻画一个系统：cpu, vendor, kernel, abi。
<code>localSystem</code>和<code>crossSystem</code>的值为字符串或者<code>{system=字符串;}</code><sup class="footnote-reference"><a href="#localSystem_crossSystem_type">3</a></sup>。
system字符串为可以包含前述4个维度的1~4个维度。
nix在解析时会将省略的维度按以某些默认值补充完整。
维度之间之间用<code>-</code>分割。
因此system字符串形式上为<code>"cpu-vendor-kernel-abi"</code>。
字符串不同数量的维度及其可用的值，
按匹配优先级由高到低列举如下<sup class="footnote-reference"><a href="#skeleton">4</a></sup>，</p>
<h3 id="cpu-vendor-kernel-abi"><a class="header" href="#cpu-vendor-kernel-abi">cpu-vendor-kernel-abi</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">system字符串</th><th style="text-align: center">cpu</th><th style="text-align: center">vendor</th><th style="text-align: center">kernel</th><th style="text-align: center">abi</th></tr></thead><tbody>
<tr><td style="text-align: center">"avr"</td><td style="text-align: center">avr</td><td style="text-align: center"></td><td style="text-align: center">none</td><td style="text-align: center">unknown</td></tr>
<tr><td style="text-align: center">"{cpu}-cygwin"</td><td style="text-align: center">{cpu}</td><td style="text-align: center"></td><td style="text-align: center">windows</td><td style="text-align: center">cygnus</td></tr>
<tr><td style="text-align: center">"{cpu}-windows"</td><td style="text-align: center">{cpu}</td><td style="text-align: center"></td><td style="text-align: center">windows</td><td style="text-align: center">msvc</td></tr>
<tr><td style="text-align: center">"{cpu}-elf"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">unknown</td><td style="text-align: center">none</td><td style="text-align: center">elf</td></tr>
<tr><td style="text-align: center">"{cpu}-{kernel}"</td><td style="text-align: center">{cpu}</td><td style="text-align: center"></td><td style="text-align: center">{kernel}</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-apple-{kernel}"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">apple</td><td style="text-align: center">{kernel}</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-linux-gnu"</td><td style="text-align: center">{cpu}</td><td style="text-align: center"></td><td style="text-align: center">linux</td><td style="text-align: center">gnu</td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-mingw32"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">windows</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-wasi"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">wasi</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-redox"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">redox</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-mmixware"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">mmixware</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-netbsd*"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">netbsd*</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-eabi"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">unknown</td><td style="text-align: center">{kernel}</td><td style="text-align: center">eabi</td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-eabihf"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">unknown</td><td style="text-align: center">{kernel}</td><td style="text-align: center">eabihf</td></tr>
<tr><td style="text-align: center">"{cpu}-{kernel}-elf"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">unknown</td><td style="text-align: center">{kernel}</td><td style="text-align: center">elf</td></tr>
<tr><td style="text-align: center">"{cpu}-*-{ghcjs}"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">unknown</td><td style="text-align: center">ghcjs</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-genode"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">genode</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-{kernel}-{abi} "</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">{kernel}</td><td style="text-align: center">{abi}</td></tr>
</tbody></table>
</div>
<h4 id="cpu"><a class="header" href="#cpu">cpu</a></h4>
<p>cpu字符串可取的值列举如下<sup class="footnote-reference"><a href="#cpuTypes">5</a></sup>,</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">cpu字符串</th><th style="text-align: center">bits</th><th style="text-align: center">significantByte</th><th style="text-align: center">family</th><th style="text-align: center">version</th><th style="text-align: center">arch</th></tr></thead><tbody>
<tr><td style="text-align: center">"arm"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"armv5tel"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"5"</td><td style="text-align: center">"armv5t"</td></tr>
<tr><td style="text-align: center">"armv6m"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"6"</td><td style="text-align: center">"armv6-m"</td></tr>
<tr><td style="text-align: center">"armv6l"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"6"</td><td style="text-align: center">"armv6"</td></tr>
<tr><td style="text-align: center">"armv7a"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"7"</td><td style="text-align: center">"armv7-a"</td></tr>
<tr><td style="text-align: center">"armv7r"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"7"</td><td style="text-align: center">"armv7-r"</td></tr>
<tr><td style="text-align: center">"armv7m"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"7"</td><td style="text-align: center">"armv7-m"</td></tr>
<tr><td style="text-align: center">"armv7l"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"7"</td><td style="text-align: center">"armv7"</td></tr>
<tr><td style="text-align: center">"armv8a"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"8"</td><td style="text-align: center">"armv8-a"</td></tr>
<tr><td style="text-align: center">"armv8r"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"8"</td><td style="text-align: center">"armv8-a"</td></tr>
<tr><td style="text-align: center">"armv8m"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"8"</td><td style="text-align: center">"armv8-m"</td></tr>
<tr><td style="text-align: center">"aarch64"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"8"</td><td style="text-align: center">"armv8-a"</td></tr>
<tr><td style="text-align: center">"aarch64_be"</td><td style="text-align: center">64</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"8"</td><td style="text-align: center">"armv8-a"</td></tr>
<tr><td style="text-align: center">"i386"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"x86"</td><td style="text-align: center"></td><td style="text-align: center">"i386"</td></tr>
<tr><td style="text-align: center">"i486"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"x86"</td><td style="text-align: center"></td><td style="text-align: center">"i486"</td></tr>
<tr><td style="text-align: center">"i586"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"x86"</td><td style="text-align: center"></td><td style="text-align: center">"i586"</td></tr>
<tr><td style="text-align: center">"i686"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"x86"</td><td style="text-align: center"></td><td style="text-align: center">"i686"</td></tr>
<tr><td style="text-align: center">"x86_64"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"x86"</td><td style="text-align: center"></td><td style="text-align: center">"x86-64"</td></tr>
<tr><td style="text-align: center">"mips"</td><td style="text-align: center">32</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"mips"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"mipsel"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"mips"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"mips64"</td><td style="text-align: center">64</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"mips"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"mips64el"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"mips"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"mmix"</td><td style="text-align: center">64</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"mmix"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"m68k"</td><td style="text-align: center">32</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"m68k"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"powerpc"</td><td style="text-align: center">32</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"power"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"powerpc64"</td><td style="text-align: center">64</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"power"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"powerpc64le"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"power"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"powerpcle"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"power"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"riscv32"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"riscv"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"riscv64"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"riscv"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"s390"</td><td style="text-align: center">32</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"s390"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"s390x"</td><td style="text-align: center">64</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"s390"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"sparc"</td><td style="text-align: center">32</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"sparc"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"sparc64"</td><td style="text-align: center">64</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"sparc"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"wasm32"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"wasm"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"wasm64"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"wasm"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"alpha"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"alpha"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"msp430"</td><td style="text-align: center">16</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"msp430"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"avr"</td><td style="text-align: center">8</td><td style="text-align: center"></td><td style="text-align: center">"avr"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"vc4"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"vc4"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"or1k"</td><td style="text-align: center">32</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"or1k"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"js"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"js"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
</tbody></table>
</div>
<h5 id="cputypes"><a class="header" href="#cputypes">cpuTypes</a></h5>
<p>cpu之间的兼容性（具有传递性和自反性）如下<sup class="footnote-reference"><a href="#isCompatible">6</a></sup>，</p>
<p><img src="docs/howto/./images/cpu_isCompatible.dot.svg" alt="" /></p>
<h4 id="vendor"><a class="header" href="#vendor">vendor</a></h4>
<p>vendor字符串可取值<code>"apple"</code>, <code>"pc"</code>(windows), <code>"w64"</code>(MinGW-w64), <code>"none"</code>, <code>"unknown"</code>(default)。</p>
<h4 id="kernel"><a class="header" href="#kernel">kernel</a></h4>
<p>kernel字符串可取值如下表<sup class="footnote-reference"><a href="#kernels">7</a></sup>，</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">kernel字符串</th><th style="text-align: center">execFormat</th><th style="text-align: center">families</th></tr></thead><tbody>
<tr><td style="text-align: center">"macos"</td><td style="text-align: center">macho</td><td style="text-align: center">darwin</td></tr>
<tr><td style="text-align: center">"darwin"</td><td style="text-align: center">↑</td><td style="text-align: center">↑</td></tr>
<tr><td style="text-align: center">"ios"</td><td style="text-align: center">macho</td><td style="text-align: center">darwin</td></tr>
<tr><td style="text-align: center">"watchos"</td><td style="text-align: center">↑</td><td style="text-align: center">↑</td></tr>
<tr><td style="text-align: center">"tvos"</td><td style="text-align: center">↑</td><td style="text-align: center">↑</td></tr>
<tr><td style="text-align: center">"freebsd"</td><td style="text-align: center">elf</td><td style="text-align: center">bsd</td></tr>
<tr><td style="text-align: center">"linux"</td><td style="text-align: center">elf</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"netbsd"</td><td style="text-align: center">elf</td><td style="text-align: center">bsd</td></tr>
<tr><td style="text-align: center">"none"</td><td style="text-align: center">unknown</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"openbsd"</td><td style="text-align: center">elf</td><td style="text-align: center">bsd</td></tr>
<tr><td style="text-align: center">"solaris"</td><td style="text-align: center">elf</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"wasi"</td><td style="text-align: center">wasm</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"redox"</td><td style="text-align: center">elf</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"windows"</td><td style="text-align: center">pe</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"win32"</td><td style="text-align: center">↑</td><td style="text-align: center">↑</td></tr>
<tr><td style="text-align: center">"ghcjs"</td><td style="text-align: center">unknown</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"genode"</td><td style="text-align: center">elf</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"mmixware"</td><td style="text-align: center">unknown</td><td style="text-align: center"></td></tr>
</tbody></table>
</div>
<h4 id="abi"><a class="header" href="#abi">abi</a></h4>
<p>abi字符串可取的值列举如下<sup class="footnote-reference"><a href="#abis">8</a></sup>，</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">abi字符串</th><th style="text-align: center">float</th><th style="text-align: center">abi</th><th style="text-align: center">Note</th></tr></thead><tbody>
<tr><td style="text-align: center">"cygnus"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"msvc"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"eabi"</td><td style="text-align: center">soft</td><td style="text-align: center"></td><td style="text-align: center">for ARM, PowerPC</td></tr>
<tr><td style="text-align: center">"eabihf"</td><td style="text-align: center">hard</td><td style="text-align: center"></td><td style="text-align: center">for ARM, PowerPC</td></tr>
<tr><td style="text-align: center">"elf"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"androideabi"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"android"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center">not 32-bit</td></tr>
<tr><td style="text-align: center">"gnueabi"</td><td style="text-align: center">soft</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"gnueabihf"</td><td style="text-align: center">hard</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"gnu"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center">not 32-bit</td></tr>
<tr><td style="text-align: center">"gnuabi64"</td><td style="text-align: center"></td><td style="text-align: center">64</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"musleabi"</td><td style="text-align: center">soft</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"musleabihf"</td><td style="text-align: center">hard</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"musl"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"uclibceabihf"</td><td style="text-align: center">soft</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"uclibceabi"</td><td style="text-align: center">hard</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"uclibc"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"unknown"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
</tbody></table>
</div>
<h2 id="localsystem和crosssystem的应用"><a class="header" href="#localsystem和crosssystem的应用"><code>localSystem</code>和<code>crossSystem</code>的应用</a></h2>
<h3 id="aarch64交叉工具链和程序的详细例子"><a class="header" href="#aarch64交叉工具链和程序的详细例子">aarch64交叉工具链和程序的详细例子</a></h3>
<p>以x86为本地指令集，<code>localSystem</code>和<code>crossSystem</code>的组合有以下效果</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">↓<code>crossSystem</code>↓ →<code>localSystem</code>→</th><th style="text-align: center">"x86_64-linux"</th><th style="text-align: center">"aarch64-linux"</th></tr></thead><tbody>
<tr><td style="text-align: center">"x86_64-linux"</td><td style="text-align: center">通常情况</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"aarch64-linux"</td><td style="text-align: center">交叉编译aarch64</td><td style="text-align: center">原生aarch64应用</td></tr>
</tbody></table>
</div>
<p>因此基于这3种组合，可以在同一个shell环境中配置出3种软件，
代码见[cross_platform.nix]({{ site.repo_url }}/scripts/shell/cross_platform.nix)。</p>
<p><code>pkgs_arm_cross</code>软件包的<code>stdenv.cc</code>为x86平台的arm交叉编译器。
nixpkgs channel只包含了原生x86应用和原生arm应用。
交叉编译的arm应用和原生arm应用的derivation不一样。
因此使用<code>pkgs_arm_cross</code>中的应用，
则会使用交叉编译器从源码开始编译arm应用，
而不是直接拉取nixpkgs channel的原生arm应用。</p>
<p><code>pkgs_arm_native</code>软件包包含原生arm软件包。
从这个软件包拉取的应用和在arm平台的拉取到的应用一致。
例如<code>figlet</code>将直接从nix channel中拉取。</p>
<p><code>pkgs</code>即x86原生的软件包。</p>
<p>shell_cross_platform.nix使用例子，</p>
<pre><code class="language-bash"># 创建一个新的shell环境，包含stdenv.cc, figlet, qemu
$ nix-shell shell_cross_platform.nix

# 使用交叉编译工具链的c编译器
$ aarch64-unknown-linux-gnu-gcc helloworld.c -o helloworld
$ file helloworld
helloworld: ELF 64-bit LSB executable, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /nix/store/01kw0gb38phviarfv3fca49dpqh0qwlx-glibc-aarch64-unknown-linux-gnu-2.33-123/lib/ld-linux-aarch64.so.1, for GNU/Linux 2.6.32, with debug_info, not stripped

# arm原生应用
$ file `command -v figlet`
/nix/store/4f70f04bvd664n00jlnzccyzxd35lykw-figlet-2.2.5/bin/figlet: ELF 64-bit LSB executable, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /nix/store/rjc27shzir243n1w3127w713fijamf6v-glibc-2.33-123/lib/ld-linux-aarch64.so.1, for GNU/Linux 2.6.32, not stripped

# 直接执行figlet会出错
$ figlet
bash: /nix/store/4f70f04bvd664n00jlnzccyzxd35lykw-figlet-2.2.5/bin/figlet: cannot execute binary file: Exec format error

# 使用QEMU执行figlet即可
$ qemu-aarch64 `command -v figlet` miao!
           _             _
 _ __ ___ (_) __ _  ___ | |
| '_ ` _ \| |/ _` |/ _ \| |
| | | | | | | (_| | (_) |_|
|_| |_| |_|_|\__,_|\___/(_)
</code></pre>
<h3 id="mips交叉工具链的例子"><a class="header" href="#mips交叉工具链的例子">mips交叉工具链的例子</a></h3>
<p>[cross_mips.nix]({{ site.repo_url }}/scripts/shell/cross_mips.nix)</p>
<h2 id="引用-1"><a class="header" href="#引用-1">引用</a></h2>
<div class="footnote-definition" id="version"><sup class="footnote-definition-label">1</sup>
<p>nixpkgs版本2022.01.20, commit hash: 7e149abe9db1509fa974bb2286f862a761ca0a07</p>
</div>
<div class="footnote-definition" id="localSystem_crossSystem"><sup class="footnote-definition-label">2</sup>
<p>nixpkgs/pkgs/top-level/default.nix</p>
</div>
<div class="footnote-definition" id="localSystem_crossSystem_type"><sup class="footnote-definition-label">3</sup>
<p>nixpkgs/lib/systems/default.nix: <code>elaborate</code></p>
</div>
<div class="footnote-definition" id="skeleton"><sup class="footnote-definition-label">4</sup>
<p>nixpkgs/lib/systems/parse.nix: <code>mkSkeletonFromList</code></p>
</div>
<div class="footnote-definition" id="cpuTypes"><sup class="footnote-definition-label">5</sup>
<p>nixpkgs/lib/systems/parse.nix: <code>cpuTypes</code></p>
</div>
<div class="footnote-definition" id="isCompatible"><sup class="footnote-definition-label">6</sup>
<p>nixpkgs/lib/systems/parse.nix: <code>isCompatible</code></p>
</div>
<div class="footnote-definition" id="kernels"><sup class="footnote-definition-label">7</sup>
<p>nixpkgs/lib/systems/parse.nix: <code>kernels</code></p>
</div>
<div class="footnote-definition" id="abis"><sup class="footnote-definition-label">8</sup>
<p>nixpkgs/lib/systems/parse.nix: <code>abis</code></p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="安装nixos"><a class="header" href="#安装nixos">安装NixOS</a></h1>
<p>安装过程采用<a href="https://nixos.org/manual/nixos/stable/#sec-installation">官方安装文档</a>。
若已安装NixOS，则可跳过该步骤，直接看安装我的配置。</p>
<h2 id="准备镜像"><a class="header" href="#准备镜像">准备镜像</a></h2>
<p>QEMU:</p>
<pre><code class="language-bash"># 下载minimal ISO镜像：https://nixos.org/download.html
# 创建qemu硬盘（大小32GB）
qemu-img create -f qcow2 &lt;output/path/to/nix.qcow2&gt; 32G
# 将ISO安装到qemu硬盘
qemu-system-x86_64 -display gtk,window-close=off -vga virtio -device e1000,netdev=net0 -netdev user,id=net0,hostfwd=tcp::5556-:22,smb=/home/xieby1/ -m 4G -smp 3 -enable-kvm -hda &lt;/path/to/nix.qcow2&gt; -cdrom &lt;/path/to/nixos-minial.iso&gt; -boot d &amp;
</code></pre>
<p>物理机:</p>
<pre><code class="language-bash"># 暂时未探究命令行连接wifi的方法
# 所以目前使用gnome版ISO，而非minimal ISO。
# 下载gnome ISO镜像：https://nixos.org/download.html
# 启动U盘制作
sudo dd if=&lt;path/to/nixos.iso&gt; of=&lt;/dev/your_usb&gt;
sync
# 重启进入U盘系统
# 注：需要在BIOS中取消secure boot，否则U盘无法启动。
</code></pre>
<h2 id="分区"><a class="header" href="#分区">分区</a></h2>
<p>进入ISO系统后，创建分区。
一共需要3个分区：启动分区，操作系统分区，swap分区。
QEMU和物理机单系统需要创建这3个分区。
物理机双系统中启动分区已有，只需创建剩下2个分区。</p>
<p>QEMU:</p>
<pre><code class="language-bash">sudo bash
parted /dev/sda -- mklabel msdos
parted /dev/sda -- mkpart primary 1MiB -8GiB
parted /dev/sda -- mkpart primary linux-swap -8GiB 100%
</code></pre>
<p>物理机单系统:</p>
<pre><code class="language-bash">parted /dev/sda -- mklabel gpt
parted /dev/sda -- mkpart primary 512MiB -8GiB
parted /dev/sda -- mkpart primary linux-swap -8GiB 100%
parted /dev/sda -- mkpart ESP fat32 1MiB 512MiB
parted /dev/sda -- set 3 esp on
</code></pre>
<p>物理机双系统:</p>
<p>还未探索parted详细用法，目前使用disk软件可视化分区。</p>
<ul>
<li>创建Ext4分区，取名为nixos</li>
<li>创建Other-&gt;swap分区</li>
</ul>
<h2 id="文件系统"><a class="header" href="#文件系统">文件系统</a></h2>
<pre><code class="language-bash">mkfs.ext4 -L nixos /dev/&lt;系统分区&gt;
mkswap -L swap /dev/&lt;swap分区&gt;
swapon /dev/&lt;swap分区&gt;
mkfs.fat -F 32 -n boot /dev/&lt;启动分区&gt;      # 物理机单系统
mount /dev/disk/by-label/nixos /mnt
mkdir -p /mnt/boot                          # 物理机单系统&amp;双系统
mount /dev/disk/by-label/boot /mnt/boot     # 物理机单系统&amp;双系统
</code></pre>
<h2 id="基础配置"><a class="header" href="#基础配置">基础配置</a></h2>
<ul>
<li>生成配置文件</li>
</ul>
<pre><code class="language-bash">nixos-generate-config --root /mnt
</code></pre>
<ul>
<li>修改/mnt/etc/nixos/configuration.nix，
<ul>
<li>修改名字<code>networking.hostName</code></li>
<li>启用代理
<ul>
<li>QEMU中宿主机器的ip为10.0.2.2</li>
<li>安装过程中需要借助别的计算机或宿主机的的代理服务</li>
<li>部署完我的nixos配置后，将会有clash服务，可以用虚拟机的代理服务</li>
<li><code>networking.proxy.default = "http://user:password@proxy:port/";</code></li>
<li><code>networking.proxy.noProxy = "127.0.0.1,localhost,internal.domain";</code></li>
</ul>
</li>
<li>（QEMU和物理机单系统）取消以下注释以开启grub支持
<ul>
<li><code>boot.loader.grub.device = "/dev/sda";</code></li>
</ul>
</li>
<li>取消防火墙，以便kdeconnect正常运行
<ul>
<li><code>networking.firewall.enable = false;</code></li>
</ul>
</li>
<li>（物理机双系统）自动探测操作系统启动项
<ul>
<li><code>boot.loader.grub.useOSProber = true;</code></li>
</ul>
</li>
<li>添加用户
<ul>
<li><code>users.users.xieby1</code></li>
</ul>
</li>
<li>添加软件
<ul>
<li><code>environment.systemPackages = with pkgs; [vim git];</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>最后</p>
<pre><code class="language-bash">nixos-install
reboot
</code></pre>
<p>重启之后，进入NixOS。</p>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="nix让你的团队成员不再受环境问题困扰"><a class="header" href="#nix让你的团队成员不再受环境问题困扰">Nix让你的团队成员不再受环境问题困扰</a></h1>
<p>注：左下角菜单里可切换全屏</p>
<iframe src="./2023.nix-env.slides.html" style="width: 100%;aspect-ratio:12/7;" frameBorder="0"></iframe>
<div style="break-before: page; page-break-before: always;"></div><p>See all fhs-shell scripts on [Github repo: scripts/fhs-shell]({{ site.repo_url }}/scripts/fhs-shell)</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
{ pkgs ? import &lt;nixpkgs&gt; {} }:
(pkgs.buildFHSUserEnv {
  name = "dynamoRIO";
  targetPkgs = pkgs: with pkgs; [
    (hiPrio gcc)
    snappy
    zlib
    zlib.dev
    lz4
    lz4.dev
    libunwind
    libunwind.dev
  ];
  profile = ''
    export CC=gcc
    export CXX=g++
  '';
}).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
let
  pkgs = import &lt;nixpkgs&gt; {};
  fhs = pkgs.buildFHSUserEnv {
    name = "hello";
    targetPkgs = p: with p; [
      hello
    ];
    profile = ''
      export MIAO=1
    '';
  };
in
  fhs.env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  pin = builtins.derivation {
    name = "pin-3.25";
    system = builtins.currentSystem;
    src = pkgs.fetchurl {
      url = "https://software.intel.com/sites/landingpage/pintool/downloads/pin-3.25-98650-g8f6168173-gcc-linux.tar.gz";
      hash = "sha256-Q8D0QSNLDly2XK+XFOYdMxbx5N33eGVzESGTCgWGX6E=";
    };
    builder = pkgs.writeShellScript "pin-builder" ''
      # make mkdir and tar and other useful tools added to PATH
      source ${pkgs.stdenv}/setup
      mkdir -p $out
      # strip leading directory
      tar -xf $src --strip-components=1 --directory=$out
    '';
  };
in
(pkgs.buildFHSUserEnv {
  name = "pin";
  targetPkgs = pkgs: with pkgs; [
  ];
  profile = ''
    PATH+=":${pin}"
  '';
}).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  zigenv = import /home/xieby1/Codes/nix-zig-stdenv {
    target = "x86_64-unknown-linux-musl";
  };
  noPrefixStaticStdenvCC = pkgs.runCommand "linkCC" {} ''
    mkdir -p $out/bin
    for file in ${pkgs.pkgsStatic.stdenv.cc}/bin/*; do
      ln -s $file $out/bin/''${file##*-}
    done
  '';
in
(pkgs.buildFHSUserEnv {
  name = "spec";
  targetPkgs = pkgs: with pkgs; [
    # (hiPrio zigenv.pkgs.stdenv.cc)
    # (hiPrio clangStdenv.cc)
    # (hiPrio gcc)
    # (hiPrio pkgsStatic.stdenv.cc)
    # noPrefixStaticStdenvCC
    gfortran
    # uclibc
    # musl
    # musl.dev
    glibc.static
    glibc.dev
  ];
}).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# https://ryantm.github.io/nixpkgs/builders/special/fhs-environments/

{ pkgs ? import &lt;nixpkgs&gt; {} }:

(pkgs.buildFHSUserEnv {
  name = "simple-x11-env";
  targetPkgs = pkgs: (with pkgs;
    [ udev
      alsa-lib
    ]) ++ (with pkgs.xorg;
    [ libX11
      libXcursor
      libXrandr
    ]);
  multiPkgs = pkgs: (with pkgs;
    [ udev
      alsa-lib
    ]);
  runScript = "bash";
}).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# based on https://github.com/nix-community/nix-environments
#   git commit: 40d9d98bab7750bb5a1a9a3b5bcc1c91a652f3be
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  name = "xilinx-fhs";
  h_content = builtins.toFile "h_content" ''
    # ${pkgs.lib.toUpper "${name} usage"}

    **Commands**

    * Show this help: `h`
    * Start Vitis HLS IDE: `vitis_hls`
    * Start Vitis HLS REPL: `vitis_hls -i`

    **Files**

    * Vitis HLS Doc: `2022.vitis_hls.ug1399.pdf`
    * Local command doc: `Xilinx/Vitis/2022.2/doc/eng/man/`
    * TODO: `ug871-vivado-high-level-synthesis-tutorial.pdf`
    * TODO: `ug902-vivado-high-level-synthesis.pdf`

    **Examples**

    * [Vitis HLS examples](https://github.com/Xilinx/Vitis-HLS-Introductory-Examples)
    * Run an example: `vitis_hls -f run_hls.tcl`
  '';
  _h_ = pkgs.writeShellScriptBin "h" ''
    ${pkgs.glow}/bin/glow ${h_content}
  '';
in
(pkgs.buildFHSUserEnv {
  inherit name;
  targetPkgs = pkgs: with pkgs; [
    _h_

    bash
    coreutils
    zlib
    lsb-release
    stdenv.cc.cc
    ncurses5
    xorg.libXext
    xorg.libX11
    xorg.libXrender
    xorg.libXtst
    xorg.libXi
    xorg.libXft
    xorg.libxcb
    xorg.libxcb
    # common requirements
    freetype
    fontconfig
    glib
    gtk2
    gtk3
    # vitis_hls gcc needs
    glibc.dev

    # to compile some xilinx examples
    opencl-clhpp
    ocl-icd
    opencl-headers

    # from installLibs.sh
    graphviz
    (lib.hiPrio gcc)
    unzip
    nettools
  ];
  multiPkgs = null;
  profile = ''
    export LC_NUMERIC="en_US.UTF-8"
    source ~/Xilinx/Vitis_HLS/*/settings64.sh
    h
  '';
}).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>See all fhs-shell scripts on [Github repo: scripts/pkgs]({{ site.repo_url }}/scripts/pkgs)</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># TODO: 7z need dynamical link 7z.so
#   but static compilation prevents this behavior?
{pkgs ? import &lt;nixpkgs&gt; {}}:
let cross = import /home/xieby1/Codes/nix-zig-stdenv {
  inherit pkgs;
  target = "x86_64-unknown-linux-musl";
};
in
cross.pkgs.p7zip.overrideAttrs (old: {
  postPatch = old.postPatch + ''
    sed -i '/CC=/d' makefile.machine
    sed -i '/CXX=/d' makefile.machine
  '';
})
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><div style="text-align:right; font-size:3em;">2022.04.19</div>
<h1 id="在nixos上使用android程序"><a class="header" href="#在nixos上使用android程序">在NixOS上使用Android程序</a></h1>
<p>TLDR: 使用Android Studio提供的Android Emulator体验最好，其次是使用QEMU+x86Android。</p>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="scripts/pkgs/android.html#anbox--waydroid">Anbox &amp; Waydroid</a></li>
<li><a href="scripts/pkgs/android.html#qemu--x86-android">qemu + x86 Android</a></li>
<li><a href="scripts/pkgs/android.html#google-android-emulator">Google Android Emulator</a>
<ul>
<li><a href="scripts/pkgs/android.html#%E8%8E%B7%E5%8F%96apk-package%E5%92%8Cactivity">获取apk package和activity</a></li>
<li><a href="scripts/pkgs/android.html#avdmanager%E6%89%BE%E4%B8%8D%E5%88%B0%E9%95%9C%E5%83%8F">avdmanager找不到镜像</a></li>
<li><a href="scripts/pkgs/android.html#%E6%A8%A1%E6%8B%9F%E5%99%A8%E9%97%AA%E9%80%80">模拟器闪退</a></li>
<li><a href="scripts/pkgs/android.html#debug-%E6%96%B9%E6%B3%95">debug 方法</a></li>
<li><a href="scripts/pkgs/android.html#pci-bus-not-available-for-hda">PCI bus not available for hda</a></li>
</ul>
</li>
<li><a href="scripts/pkgs/android.html#google-android-studio">Google Android Studio</a></li>
<li><a href="scripts/pkgs/android.html#redroid">redroid</a></li>
</ul>
<!-- vim-markdown-toc -->
<h2 id="anbox--waydroid"><a class="header" href="#anbox--waydroid">Anbox &amp; Waydroid</a></h2>
<p>Anbox &amp; Waydroid属于将Android runtime移植到Linux上的项目。
都需要安装内核模块。</p>
<p>Anbox已未维护。</p>
<p>Waydroid需要Wayland支持。目前我还采用X11。</p>
<h2 id="qemu--x86-android"><a class="header" href="#qemu--x86-android">qemu + x86 Android</a></h2>
<p>虚拟机，没有找到图形和音频的加速方法。基本可用的程度。</p>
<ul>
<li>vanilla x86 android: OK</li>
<li>lineageOS: OK
<ul>
<li>same to vanilla x86 android</li>
<li>wechat not work</li>
</ul>
</li>
<li>phoenixOS: stuck in booting</li>
</ul>
<pre><code class="language-bash"># 安装在运行命令后添加-cdrom &lt;/path/to/iso&gt; -boot -d
# 运行命令
qemu-system-x86_64 -m 4G -smp 3 -hda ~/Img/andx64_vcm141r5.qcow2 -enable-kvm -display gtk,window-close=off -device AC97
</code></pre>
<p>注：-vga virtio不能启动图形界面，原因未探索。</p>
<h2 id="google-android-emulator"><a class="header" href="#google-android-emulator">Google Android Emulator</a></h2>
<p>使用nix提供的emulate-app.nix直接运行Google Android Emulator (魔改的QEMU)。</p>
<p>模拟器闪退无法启动，暂时没有尝试去解决。</p>
<p>参考</p>
<ul>
<li>https://nixos.wiki/wiki/Android
<ul>
<li><a href="https://sandervanderburg.blogspot.com/2014/02/reproducing-android-app-deployments-or.html">2014: Reproducing Android app deployments (or playing Angry Birds on NixOS)</a></li>
</ul>
</li>
<li><a href="https://stackoverflow.com/questions/24627978/run-android-app-in-qemu-arm">SO: Run Android app in qemu-arm?</a>
<ul>
<li><a href="https://www.linaro.org/blog/running-64bit-android-l-qemu/index.html">2014: Running Android L Developer Preview on 64-bit Arm QEMU</a></li>
</ul>
</li>
</ul>
<p>使用的nix脚本见android.nix</p>
<h3 id="获取apk-package和activity"><a class="header" href="#获取apk-package和activity">获取apk package和activity</a></h3>
<p>aapt已经淘汰，现在使用的是<a href="https://developer.android.com/studio/command-line/aapt2#download_aapt2">aapt2</a>，run by <a href="https://github.com/thiagokokada/nix-alien">nix-alien</a>。
例子，</p>
<pre><code class="language-bash">nix-alien aapt2 dump badging &lt;/path/to/apk&gt;
</code></pre>
<h3 id="avdmanager找不到镜像"><a class="header" href="#avdmanager找不到镜像">avdmanager找不到镜像</a></h3>
<p>Error: Package path is not valid. Valid system image paths are:ository...</p>
<p>相关问题</p>
<ul>
<li><a href="https://github.com/NixOS/nixpkgs/issues/154898">GH: avdmanager create avd fails with "Probably the SDK is read-only" #154898</a>
<ul>
<li><a href="https://github.com/NixOS/nixpkgs/issues/121146">GH: androidenv.emulateApp fails to start emulator (libvulkan.so.1: full) #121146</a></li>
</ul>
</li>
<li><a href="https://stackoverflow.com/questions/66597053">SO: error: package path is not valid. valid system image paths are:ository... null</a></li>
</ul>
<p>从pkgs/development/mobile/androidenv/compose-android-packages.nix看，
platformVersions, systemImageTypes, abiVersions需要和
pkgs/development/mobile/androidenv/repo.json
中的emulator项中的数据匹配。</p>
<p>看repo.json，而不是看<code>sdkmanager --list</code>，不一定有，但能看到已安装。</p>
<p>不匹配，在nix-build中不会报错，运行过程报上面的错误。</p>
<h3 id="模拟器闪退"><a class="header" href="#模拟器闪退">模拟器闪退</a></h3>
<p>和问题类似<a href="https://github.com/NixOS/nixpkgs/issues/121146">GH: androidenv.emulateApp fails to start emulator (libvulkan.so.1: full) #121146</a></p>
<p>报错内容，没解决</p>
<pre><code class="language-bash">cannot add library /nix/store/yz1p6cw09h3im4z7wmx7nshi054fzhw4-emulator-30.8.4/libexec/android-sdk/emulator/qemu/linux-x86_64/lib64/vulkan/libvulkan.so: failed
added library /nix/store/yz1p6cw09h3im4z7wmx7nshi054fzhw4-emulator-30.8.4/libexec/android-sdk/emulator/lib64/vulkan/libvulkan.so
emulator: WARNING: Ignoring invalid http proxy: Bad format: invalid port number (must be decimal)
Device state has been reached
LLVM ERROR: Cannot select: intrinsic %llvm.x86.sse41.pblendvb
</code></pre>
<h3 id="debug-方法"><a class="header" href="#debug-方法">debug 方法</a></h3>
<p>参考https://nixos.wiki/wiki/Nixpkgs/Create_and_debug_packages#How_to_install_from_the_local_repository</p>
<p>使用本地nixpkgs，修改，nix-shell看变量
例子：</p>
<pre><code class="language-bash">nix-shell -E 'with import "/home/xieby1/temp-nixpkgs" {config.android_sdk.accept_license = true;}; (androidenv.composeAndroidPackages {includeSystemImages =true; platformVersions=["16"];}).androidsdk'
</code></pre>
<p>nix expression调用关系</p>
<ul>
<li>emulate-app.nix
<ul>
<li>compose-android-packages.nix
<ul>
<li>tools.nix
<ul>
<li>tools/26.nix
<ul>
<li>deploy-androidpackage.nix</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="pci-bus-not-available-for-hda"><a class="header" href="#pci-bus-not-available-for-hda">PCI bus not available for hda</a></h3>
<p>https://stackoverflow.com/questions/69297141/android-11-emulator-gives-pci-bus-not-available-for-hda</p>
<p>修改./result/bin/run-test-emulator添加-qemu -machine virt到Launch the emulator的指令后</p>
<pre><code class="language-bash">/nix/store/0q68cfq7rnbw752l89fkxf425v1pb2r6-androidsdk/libexec/android-sdk/emulator/emulator -avd device -no-boot-anim -port $port $NIX_ANDROID_EMULATORFLAGS -qemu -machine virt &amp;
</code></pre>
<h2 id="google-android-studio"><a class="header" href="#google-android-studio">Google Android Studio</a></h2>
<p>使用Android Studio的AVD安装Android emulator最省心。</p>
<p>可以使用微信（公众号闪退），语音视频流畅，小游戏流畅。</p>
<h2 id="redroid"><a class="header" href="#redroid">redroid</a></h2>
<p>暂时没成功</p>
<p>文档并未提供和各个参数相关的源文件？</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build

# https://nixos.wiki/wiki/Android
#  Building Android applications with the Nix package manager: https://sandervanderburg.blogspot.com/2014/02/reproducing-android-app-deployments-or.html
let
  # current nixpkgs-unstable
  pkgs = import (with import &lt;nixpkgs&gt; {}; fetchFromGitHub {
    owner = "NixOS";
    repo = "nixpkgs";
    rev = "1c851e8c92b76a00ce84167984a7ec7ba2b1f29c";
    hash = "sha256-vRxti8pOuXS0rJmqjbD8ueEEFXWSK22ISHoCWkhgzzg=";
  }){
    config.android_sdk.accept_license = true;
    config.allowUnfree = true;
  };
in pkgs.androidenv.emulateApp {
  name = "androidEmuApp";
  app = pkgs.fetchurl {
    url = "https://github.com/SimpleMobileTools/Simple-Calendar/releases/download/6.13.5/calendar-release.apk";
    sha256 = "12vzcd6klnk38b55szmd5a8ydc70fk6aak31qvlild83jy9z21zk";
  };
  enableGPU = false;
  # get these info by `pkgs/development/mobile/androidenv/repo.json`
  # see if installed `sdkmanager --list`
  platformVersion = "32";
  abiVersion = "x86";
  systemImageType = "google_apis";

  package = "com.simplemobiletools.calendar.pro";

  avdHomeDir = "$HOME/.android";
  sdkExtraArgs = {
    includeSystemImages = true;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
  squashfuse-with-headers = pkgs.pkgsStatic.squashfuse.overrideAttrs (old: {
    src = pkgs.fetchurl {
      url = "https://github.com/vasi/squashfuse/archive/e51978c.tar.gz";
      hash = "sha256-9UQCmtMNj73k5FQMV0uM3G04uU3wJamNhVGpRB8H00E=";
    };
    postInstall = ''
      mkdir -p $out/include/squashfuse
      cp *.h $out/include/squashfuse
    '';
  });
  srcRev = "c1ea7509bc179a05d907baca64f41875662f35f2";
in pkgs.stdenv.mkDerivation {
  name = "appimage-runtime";
  src = pkgs.fetchFromGitHub {
    owner = "AppImage";
    repo = "type2-runtime";
    rev = "${srcRev}";
    sha256 = "1gr853iz1x6pgyav3w1kqaaaz2ybbx67dcg74kj54yrwlakrh165";
  };
  nativeBuildInputs = with pkgs; [
    pkg-config
  ];
  buildInputs = (with pkgs.pkgsStatic; [
    squashfuse-with-headers
    fuse
    zstd
    zlib

    lz4.out
    lzo
    lzma.out
  ]) ++ (with pkgs; [
    glibc.static
  ]);
  sourceRoot = "source/src/runtime";
  buildPhase = ''
    export CFLAGS="-std=gnu99 -s -Os -D_FILE_OFFSET_BITS=64 -DGIT_COMMIT=\"${srcRev}\" -T data_sections.ld -ffunction-sections -fdata-sections -Wl,--gc-sections -static"
    export LIBS="-lsquashfuse -lsquashfuse_ll -lzstd -lz -llz4 -llzo2 -llzma"
    $CC -I${squashfuse-with-headers}/include/squashfuse -I${pkgs.pkgsStatic.fuse}/include/fuse -o runtime-fuse2.o -c $CFLAGS runtime.c
    $CC $CFLAGS runtime-fuse2.o $LIBS -lfuse -o runtime-fuse2
  '';
  installPhase = ''
    mkdir -p $out/bin
    cp runtime-fuse2 $out/bin/
  '';
}

# in pkgs.mkShell {
#   name = "appimage-runtime";
#   packages = (with pkgs.pkgsStatic; [
#     squashfuse-with-headers
#     fuse
#     zstd
#     zlib

#     lz4.out
#     lzo
#     lzma.out
#   ]) ++ (with pkgs; [
#     glibc.static
#     pkg-config
#   ]);
# }

# in (pkgs.buildFHSUserEnv {
#   name = "appimage-runtime-fhs";
#   targetPkgs = pkgs: (with pkgs.pkgsStatic; [
#     squashfuse-with-headers
#     fuse
#     zstd
#     zlib

#     lz4.out
#     lzo
#     lzma.out
#   ]) ++ (with pkgs; [
#     glibc.static
#     pkg-config
#   ]);
# }).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-build -o coremarks
{pkgs ? import &lt;nixpkgs&gt; {}}:
let
  # function mkCoremark
  mkCoremark = {
    pkgs ? import &lt;nixpkgs&gt; {},
    stdenv ? pkgs.stdenv,
    simple ? false,
  }:
  let
    name = "coremark";
    variant = pkgs.lib.concatStrings [
      "${stdenv.targetPlatform.config}"
      # TODO: all zig-env are static?
      # (if stdenv.targetPlatform.isStatic then ".static" else "")
      (if simple then ".simple" else "")
    ];
  in
  stdenv.mkDerivation {
    inherit name;
    src = pkgs.fetchFromGitHub {
      owner = "eembc";
      repo = "coremark";
      rev = "d26d6fdcefa1f9107ddde70024b73325bfe50ed2";
      sha256 = "0kd6bnrnd3f325ypxzn0w5ii4fmc98h16sbvvjikvzhm78y60wz3";
    };
    preBuild = ''
      # no float point insts
      export CFLAGS="-DHAS_FLOAT=0"

      # simple assumes CC = gcc, this is a bug!
      sed -i '/CC =/d' simple/core_portme.mak
      ${if simple
        then "export PORT_DIR=simple"
        else ""}
    '';
    buildFlags = ["compile"];
    installPhase = ''
      mkdir -p $out/bin
      mv coremark.exe $out/bin/${name}.${variant}.exe
    '';
  };
  zig-env-src = pkgs.fetchFromGitHub {
    owner = "Cloudef";
    repo = "nix-zig-stdenv";
    rev = "6de72ec32ecf0cfb9ad9dab5a8400d532e17f8c5";
    hash = "sha256-hQHOzjkHWO5YxQb3mgZJOfyIuvbiLFocVCMK/A9HTic=";
  };
in
pkgs.symlinkJoin {
  name = "coremarks";
  paths = [
    # x86_64 linux
    (mkCoremark {
      inherit (import zig-env-src {
        target = "x86_64-unknown-linux-gnu";
      }) stdenv;
    })
    # x86_64 linux static
    (mkCoremark {
      inherit (import zig-env-src {
        target = "x86_64-unknown-linux-musl";
      }) stdenv;
    })
    # aarch64 linux
    (mkCoremark {
      inherit (import zig-env-src {
        target = "aarch64-unknown-linux-gnu";
      }) stdenv;
    })
    # aarch64 linux static
    (mkCoremark {
      inherit (import zig-env-src {
        target = "aarch64-unknown-linux-musl";
      }) stdenv;
    })
    # riscv64 linux
    # (mkCoremark {
    #   inherit (import zig-env-src {
    #     target = "riscv64-unknown-linux-gnu";
    #   }) stdenv;
    # })
    # riscv64 linux static
    (mkCoremark {
      inherit (import zig-env-src {
        target = "riscv64-unknown-linux-musl";
      }) stdenv;
    })
    # x86_64 windows
    (mkCoremark {
      inherit (import zig-env-src {
        target = "x86_64-w64-mingw32";
      }) stdenv;
      simple = true;
    })
    # x86_64 darwin can only compiled on x86_64/aarch64 darwin
    #   https://github.com/NixOS/nixpkgs/issues/165804
    # while it is possible compile manually inside darling
    #(mkCoremark {
    #  stdenv = pkgs.pkgsCross.x86_64-darwin.stdenv;
    #})
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-env -i -f
# xieby1: 2022.05.16
with (import &lt;nixpkgs&gt; {crossSystem = "mips-linux";}); {
  gdb = lib.lowPrio buildPackages.gdb;
  gcc = lib.lowPrio buildPackages.gcc;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
let
  pkgs = import (builtins.fetchTarball {
    url = "https://github.com/NixOS/nixpkgs/archive/e60c3e2abb8ae9df3d89820c706cc736fad01ff7.tar.gz";
    sha256 = "0vyjpf1jw4cvw7kfbk055faq08q4swz6v1h2mf9zw4r8frhqa73w";
  }) {};
in
pkgs.pkgsCross.aarch64-multiplatform.pkgsStatic.glib
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-build -o fhs_helloworld

# xieby1: 2022.11.17
# inspired by
#   https://discourse.nixos.org/t/derivation-that-builds-standard-linux-binaries/21557/4
#   https://github.com/NixOS/nixpkgs/compare/master...ElvishJerricco:nixpkgs:run-in-fhs
# TODO-1:
#   I have copy all dependencies to a directory (ld-linux-x86-64.so.2, libc.so)
#   But result cannot run in chroot, error message is `cannot find libc.so`.
# TODO-2:
#   I didn't find a proper package/bundle tool
#   * nix-bundle: not work
#   * appimage: depends on libfuse.so, cannot run directly on nixos

{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  name = "helloworld";
  fhsEnv = pkgs.buildFHSUserEnv {
    name = "${name}-fhs";
    targetPkgs = pkgs: with pkgs; [
      gcc
      # gcc-unwrapped binutils-unwrapped
      glibc
      glibc.dev
    ];
    # refer to https://discourse.nixos.org/t/using-a-raw-gcc-inside-buildfhsuserenv/12864
    runScript = (pkgs.writeShellScript "${name}-fhsbuilder" ''
      # For gcc-unwrapped and binutils-unwrapped
      # export LIBRARY_PATH=/usr/lib
      # export C_INCLUDE_PATH=/usr/include
      # export CPLUS_INCLUDE_PATH=/usr/include
      # export CMAKE_LIBRARY_PATH=/usr/lib
      # export CMAKE_INCLUDE_PATH=/usr/include
      ## TODO: not work? have to add gcc -Wl,--dynamic-linker=/usr/lib64/ld-linux-x86-64.so.2 ?
      # export LDFLAGS=--dynamic-linker=/usr/lib64/ld-linux-x86-64.so.2

      # For gcc
      export NIX_LDFLAGS="--dynamic-linker=/usr/lib64/ld-linux-x86-64.so.2"
      gcc $src -o $out
    '');
  };
in
builtins.derivation {
  inherit name;
  system = builtins.currentSystem;
  src = builtins.toFile "${name}.c" ''
    #include &lt;stdio.h&gt;
    int main(void) {
      printf("Hello, world! \n");
      return 0;
    }
  '';
  builder = "${fhsEnv}/bin/${fhsEnv.name}";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  name = "perl";
  pkgs = import &lt;nixpkgs&gt; {};
  fhsEnv = pkgs.buildFHSUserEnv {
    name = "${name}-fhs";
    targetPkgs = pkgs: with pkgs; [
      gnumake
    ];
    runScript = (pkgs.writeShellScript "${name}-fhsbuilder" ''
      ls
      cd $src/tools/src
      ls
      DOPERL=1 ./buildtools
    '');
  };
in builtins.derivation {
  inherit name;
  system = builtins.currentSystem;
  src = /home/xieby1/Codes/spec2000;
  builder = "${fhsEnv}/bin/${fhsEnv.name}";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-build -o nix-binary-tarballs
</code></pre>
<h1 id="nix-official-installer-new"><a class="header" href="#nix-official-installer-new">Nix official installer (new)</a></h1>
<p>Use nix (&gt;2.18) binary-tarball script, which has not been merged into mainline nixpkgs.</p>
<p>See <a href="scripts/pkgs/./nix-binary-tarballs.nix.html">nix-binary-tarballs.nix</a> for current nix binary-tarball script.</p>
<pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
  nix_src = pkgs.fetchFromGitHub {
    owner = "NixOS";
    repo = "nix";
    rev = "d0c7da131fb64526bc72144949b6955c25367d92";
    hash = "sha256-Z4RlluZjNXH5BdJiXoe0k43Ry9ptK3jHAsKjlQ3jVZg=";
  };
in pkgs.symlinkJoin {
  name = "nix-binary-tarballs";
  paths = [
    (pkgs.callPackage "${nix_src}/scripts/binary-tarball.nix" {})
    (pkgs.callPackage "${nix_src}/scripts/binary-tarball.nix" {
      nix    = pkgs.pkgsCross.riscv64.nix;
      system = pkgs.pkgsCross.riscv64.nix.stdenv.system;
    })
    (pkgs.callPackage "${nix_src}/scripts/binary-tarball.nix" {
      nix    = pkgs.pkgsCross.loongarch64-linux.nix;
      system = pkgs.pkgsCross.loongarch64-linux.nix.stdenv.system;
    })
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-build -o nix-binary-tarballs
</code></pre>
<h1 id="nix-official-installer"><a class="header" href="#nix-official-installer">Nix official installer</a></h1>
<p>The <code>binaryTarball</code> function is extracted from <a href="https://github.com/NixOS/nix/blob/2.18.2/flake.nix">nix-2.18's flake.nix</a></p>
<p><strong>Noted</strong>:
Although the latest nix has seperate binaryTarball as a independent file,
current unstable nixpkgs still use nix-2.18,
which embed binaryTarball function in nix/flake.nix.
If reuse the binaryTarball file in new nix, then this script can be hugely simplified,
e.g. <a href="scripts/pkgs/./nix-binary-tarballs-new.nix.html">nix-binary-tarballs-new.nix</a>.
As long as, new nix is merged to mainline nixpkgs,
I will deprecate this script and adopt the new script.</p>
<pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
  binaryTarball =
    { nix
    , buildPackages
    , cacert
    }:
    let
      installerClosureInfo = buildPackages.closureInfo { rootPaths = [ nix cacert ]; };
    in buildPackages.runCommand "nix-binary-tarball-${nix.version}" {
      #nativeBuildInputs = lib.optional (system != "aarch64-linux") shellcheck;
      meta.description = "Distribution-independent Nix bootstrap binaries for ${nix.stdenv.system}";
    } ''
      cp ${installerClosureInfo}/registration $TMPDIR/reginfo
      cp ${nix.src}/scripts/create-darwin-volume.sh $TMPDIR/create-darwin-volume.sh
      substitute ${nix.src}/scripts/install-nix-from-closure.sh $TMPDIR/install \
        --subst-var-by nix ${nix} \
        --subst-var-by cacert ${cacert}
    
      substitute ${nix.src}/scripts/install-darwin-multi-user.sh $TMPDIR/install-darwin-multi-user.sh \
        --subst-var-by nix ${nix} \
        --subst-var-by cacert ${cacert}
      substitute ${nix.src}/scripts/install-systemd-multi-user.sh $TMPDIR/install-systemd-multi-user.sh \
        --subst-var-by nix ${nix} \
        --subst-var-by cacert ${cacert}
      substitute ${nix.src}/scripts/install-multi-user.sh $TMPDIR/install-multi-user \
        --subst-var-by nix ${nix} \
        --subst-var-by cacert ${cacert}
    
      if type -p shellcheck; then
        # SC1090: Don't worry about not being able to find
        #         $nix/etc/profile.d/nix.sh
        shellcheck --exclude SC1090 $TMPDIR/install
        shellcheck $TMPDIR/create-darwin-volume.sh
        shellcheck $TMPDIR/install-darwin-multi-user.sh
        shellcheck $TMPDIR/install-systemd-multi-user.sh
    
        # SC1091: Don't panic about not being able to source
        #         /etc/profile
        # SC2002: Ignore "useless cat" "error", when loading
        #         .reginfo, as the cat is a much cleaner
        #         implementation, even though it is "useless"
        # SC2116: Allow ROOT_HOME=$(echo ~root) for resolving
        #         root's home directory
        shellcheck --external-sources \
          --exclude SC1091,SC2002,SC2116 $TMPDIR/install-multi-user
      fi
    
      chmod +x $TMPDIR/install
      chmod +x $TMPDIR/create-darwin-volume.sh
      chmod +x $TMPDIR/install-darwin-multi-user.sh
      chmod +x $TMPDIR/install-systemd-multi-user.sh
      chmod +x $TMPDIR/install-multi-user
      dir=nix-${nix.version}-${nix.stdenv.system}
      fn=$out/$dir.tar.xz
      mkdir -p $out/nix-support
      echo "file binary-dist $fn" &gt;&gt; $out/nix-support/hydra-build-products
      tar cvfJ $fn \
        --owner=0 --group=0 --mode=u+rw,uga+r \
        --mtime='1970-01-01' \
        --absolute-names \
        --hard-dereference \
        --transform "s,$TMPDIR/install,$dir/install," \
        --transform "s,$TMPDIR/create-darwin-volume.sh,$dir/create-darwin-volume.sh," \
        --transform "s,$TMPDIR/reginfo,$dir/.reginfo," \
        --transform "s,$NIX_STORE,$dir/store,S" \
        $TMPDIR/install \
        $TMPDIR/create-darwin-volume.sh \
        $TMPDIR/install-darwin-multi-user.sh \
        $TMPDIR/install-systemd-multi-user.sh \
        $TMPDIR/install-multi-user \
        $TMPDIR/reginfo \
        $(cat ${installerClosureInfo}/store-paths)
    '';
in pkgs.symlinkJoin {
  name = "nix-binary-tarballs";
  paths = [
    # local nix installer
    (pkgs.callPackage binaryTarball {})
    # riscv64 nix installer
    (pkgs.callPackage binaryTarball {nix=pkgs.pkgsCross.riscv64.nix;})
    # loongarch64 nix installer
    (pkgs.callPackage binaryTarball {nix=pkgs.pkgsCross.loongarch64-linux.nix;})
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nix-docker-for-multiple-isas"><a class="header" href="#nix-docker-for-multiple-isas">🐳Nix Docker🐋 for Multiple ISAs</a></h1>
<p>This script is inspired by https://github.com/nix-community/docker-nixpkgs/images/nix</p>
<p>currently: this riscv64 nix docker can <code>nix-env -iA nixpkgs.hello/tmux</code> and so on,
which is completely built from source including toolchains (stdenv) in x86/aarch64/riscv64/...</p>
<pre><code class="language-nix">{ pkgs ? import &lt;nixpkgs&gt; {}
, pkgsCross ? pkgs
, useTmux ? true
}:
let
  name = "nix-docker-${pkgsCross.stdenv.system}";
  image = pkgs.dockerTools.buildImageWithNixDb {
    inherit name;
    copyToRoot = pkgs.buildEnv {
      name = "image-root";
      paths = (with pkgsCross; [
        bashInteractive
        cacert
        coreutils
        file
        gitMinimal
        gnutar
        nix
        openssh
        vim
        wget
      ]
      ++ lib.optional useTmux (tmux.override {withSystemd=false;})
      ) ++ [
        ./imageFiles
      ];
    };
    extraCommands = ''
      # for /usr/bin/env
      mkdir usr
      ln -s bin usr/bin

      # make sure /tmp exists
      mkdir -m 1777 tmp

      # need a HOME
      mkdir -vp root
    '';
    config = {
      Cmd = if useTmux
        then [ "/bin/tmux" ]
        else [ "/bin/bash" ];
      Env = [
        "NIX_BUILD_SHELL=/bin/bash"
        "PAGER=cat"
        "PATH=/bin"
        "SSL_CERT_FILE=${pkgs.cacert}/etc/ssl/certs/ca-bundle.crt"
        "USER=root"
      ];
    };
  };
in pkgs.writeShellScriptBin name ''
  command -v podman &amp;&gt; /dev/null || echo "podman not found TODO: install" || exit 1

  outName="$(basename ${image})"
  outHash=$(echo "$outName" | cut -d - -f 1)
  imageName=localhost/${name}:$outHash

  # check whether image has been loaded
  podman images $imageName | grep ${name} | grep $outHash &amp;&gt; /dev/null
  # image has not been loaded, then load it
  if [[ $? != 0 ]]; then
    podman load -i ${image}
  fi

  BINFMTS=""
  for binfmt in /run/binfmt/*; do
      BINFMTS+=" -v $(realpath $binfmt):$binfmt"
  done

  containerName=${name}-$outHash
  # run container
  OPTS=(
    "--name=$containerName"
    "$BINFMTS"
    "--network=host"
    "-it"
    "$imageName"
  )
  eval "podman run ''${OPTS[@]}"
  podman commit $containerName $imageName
  podman rm $containerName
''
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
</code></pre>
<h1 id="instantiatio-of-nix-dockers"><a class="header" href="#instantiatio-of-nix-dockers">Instantiatio of nix dockers</a></h1>
<p>For more details, see <a href="scripts/pkgs/nix-docker-isa/./default.nix.html">default.nix</a></p>
<pre><code class="language-nix">{ pkgs ? import &lt;nixpkgs&gt; {}
, ...
}: [
</code></pre>
<h2 id="x86_64-docker"><a class="header" href="#x86_64-docker">x86_64 docker</a></h2>
<pre><code class="language-nix">  (import ./. {inherit pkgs; pkgsCross=pkgs.pkgsCross.gnu64;})
</code></pre>
<h2 id="aarhc64-docker"><a class="header" href="#aarhc64-docker">aarhc64 docker</a></h2>
<pre><code class="language-nix">  (import ./. {inherit pkgs; pkgsCross=pkgs.pkgsCross.aarch64-multiplatform;})
</code></pre>
<h2 id="riscv64-docker"><a class="header" href="#riscv64-docker">riscv64 docker</a></h2>
<pre><code class="language-nix">  (import ./. {inherit pkgs; pkgsCross=pkgs.pkgsCross.riscv64;})
]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  flake-compat = import (builtins.fetchTarball {
    url = "https://github.com/edolstra/flake-compat/archive/0f9255e01c2351cc7d116c072cb317785dd33b33.tar.gz";
    sha256 = "0m9grvfsbwmvgwaxvdzv6cmyvjnlww004gfxjvcl806ndqaxzy4j";
  });
  nix2nvchad = flake-compat {
    src=  builtins.fetchTarball {
      url = "https://github.com/nix-community/nix4nvchad/archive/360ff667893eab066b3db906a856de2956fc710e.tar.gz";
      sha256 = "01gvcg7nhzpizp4yzvww2x42i1ifsb7sygfwmqzrshqz47p1ir5y";
    };
  };
in nix2nvchad.defaultNix.packages."${builtins.currentSystem}".default
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
# xieby1: 2022.05.24
# build static qemu (current version 6.1.1) into ./result/
# $ nix-build &lt;this-file&gt; -A qemu
# build static qemu-3.1.0 into ./result/
# $ nix-build &lt;this-file&gt; -A qemu31
# build and install static qemu
# $ nix-env -i -f &lt;this-file&gt; -A qemu
# build and install static qemu-3.1.0
# $ nix-env -i -f &lt;this-file&gt; -A qemu31
let
  # https://lazamar.co.uk/nix-versions
  pinnedPkgsForQemu31Src = builtins.fetchTarball {
    name = "nixos-20.03-with-qemu-3.1.0";
    url = "https://github.com/NixOS/nixpkgs/archive/81d4e65891f92e8e72c244da663c83c1e40dc919.tar.gz";
    sha256 = "0dk1k1zqy2bnp9gsy9mdxk0idkazyvnmqrj2jpbwzfnhjzpmzq1w";
  };
  pinnedPkgsSrc = builtins.fetchTarball {
    name = "nixos-static-qemu";
    url = "https://github.com/nixos/nixpkgs/archive/e7d63bd0d50df412f5a1d8acfa3caae75522e347.tar.gz";
    sha256 = "132pc4f9ixisyv4117p2jirmlyl6sd76bfaz33rhlcwakg7bhjm7";
  };
  pkgsForQemu31 = import pinnedPkgsForQemu31Src {};
  pkgs = import pinnedPkgsSrc {};
  mypkgs = import pinnedPkgsSrc {
    overlays = [(self: super: {

      cdparanoiaIII = super.pkgsStatic.cdparanoiaIII.overrideAttrs (old: {
        preConfigure = old.preConfigure + ''
          cp ${super.gnu-config}/config.sub configure.sub
          cp ${super.gnu-config}/config.guess configure.guess
        '';
        # Makefile needs this to compile static
        STATIC="TRUE";
        buildPhase = ''
          make lib
          make cdparanoia
        '';
        preInstallPhases = ["preInstallPhase"];
        preInstallPhase = ''
          sed -i '/so/d' Makefile
        '';
      });

      liburing = super.pkgsStatic.liburing.overrideDerivation (old: {
        configureFlags = "";
        ENABLE_SHARED = 0;
      });

      # p11-kit cannot be used as a static library
      # https://github.com/p11-glue/p11-kit/issues/355
      p11-kit = super.pkgsMusl.p11-kit;
      # gnutls depends on p11-kit
      gnutls = super.pkgsMusl.gnutls;

      pam = super.pkgsStatic.openpam;

      # support both static and shared
      libselinux = (super.pkgsMusl.libselinux.override {
        libsepol = super.pkgsStatic.libsepol;
      }).overrideAttrs (old: {
         makeFlags = old.makeFlags ++ [
           "LIBDIR=$(out)/lib"
         ];
      });

      glib = (super.pkgsStatic.glib.override {
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        pkg-config = pkgs.pkg-config;
        perl = pkgs.perl;
        python3 = pkgs.python3;
        gettext = pkgs.gettext;
        gtk-doc = pkgs.gtk-doc;
        docbook_xsl = pkgs.docbook_xsl;
        docbook_xml_dtd_45 = pkgs.docbook_xml_dtd_45;
        libxml2 = pkgs.libxml2;
      }).overrideAttrs (old: {
        outputs = super.lib.lists.remove "devdoc" old.outputs;
        buildInputs = old.buildInputs ++ [
          super.pkgsStatic.libsepol
        ];
        preBuild = ''
          sed -i "s/get_option('libmount')/get_option('libmount'), static: true/g" ../meson.build
          sed -i "s/get_option('selinux')/get_option('selinux'), static: true/g" ../meson.build
        '';
        # no devdoc from non-static glibc
        # ${pname} &amp; ${version} is correct due to lazy assignment
        postInstall = pkgs.glib.postInstall;
      });

      gtk3 = super.pkgsStatic.gtk3.override {
        trackerSupport = false;
        cupsSupport = false;
        withGtkDoc = false;

        # nativeBuildInputs
        inherit (pkgs) gettext gobject-introspection makeWrapper meson ninja
        pkg-config python3 sassc docbook_xml_dtd_43 docbook-xsl-nons gtk-doc libxml2;
      };

      qemu = ((super.pkgsStatic.qemu.override {
        alsaSupport = false;
        spiceSupport = false;
        sdlSupport = false;
        smartcardSupport = false;
        gtkSupport = false;
        pulseSupport = false;

        # nativeBuildInputs
        makeWrapper = pkgs.makeWrapper;
        python = pkgs.python3;
        pkg-config = pkgs.pkg-config;
        flex = pkgs.flex;
        bison = pkgs.bison;
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        perl = pkgs.perl;
      }).overrideAttrs (old: {
        nativeBuildInputs = old.nativeBuildInputs ++ [
          pkgs.binutils
          # perl as nativeBuildInputs has been added in nixpkgs master
          # while it is backported to nixpkgs 21.11 (nixos 21.11).
          # If without perl as nativeBuildInputs,
          # ./scripts/shaderinclude.pl can not be patchShebangs'ed.
          pkgs.perl # without it cannot patchShebangs
        ];
        # qemu-6.1.1 has contained sigrtminmax patch, can not be patched again
        patches = builtins.filter (
          x: ! super.lib.hasSuffix "sigrtminmax.patch" x
        ) old.patches;
      })).overrideDerivation (old: let
        # qemu configure uses "--static" instead of standard "--disable-shared" and "--enable-static"
        configureFlags_no_DS = super.lib.lists.remove "--disable-shared" old.configureFlags;
        configureFlags_no_DS_no_ES = super.lib.lists.remove "--enable-static" configureFlags_no_DS;
      in {
        configureFlags = configureFlags_no_DS_no_ES ++ [
          "--static"
          # "--target-list-exclude="
          "--target-list=x86_64-softmmu"
        ];
      });

      qemu31 = (((super.callPackage (
        pinnedPkgsForQemu31Src + "/pkgs/applications/virtualization/qemu/default.nix"
      ) {
        inherit (super.darwin.apple_sdk.frameworks) CoreServices Cocoa Hypervisor;
        inherit (super.darwin.stubs) rez setfile;
      }).override {
        # In nixpkgs 20.03, stdenv contains lib attr.
        stdenv = pkgs.pkgsStatic.stdenv // {lib = super.lib;};
        alsaLib = null;
        spiceSupport = false;
        sdlSupport = false;
        smartcardSupport = false;
        gtkSupport = false;
        pulseSupport = false;

        # nativeBuildInputs
        makeWrapper = pkgs.makeWrapper;
        python2 = pkgs.python2;
        pkgconfig = pkgs.pkgconfig;
        flex = pkgs.flex;
        bison = pkgs.bison;
        perl = pkgs.perl;
      }).overrideAttrs (old: {
        nativeBuildInputs = old.nativeBuildInputs ++ [
          # Several issues report ld version &gt;= 2.34 will failed due to
          # PHDR segment not covered by LOAD segment.
          # https://github.com/OpenOrbis/OpenOrbis-PS4-Toolchain/issues/122
          # https://github.com/genodelabs/genode/issues/4003
          # So I downgrade ld version &lt; 2.34.
          # I still do not figure out why the same version ld in
          # qemu 6.1.1 static works correctly?
          pkgsForQemu31.binutils
        ];
      })).overrideDerivation (old: let
        # drop audio configure flag
        configureFlags_no_audio = builtins.filter (
          x: ! super.lib.hasPrefix "--audio-drv-list" x
        ) old.configureFlags;
        # qemu configure uses "--static" instead of standard "--disable-shared" and "--enable-static"
        configureFlags_no_DS = super.lib.lists.remove "--disable-shared" configureFlags_no_audio;
        configureFlags_no_DS_no_ES = super.lib.lists.remove "--enable-static" configureFlags_no_DS;
      in {
        configureFlags = configureFlags_no_DS_no_ES ++ [
          # "--static"
          # "--target-list-exclude="
          "--target-list=x86_64-softmmu"
          "--disable-gnutls"
          "--disable-tools"
        ];
        makeFlags = [
          # "V=1" # qemu Makefile verbose
          # It is neccessary to use ld in binutils, otherwise pc-bios build will fail.
          # In qemu 6.1.1 static, it is using ld in binutils, instead of ld from musl-gcc
          "AR=${pkgs.binutils-unwrapped}/bin/ar"
          "AS=${pkgs.binutils}/bin/as"
          "LD=${pkgs.binutils}/bin/ld"
          "NIX_BINTOOLS=${pkgs.binutils}"
        ];
      });
    })];

  };
in
{
  inherit (mypkgs.pkgsStatic) qemu qemu31;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
# xieby1: 2022.05.24
# build static qemu (current version 6.1.1) into ./result/
# $ nix-build &lt;this-file&gt; -A qemu
# build static qemu-3.1.0 into ./result/
# $ nix-build &lt;this-file&gt; -A qemu31
# build and install static qemu
# $ nix-env -i -f &lt;this-file&gt; -A qemu
# build and install static qemu-3.1.0
# $ nix-env -i -f &lt;this-file&gt; -A qemu31
let
  pinnedPkgsSrc = builtins.fetchTarball {
    name = "nixos-static-qemu";
    url = "https://github.com/nixos/nixpkgs/archive/e7d63bd0d50df412f5a1d8acfa3caae75522e347.tar.gz";
    sha256 = "132pc4f9ixisyv4117p2jirmlyl6sd76bfaz33rhlcwakg7bhjm7";
  };
  # pkgs = import pinnedPkgsSrc {};
  # mypkgs = import pinnedPkgsSrc {
  pkgs = import &lt;nixpkgs&gt; {};
  mypkgs = import &lt;nixpkgs&gt; {
    overlays = [(self: super: {

      cdparanoiaIII = super.pkgsStatic.cdparanoiaIII.overrideAttrs (old: {
        preConfigure = old.preConfigure + ''
          cp ${super.gnu-config}/config.sub configure.sub
          cp ${super.gnu-config}/config.guess configure.guess
        '';
        # Makefile needs this to compile static
        STATIC="TRUE";
        buildPhase = ''
          make lib
          make cdparanoia
        '';
        preInstallPhases = ["preInstallPhase"];
        preInstallPhase = ''
          sed -i '/so/d' Makefile
        '';
      });

      liburing = super.pkgsStatic.liburing.overrideDerivation (old: {
        configureFlags = "";
        ENABLE_SHARED = 0;
      });

      # p11-kit cannot be used as a static library
      # https://github.com/p11-glue/p11-kit/issues/355
      p11-kit = super.pkgsMusl.p11-kit;
      # gnutls depends on p11-kit
      gnutls = super.pkgsMusl.gnutls;

      pam = super.pkgsStatic.openpam;

      # support both static and shared
      libselinux = (super.pkgsMusl.libselinux.override {
        libsepol = super.pkgsStatic.libsepol;
      }).overrideAttrs (old: {
         makeFlags = old.makeFlags ++ [
           "LIBDIR=$(out)/lib"
         ];
      });

      glib = (super.pkgsStatic.glib.override {
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        pkg-config = pkgs.pkg-config;
        perl = pkgs.perl;
        python3 = pkgs.python3;
        gettext = pkgs.gettext;
        gtk-doc = pkgs.gtk-doc;
        docbook_xsl = pkgs.docbook_xsl;
        docbook_xml_dtd_45 = pkgs.docbook_xml_dtd_45;
        libxml2 = pkgs.libxml2;
      }).overrideAttrs (old: {
        outputs = super.lib.lists.remove "devdoc" old.outputs;
        buildInputs = old.buildInputs ++ [
          super.pkgsStatic.libsepol
        ];
        preBuild = ''
          sed -i "s/get_option('libmount')/get_option('libmount'), static: true/g" ../meson.build
          sed -i "s/get_option('selinux')/get_option('selinux'), static: true/g" ../meson.build
        '';
        # no devdoc from non-static glibc
        # ${pname} &amp; ${version} is correct due to lazy assignment
        postInstall = pkgs.glib.postInstall;
      });

      gtk3 = super.pkgsStatic.gtk3.override {
        trackerSupport = false;
        cupsSupport = false;
        withGtkDoc = false;

        # nativeBuildInputs
        inherit (pkgs) gettext gobject-introspection makeWrapper meson ninja
        pkg-config python3 sassc docbook_xml_dtd_43 docbook-xsl-nons gtk-doc libxml2;
      };

      qemu = ((super.pkgsStatic.qemu.override {
        alsaSupport = false;
        spiceSupport = false;
        sdlSupport = false;
        smartcardSupport = false;
        gtkSupport = false;
        pulseSupport = false;

        # nativeBuildInputs
        makeWrapper = pkgs.makeWrapper;
        python = pkgs.python3;
        pkg-config = pkgs.pkg-config;
        flex = pkgs.flex;
        bison = pkgs.bison;
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        perl = pkgs.perl;
      }).overrideAttrs (old: {
        nativeBuildInputs = old.nativeBuildInputs ++ [
          pkgs.binutils
          # perl as nativeBuildInputs has been added in nixpkgs master
          # while it is backported to nixpkgs 21.11 (nixos 21.11).
          # If without perl as nativeBuildInputs,
          # ./scripts/shaderinclude.pl can not be patchShebangs'ed.
          pkgs.perl # without it cannot patchShebangs
        ];
        # qemu-6.1.1 has contained sigrtminmax patch, can not be patched again
        patches = builtins.filter (
          x: ! super.lib.hasSuffix "sigrtminmax.patch" x
        ) old.patches;
      })).overrideDerivation (old: let
        # qemu configure uses "--static" instead of standard "--disable-shared" and "--enable-static"
        configureFlags_no_DS = super.lib.lists.remove "--disable-shared" old.configureFlags;
        configureFlags_no_DS_no_ES = super.lib.lists.remove "--enable-static" configureFlags_no_DS;
      in {
        configureFlags = configureFlags_no_DS_no_ES ++ [
          "--static"
          # "--target-list-exclude="
          "--target-list=x86_64-softmmu"
        ];
      });
    })];
  };
in
{
  inherit (mypkgs.pkgsStatic.pkgsCross.riscv64) qemu;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
# xieby1: 2022.05.24
# build static qemu (current version 6.1.1) into ./result/
# $ nix-build &lt;this-file&gt; -A qemu
# build static qemu-3.1.0 into ./result/
# $ nix-build &lt;this-file&gt; -A qemu31
# build and install static qemu
# $ nix-env -i -f &lt;this-file&gt; -A qemu
# build and install static qemu-3.1.0
# $ nix-env -i -f &lt;this-file&gt; -A qemu31
let
  pinnedPkgsSrc = builtins.fetchTarball {
    name = "nixos-static-qemu";
    url = "https://github.com/nixos/nixpkgs/archive/e7d63bd0d50df412f5a1d8acfa3caae75522e347.tar.gz";
    sha256 = "132pc4f9ixisyv4117p2jirmlyl6sd76bfaz33rhlcwakg7bhjm7";
  };
  # pkgs = import pinnedPkgsSrc {};
  # mypkgs = import pinnedPkgsSrc {
  pkgs = import &lt;nixpkgs&gt; {};
  mypkgs = import &lt;nixpkgs&gt; {
    overlays = [(self: super: {

      cdparanoiaIII = super.pkgsStatic.cdparanoiaIII.overrideAttrs (old: {
        preConfigure = old.preConfigure + ''
          cp ${super.gnu-config}/config.sub configure.sub
          cp ${super.gnu-config}/config.guess configure.guess
        '';
        # Makefile needs this to compile static
        STATIC="TRUE";
        buildPhase = ''
          make lib
          make cdparanoia
        '';
        preInstallPhases = ["preInstallPhase"];
        preInstallPhase = ''
          sed -i '/so/d' Makefile
        '';
      });

      liburing = super.pkgsStatic.liburing.overrideDerivation (old: {
        configureFlags = "";
        ENABLE_SHARED = 0;
      });

      # p11-kit cannot be used as a static library
      # https://github.com/p11-glue/p11-kit/issues/355
      p11-kit = super.pkgsMusl.p11-kit;
      # gnutls depends on p11-kit
      gnutls = super.pkgsMusl.gnutls;

      pam = super.pkgsStatic.openpam;

      # support both static and shared
      libselinux = (super.pkgsMusl.libselinux.override {
        libsepol = super.pkgsStatic.libsepol;
      }).overrideAttrs (old: {
         makeFlags = old.makeFlags ++ [
           "LIBDIR=$(out)/lib"
         ];
      });

      glib = (super.pkgsStatic.glib.override {
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        pkg-config = pkgs.pkg-config;
        perl = pkgs.perl;
        python3 = pkgs.python3;
        gettext = pkgs.gettext;
        gtk-doc = pkgs.gtk-doc;
        docbook_xsl = pkgs.docbook_xsl;
        docbook_xml_dtd_45 = pkgs.docbook_xml_dtd_45;
        libxml2 = pkgs.libxml2;
      }).overrideAttrs (old: {
        outputs = super.lib.lists.remove "devdoc" old.outputs;
        buildInputs = old.buildInputs ++ [
          super.pkgsStatic.libsepol
        ];
        preBuild = ''
          sed -i "s/get_option('libmount')/get_option('libmount'), static: true/g" ../meson.build
          sed -i "s/get_option('selinux')/get_option('selinux'), static: true/g" ../meson.build
        '';
        # no devdoc from non-static glibc
        # ${pname} &amp; ${version} is correct due to lazy assignment
        postInstall = pkgs.glib.postInstall;
      });

      gtk3 = super.pkgsStatic.gtk3.override {
        trackerSupport = false;
        cupsSupport = false;
        withGtkDoc = false;

        # nativeBuildInputs
        inherit (pkgs) gettext gobject-introspection makeWrapper meson ninja
        pkg-config python3 sassc docbook_xml_dtd_43 docbook-xsl-nons gtk-doc libxml2;
      };

      qemu = ((super.pkgsStatic.qemu.override {
        alsaSupport = false;
        spiceSupport = false;
        sdlSupport = false;
        smartcardSupport = false;
        gtkSupport = false;
        pulseSupport = false;

        # nativeBuildInputs
        makeWrapper = pkgs.makeWrapper;
        python = pkgs.python3;
        pkg-config = pkgs.pkg-config;
        flex = pkgs.flex;
        bison = pkgs.bison;
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        perl = pkgs.perl;
      }).overrideAttrs (old: {
        nativeBuildInputs = old.nativeBuildInputs ++ [
          pkgs.binutils
          # perl as nativeBuildInputs has been added in nixpkgs master
          # while it is backported to nixpkgs 21.11 (nixos 21.11).
          # If without perl as nativeBuildInputs,
          # ./scripts/shaderinclude.pl can not be patchShebangs'ed.
          pkgs.perl # without it cannot patchShebangs
        ];
        # qemu-6.1.1 has contained sigrtminmax patch, can not be patched again
        patches = builtins.filter (
          x: ! super.lib.hasSuffix "sigrtminmax.patch" x
        ) old.patches;
      })).overrideDerivation (old: let
        # qemu configure uses "--static" instead of standard "--disable-shared" and "--enable-static"
        configureFlags_no_DS = super.lib.lists.remove "--disable-shared" old.configureFlags;
        configureFlags_no_DS_no_ES = super.lib.lists.remove "--enable-static" configureFlags_no_DS;
      in {
        configureFlags = configureFlags_no_DS_no_ES ++ [
          "--static"
          # "--target-list-exclude="
          "--target-list=x86_64-softmmu"
        ];
      });
    })];
  };
in
{
  inherit (mypkgs.pkgsStatic.pkgsCross.riscv64) qemu;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
# xieby1: 2022.05.24
# build static qemu (current version 6.1.1) into ./result/
# $ nix-build &lt;this-file&gt; -A qemu
# build static qemu-3.1.0 into ./result/
# $ nix-build &lt;this-file&gt; -A qemu31
# build and install static qemu
# $ nix-env -i -f &lt;this-file&gt; -A qemu
# build and install static qemu-3.1.0
# $ nix-env -i -f &lt;this-file&gt; -A qemu31
let
  # https://lazamar.co.uk/nix-versions
  pinnedPkgsForQemu31Src = builtins.fetchTarball {
    name = "nixos-20.03-with-qemu-3.1.0";
    url = "https://github.com/NixOS/nixpkgs/archive/81d4e65891f92e8e72c244da663c83c1e40dc919.tar.gz";
    sha256 = "0dk1k1zqy2bnp9gsy9mdxk0idkazyvnmqrj2jpbwzfnhjzpmzq1w";
  };
  pinnedPkgsSrc = builtins.fetchTarball {
    name = "nixos-static-qemu";
    url = "https://github.com/nixos/nixpkgs/archive/e7d63bd0d50df412f5a1d8acfa3caae75522e347.tar.gz";
    sha256 = "132pc4f9ixisyv4117p2jirmlyl6sd76bfaz33rhlcwakg7bhjm7";
  };
  pkgsForQemu31 = import pinnedPkgsForQemu31Src {};
  pkgs = import pinnedPkgsSrc {};
  mypkgs = import pinnedPkgsSrc {
    overlays = [(self: super: {

      cdparanoiaIII = super.pkgsStatic.cdparanoiaIII.overrideAttrs (old: {
        preConfigure = old.preConfigure + ''
          cp ${super.gnu-config}/config.sub configure.sub
          cp ${super.gnu-config}/config.guess configure.guess
        '';
        # Makefile needs this to compile static
        STATIC="TRUE";
        buildPhase = ''
          make lib
          make cdparanoia
        '';
        preInstallPhases = ["preInstallPhase"];
        preInstallPhase = ''
          sed -i '/so/d' Makefile
        '';
      });

      liburing = super.pkgsStatic.liburing.overrideDerivation (old: {
        configureFlags = "";
        ENABLE_SHARED = 0;
      });

      # p11-kit cannot be used as a static library
      # https://github.com/p11-glue/p11-kit/issues/355
      p11-kit = super.pkgsMusl.p11-kit;
      # gnutls depends on p11-kit
      gnutls = super.pkgsMusl.gnutls;

      pam = super.pkgsStatic.openpam;

      # support both static and shared
      libselinux = (super.pkgsMusl.libselinux.override {
        libsepol = super.pkgsStatic.libsepol;
      }).overrideAttrs (old: {
         makeFlags = old.makeFlags ++ [
           "LIBDIR=$(out)/lib"
         ];
      });

      glib = (super.pkgsStatic.glib.override {
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        pkg-config = pkgs.pkg-config;
        perl = pkgs.perl;
        python3 = pkgs.python3;
        gettext = pkgs.gettext;
        gtk-doc = pkgs.gtk-doc;
        docbook_xsl = pkgs.docbook_xsl;
        docbook_xml_dtd_45 = pkgs.docbook_xml_dtd_45;
        libxml2 = pkgs.libxml2;
      }).overrideAttrs (old: {
        outputs = super.lib.lists.remove "devdoc" old.outputs;
        buildInputs = old.buildInputs ++ [
          super.pkgsStatic.libsepol
        ];
        preBuild = ''
          sed -i "s/get_option('libmount')/get_option('libmount'), static: true/g" ../meson.build
          sed -i "s/get_option('selinux')/get_option('selinux'), static: true/g" ../meson.build
        '';
        # no devdoc from non-static glibc
        # ${pname} &amp; ${version} is correct due to lazy assignment
        postInstall = pkgs.glib.postInstall;
      });

      gtk3 = super.pkgsStatic.gtk3.override {
        trackerSupport = false;
        cupsSupport = false;
        withGtkDoc = false;

        # nativeBuildInputs
        inherit (pkgs) gettext gobject-introspection makeWrapper meson ninja
        pkg-config python3 sassc docbook_xml_dtd_43 docbook-xsl-nons gtk-doc libxml2;
      };

      qemu = ((super.pkgsStatic.qemu.override {
        alsaSupport = false;
        spiceSupport = false;
        sdlSupport = false;
        smartcardSupport = false;
        gtkSupport = false;
        pulseSupport = false;

        # nativeBuildInputs
        makeWrapper = pkgs.makeWrapper;
        python = pkgs.python3;
        pkg-config = pkgs.pkg-config;
        flex = pkgs.flex;
        bison = pkgs.bison;
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        perl = pkgs.perl;
      }).overrideAttrs (old: {
        nativeBuildInputs = old.nativeBuildInputs ++ [
          pkgs.binutils
          # perl as nativeBuildInputs has been added in nixpkgs master
          # while it is backported to nixpkgs 21.11 (nixos 21.11).
          # If without perl as nativeBuildInputs,
          # ./scripts/shaderinclude.pl can not be patchShebangs'ed.
          pkgs.perl # without it cannot patchShebangs
        ];
        # qemu-6.1.1 has contained sigrtminmax patch, can not be patched again
        patches = builtins.filter (
          x: ! super.lib.hasSuffix "sigrtminmax.patch" x
        ) old.patches;
      })).overrideDerivation (old: let
        # qemu configure uses "--static" instead of standard "--disable-shared" and "--enable-static"
        configureFlags_no_DS = super.lib.lists.remove "--disable-shared" old.configureFlags;
        configureFlags_no_DS_no_ES = super.lib.lists.remove "--enable-static" configureFlags_no_DS;
      in {
        configureFlags = configureFlags_no_DS_no_ES ++ [
          "--static"
          # "--target-list-exclude="
          "--target-list=x86_64-softmmu"
        ];
      });

      qemu31 = (((super.callPackage (
        pinnedPkgsForQemu31Src + "/pkgs/applications/virtualization/qemu/default.nix"
      ) {
        inherit (super.darwin.apple_sdk.frameworks) CoreServices Cocoa Hypervisor;
        inherit (super.darwin.stubs) rez setfile;
      }).override {
        # In nixpkgs 20.03, stdenv contains lib attr.
        stdenv = pkgs.pkgsStatic.stdenv // {lib = super.lib;};
        alsaLib = null;
        spiceSupport = false;
        sdlSupport = false;
        smartcardSupport = false;
        gtkSupport = false;
        pulseSupport = false;

        # nativeBuildInputs
        makeWrapper = pkgs.makeWrapper;
        python2 = pkgs.python2;
        pkgconfig = pkgs.pkgconfig;
        flex = pkgs.flex;
        bison = pkgs.bison;
        perl = pkgs.perl;
      }).overrideAttrs (old: {
        nativeBuildInputs = old.nativeBuildInputs ++ [
          # Several issues report ld version &gt;= 2.34 will failed due to
          # PHDR segment not covered by LOAD segment.
          # https://github.com/OpenOrbis/OpenOrbis-PS4-Toolchain/issues/122
          # https://github.com/genodelabs/genode/issues/4003
          # So I downgrade ld version &lt; 2.34.
          # I still do not figure out why the same version ld in
          # qemu 6.1.1 static works correctly?
          pkgsForQemu31.binutils
        ];
      })).overrideDerivation (old: let
        # drop audio configure flag
        configureFlags_no_audio = builtins.filter (
          x: ! super.lib.hasPrefix "--audio-drv-list" x
        ) old.configureFlags;
        # qemu configure uses "--static" instead of standard "--disable-shared" and "--enable-static"
        configureFlags_no_DS = super.lib.lists.remove "--disable-shared" configureFlags_no_audio;
        configureFlags_no_DS_no_ES = super.lib.lists.remove "--enable-static" configureFlags_no_DS;
      in {
        configureFlags = configureFlags_no_DS_no_ES ++ [
          # "--static"
          # "--target-list-exclude="
          "--target-list=x86_64-softmmu"
          "--disable-gnutls"
          "--disable-tools"
        ];
        makeFlags = [
          # "V=1" # qemu Makefile verbose
          # It is neccessary to use ld in binutils, otherwise pc-bios build will fail.
          # In qemu 6.1.1 static, it is using ld in binutils, instead of ld from musl-gcc
          "AR=${pkgs.binutils-unwrapped}/bin/ar"
          "AS=${pkgs.binutils}/bin/as"
          "LD=${pkgs.binutils}/bin/ld"
          "NIX_BINTOOLS=${pkgs.binutils}"
        ];
      });
    })];

  };
in
{
  inherit (mypkgs.pkgsStatic) qemu qemu31;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
# TODO
# Ref: ~/Documents/Tech/BT/QEMU/test.md
let
  pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.stdenv.mkDerivation {
  buildInputs = with pkgs; [
    # configure needs
    ninja
    pkg-config
    glib
    # make needs
    glibc.static # TODO: this will cause configure failed
  ];
  buildFlags = [
    "CFLAGS=-O" # override CFLAGS
    "build-tcg-tests-x86_64-linux-user"
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># build by version
# nix-build pkgs_qemu.nix -A v1_0
# build by date
# nix-build pkgs_qemu.nix -A d2011_12_01
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  pname = "qemu";
in rec {
  v1_0 = let
    version = "1.0";
  in pkgs.gcc49Stdenv.mkDerivation {
    inherit pname version;
    src = pkgs.fetchurl {
      url = "https://download.qemu.org/qemu-${version}.tar.xz";
      sha256 = "0y1018xia238pcqb7ad9v299b478c0838fiayl6qkzyd95gk0xbb";
    };
    buildInputs = with pkgs; [
      zlib
      pkg-config
      glib
      python2
    ];
    patches = [
      ./qemu-v1.0.patch
    ];
    configureFlags = [
      "--target-list=x86_64-linux-user"
      "--disable-docs"
    ];
  };
  d2011_12_01 = v1_0;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># https://github.com/NixOS/nixpkgs/issues/185773
{ lib, callPackage, fetchFromGitHub, fetchurl, openssl_1_1 }:

((callPackage (import (fetchFromGitHub {
  owner = "NixOS";
  repo = "nixpkgs";
  rev = "363ef08971726937cd6a63de0efef7f8ba657b18";
  sha256 = "sha256-QRKAn5yLMyohZKsK72Vkd6HQUh3t5tDpFyI/Y7T3ASg=";
}) { }).shellinabox.override) { openssl = openssl_1_1; }).overrideAttrs
({ patches, ... }: {
  patches = patches ++ [
    # OpenSSL 1.1
    (fetchurl {
      url =
        "https://github.com/shellinabox/shellinabox/commit/c32f3d365a0848eb6b3350ec521fcd4d1d098295.patch";
      hash = "sha256-Q8otJUip1YQJb0ZSF89BjSvrCh4PQe4R7Rb7mtm33tk=";
    })
  ];
})
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>See all fhs-shell scripts on [Github repo: scripts/shell]({{ site.repo_url }}/scripts/shell)</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
  ccache_dir = toString ./. + "/.ccache";
  ccache14Stdenv = pkgs.ccacheStdenv.override {
    stdenv = pkgs.gcc14Stdenv;
    extraConfig = ''
      export CCACHE_COMPRESS=1
      export CCACHE_DIR="${ccache_dir}"
      export CCACHE_UMASK=007
      if [ ! -d "$CCACHE_DIR" ]; then
        echo "====="
        echo "Directory '$CCACHE_DIR' does not exist"
        echo "Please create it with:"
        echo "  mkdir -m0770 '$CCACHE_DIR'"
        echo "====="
        exit 1
      fi
      if [ ! -w "$CCACHE_DIR" ]; then
        echo "====="
        echo "Directory '$CCACHE_DIR' is not accessible for user $(whoami)"
        echo "Please verify its access permissions"
        echo "====="
        exit 1
      fi
    '';
  };
  ccacheMkShell = pkgs.mkShell.override {
    stdenv = ccache14Stdenv;
  };
in ccacheMkShell {
  name = "ccache-shell";
  shellHook = ''
    mkdir -m0770 -p ${ccache_dir}
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  name = "chipyard";
  pkgs = import &lt;nixpkgs&gt; {};
  pkgsCirct1_30_0 = import (builtins.fetchTarball {
      url = "https://github.com/NixOS/nixpkgs/archive/0aca8f43c8dba4a77aa0c16fb0130237c3da514c.tar.gz";
  }) {};

  # currently latest spike
  my-spike = pkgs.spike.overrideAttrs (old: {
    version = "1.1.1-dev";
    src = pkgs.fetchFromGitHub {
      owner = "riscv";
      repo = "riscv-isa-sim";
      rev = "4f916978cd17bd2e83cfca233d0fa40153fda5f4";
      sha256 = "sha256-84YY9YMIa4YO5mVJ0gGMOWnD2/CnpEjIbB9EjA5+Glc=";
    };
  });

  h_content = builtins.toFile "h_content" ''
    # ${pkgs.lib.toUpper "${name} usage tips"}

    The conda cannot gracefully manage the dependencies, e.g. gcc's dynamic libraries.
    Instead, I replace conda with nix to manage the dependencies.

    * Show this help: `h`

    Init Repos

    * edit common.mk:1 `SHELL=bash`
    * `./scripts/init-submodules-no-riscv-tools-nolog.sh`

    Compiling Verilator

    * `make -C sims/verilator`

    Run Verilator

    * `./sims/verilator/simulator-chipyard.harness-RocketConfig &lt;RISCV Executable&gt;`
  '';
  _h_ = pkgs.writeShellScriptBin "h" ''
    ${pkgs.glow}/bin/glow ${h_content}
  '';
in pkgs.mkShell {
  inherit name;
  packages = with pkgs; [
    verilator
    dtc
    jq
    pkgsCirct1_30_0.circt
    my-spike

    _h_
  ];
  shellHook = ''
    export RISCV=${pkgs.pkgsCross.riscv64-embedded.stdenv.cc}

    h
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# xieby1: 2022.07.03
# let
#   pkgs = import &lt;nixpkgs&gt; {};
# in
# pkgs.mkShell {
#   buildInputs = [
#     pkgs.pkgsCross.mipsel-linux-gnu.stdenv.cc
#   ];
# }

# xieby1: 2022.05.16
let
  pkgs_mips_cross = import &lt;nixpkgs&gt; {
    crossSystem = "mips-linux";
  };
  pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.mkShell {
  buildInputs = (with pkgs_mips_cross; [
    buildPackages.gdb
    buildPackages.gcc
  ]) ++ (with pkgs; [
    qemu
  ]);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# xieby1: 2022.04.26

let
  pkgs_arm_cross = import &lt;nixpkgs&gt; {
    # get this config on my android
    #   nix repl
    #   builtins.currentSystem
    crossSystem = "aarch64-linux";
  };
  pkgs_arm_native = import &lt;nixpkgs&gt; {
    localSystem = "aarch64-linux";
    crossSystem = "aarch64-linux";
  };
  pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.mkShell {
  buildInputs = with pkgs_arm_cross; [
    # packages for cross compiling, run on local system (x86_64)
    stdenv.cc
    # here stdenv.cc is the same with buildPackages.gcc
  ] ++ (with pkgs_arm_native; [
    # packages run on aarch64
    figlet
  ]) ++ (with pkgs; [
    # packages run on local system (x86_64)
    qemu
  ]);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
{ system ? builtins.currentSystem }:
let
  src = fetchTarball {
    url = "https://github.com/numtide/devshell/archive/9fddc998b4522694caaf4056e93154d2c11752cd.tar.gz";
    sha256 = "0d7ra00843n4iyadhdxcr9m0vcn6fz54hfymms6nbdz0d2pjff06";
  };
  devshell = import src { inherit system; };
in
devshell.mkShell {
  commands = [{
    name = "hello";
    command = "echo hello";
    help = "print hello miao";
  }];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
let
  pkgs = import &lt;nixpkgs&gt; {};
in pkgs.mkShellNoCC {
  name = "gcc11";
  packages = with pkgs; [
    gcc11
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
with import &lt;nixpkgs&gt; {};
# You will get a shell with hello executable,
# and environment variable $name, $miao.
mkShell {
  packages = [
    hello
  ];
  name = "test-env";
  miao = "miao!";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
#2022.05.18
# pip install is usable in venv
# e.g.
# $ nix-shell &lt;this_file&gt;
# $ pip install [--user] graphviz2drawio
let
  pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.mkShell {
  propagatedBuildInputs = with pkgs.python3Packages; [
    pip
    venvShellHook
    ipython
    pygame
  ] ++ (with pkgs; [
  ]);
  venvDir = "pygame";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># https://nixos.wiki/wiki/Python
# Python virtual environment

# Execute this commands after entering fhs env
# python -m venv .venv
# source .venv/bin/activate

let
  pkgs = import &lt;nixpkgs&gt; {};
in (pkgs.buildFHSUserEnv {
  name = "venv";
  targetPkgs = p: (with p.python3Packages; [
    pip
    virtualenv
    ipython
  ]);
}).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
let
  mach-nix = import (builtins.fetchGit {
    url = "https://github.com/DavHau/mach-nix";
    ref = "refs/tags/3.4.0";
  }) {
    pkgs = import &lt;nixpkgs&gt; {};
  };
in
mach-nix.mkPythonShell {
  requirements = ''
    expmcc
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
#2022.05.18
# pip install is usable in venv
# e.g.
# $ nix-shell &lt;this_file&gt;
# $ pip install [--user] graphviz2drawio
let
  pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.mkShell {
  propagatedBuildInputs = with pkgs.python3Packages; [
    pip
    pygraphviz
    venvShellHook
    ipython
  ] ++ (with pkgs; [
    graphviz
  ]);
  venvDir = "venv";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# lxy's qemu plugins: http://172.17.103.58/lixinyu/qemu_plugins

let
  pkgs = import &lt;nixpkgs&gt; {};
in pkgs.mkShell {
  packages = with pkgs; [
    zlib.dev
    pkg-config
    glib.dev
  ];
  QEMU_DIR = "~/Codes/qemu";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# --pure: start a pure reproducible shell
# 2022.04.24
# Compile qemu/tests/tcg/x86_64/
# env CFLAGS=-O make -e build-tcg-tests-x86_64-linux-user
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  name = "nix";
in
pkgs.mkShell {
  inherit name;
  buildInputs = with pkgs; [
    glibc.static
  ];
  inputsFrom = with pkgs; [
    qemu
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  name = "riscv-tests";
  pkgs = import &lt;nixpkgs&gt; {};
  h_content = builtins.toFile "h_content" ''
    # ${pkgs.lib.toUpper "${name} compiling tips"}

    * `git submodule update --init --recursive`
    * `autoconf`
    * `./configure`
    * `make -j`
  '';
  _h_ = pkgs.writeShellScriptBin "h" ''
    ${pkgs.glow}/bin/glow ${h_content}
  '';
in pkgs.mkShell {
  inherit name;
  packages = with pkgs; [
    autoconf
    pkgsCross.riscv64-embedded.stdenv.cc

    _h_
  ];
  shellHook = ''
    export RISCV_PREFIX=${pkgs.pkgsCross.riscv64-embedded.stdenv.cc}/bin/riscv64-none-elf-
    h
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
with import &lt;nixpkgs&gt; {};
mkShell {
  packages = [
    dtc
    pkgsCross.riscv64-embedded.stdenv.cc
  ];
  name = "spike";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# --pure: start a pure reproducible shell
{ pkgs ? import &lt;nixpkgs&gt; {}
}:
pkgs.mkShell {
  name="dev-environment";
  buildInputs = with pkgs; [
    texlive.combined.scheme-full # HUGE SIZE!

    tmux
  ];
  shellHook = ''
    # install texlive permenant
    nix-env -q "texlive.*"
    if [[ ''$? -ne 0 ]]
    then
      nix-env -f '&lt;nixpkgs&gt;' -iA texlive.combined.scheme-full
    fi

    tmux
    exit
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
{pkgs ? import &lt;nixpkgs&gt; {}}:
let
  name = "ucasproposal";
  myTexlive = pkgs.texlive.combine {
    inherit (pkgs.texlive)
    scheme-basic

    xetex
    ctex
    checkcites

    # sty
    newtx
    xstring
    realscripts
    jknapltx
    mathalpha
    caption
    placeins
    enumitem
    listings
    algpseudocodex
    algorithms
    algorithmicx
    chemfig
    mhchem
    float

    # tex
    simplekv

    rsfs
    ;
  };
  myPython = pkgs.python3.withPackages (p: with p; [
    ipython
    matplotlib
    pandas
    numpy
    openpyxl
  ]);
in
pkgs.mkShell {
  inherit name;
  packages = with pkgs; [
    myTexlive
    myPython
    librsvg
  ];
  shellHook = ''
    # env
    export PYTHONPATH=${myPython}/${myPython.sitePackages}
    export debian_chroot=${name}
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
{ pkgsX86 ? import &lt;nixpkgs&gt; {
  localSystem.system="aarch64-linux";
  crossSystem="aarch64-linux";
} }:
pkgsX86.v8
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
#2022.05.18
# pip install is usable in venv
# e.g.
# $ nix-shell &lt;this_file&gt;
# $ pip install [--user] graphviz2drawio
let
  pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.mkShell {
  propagatedBuildInputs = with pkgs.python3Packages; [
    pip
    venvShellHook
    ipython
  ];
  venvDir = "${builtins.getEnv "HOME"}/.venv";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
let
  pkgs = import (builtins.fetchTarball {
    url = "https://github.com/NixOS/nixpkgs/archive/5e15d5da4abb74f0dd76967044735c70e94c5af1.tar.gz";
    sha256 = "0mk86mlxamjxhywdfp5asylqb39z7w18dcy8ds6qvl8gqjrijmq9";
  }) {
    system = "x86_64-linux";
  };
in pkgs.mkShell {
  name = "wine6";
  packages = with pkgs; [
    wine64
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  name = "xiangshan";
  pkgs = import &lt;nixpkgs&gt; {};
in pkgs.mkShell {
  inherit name;

  buildInputs = let
    h_content = builtins.toFile "h_content" ''
      # ${pkgs.lib.toUpper "${name} usage tips"}
    '';
    _h_ = pkgs.writeShellScriptBin "h" ''
      ${pkgs.glow}/bin/glow ${h_content}
    '';
    mill_0_11_8 = (import (pkgs.fetchFromGitHub {
      owner = "NixOS";
      repo = "nixpkgs";
      rev = "05bbf675397d5366259409139039af8077d695ce";
      sha256 = "1r26vjqmzgphfnby5lkfihz6i3y70hq84bpkwd43qjjvgxkcyki0";
    }){}).mill;
  in [
    _h_
    mill_0_11_8
  ] ++ (with pkgs; [
    espresso
    verilator

    # libs
    sqlite
    zlib
    zstd
  ]);

  shellHook = let
    circt_1_62_0 = (import (pkgs.fetchFromGitHub {
      owner = "NixOS";
      repo = "nixpkgs";
      rev = "771b079bb84ac2395f3a24a5663ac8d1495c98d3";
      sha256 = "0l1l9ms78xd41xg768pkb6xym200zpf4zjbv4kbqbj3z7rzvhpb7";
    }){}).circt;
  in ''
    h
    export CHISEL_FIRTOOL_PATH=${circt_1_62_0}/bin/
    export NOOP_HOME=$(realpath .)
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="shellnix"><a class="header" href="#shellnix">shell.nix</a></h1>
<p>这个shell.nix用于创建编译我的<a href="https://github.com/xieby1/nix_config">nix_config仓库</a>的
<a href="https://xieby1.github.io/nix_config/">GitHub Pages</a>的环境。
GitHub Pages的构建主要由<code>markcode</code>和<code>mdbook</code>这两个工具支持。</p>
<ul>
<li><a href="https://github.com/xieby1/markcode"><code>markcode</code></a>
是我为了方便在源文件里内嵌文档，写的一个小工具。
它能将源文件中带有特殊标记的注释抽取出，成为markdown文件。
nix_config仓库的几乎所有文档都内嵌在.nix文件中，
并都是通过<code>markcode</code>从.nix文件抽取出来。</li>
<li><a href="https://github.com/rust-lang/mdBook"><code>mdbook</code></a>
是一个非常纯粹且好用的静态网页生成框架，负责将markdown转换成网页。
因为第一次阅读<a href="https://nixos.org/manual/nix/stable/introduction.html">nix官方文档</a>时就喜欢上了这个文档框架，
所以我也采用的<code>mdbook</code>作为我的nix_config的文档框架。</li>
</ul>
<pre><code class="language-nix">let
  name = "nix_config";
  pkgs = import &lt;nixpkgs&gt; {};
  markcode = pkgs.callPackage (
    pkgs.fetchFromGitHub {
      owner = "xieby1";
      repo = "markcode";
      rev = "1c414aca28db7f2727f6da118f4e914743780ad0";
      hash = "sha256-B5kmpAIyUihlBqk7oNAdqBmdfCajCmleKBTgLyy0NqU=";
    }
  ) {};
in pkgs.mkShell {
  inherit name;
  buildInputs = with pkgs; [
    mdbook
    markcode
  ];
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>
            <script src="https://utteranc.es/client.js"
                    repo="xieby1/nix_config"
                    issue-term="pathname"
                    theme="github-light"
                    crossorigin="anonymous"
                    async>
            </script>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
